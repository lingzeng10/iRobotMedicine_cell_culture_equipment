# é–‹å•Ÿç¶²é 
_Exported on 2025/11/2 at 23:18:36 [GMT+8] from Cursor (1.7.54)_

---

**User**

é–‹å•Ÿç¶²é 

---

**Cursor**


æª¢æŸ¥å°ˆæ¡ˆè¨­å®šä»¥ç¢ºå®šå•Ÿå‹•æ–¹å¼ã€‚


ä½¿ç”¨æ ¹ç›®éŒ„çš„ `dev` è…³æœ¬åŒæ™‚å•Ÿå‹•å‰ç«¯ï¼ˆ3000ï¼‰èˆ‡å¾Œç«¯ï¼ˆ5000ï¼‰ã€‚


æ­£åœ¨å•Ÿå‹•å‰ç«¯èˆ‡å¾Œç«¯æœå‹™ã€‚

- å‰ç«¯ï¼ˆReactï¼‰ï¼š`http://localhost:3000`
- å¾Œç«¯ APIï¼š`http://localhost:5000`

å•Ÿå‹•å¾Œï¼Œç€è¦½å™¨é€šå¸¸æœƒè‡ªå‹•æ‰“é–‹å‰ç«¯é é¢ã€‚è‹¥æ²’æœ‰è‡ªå‹•æ‰“é–‹ï¼Œè«‹æ‰‹å‹•åœ¨ç€è¦½å™¨è¨ªå• `http://localhost:3000`ã€‚

æœå‹™æ­£åœ¨èƒŒæ™¯åŸ·è¡Œã€‚å¦‚éœ€åœæ­¢ï¼Œå‘Šè¨´æˆ‘å³å¯ã€‚

---

**User**

å…©å€‹ç¶²é éƒ½æ‰“ä¸é–‹

---

**Cursor**


éŒ¯èª¤æ˜¯å› ç‚ºåœ¨éŒ¯èª¤çš„ç›®éŒ„åŸ·è¡Œã€‚åˆ‡æ›åˆ°å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼Œæª¢æŸ¥ä¸¦å•Ÿå‹•æœå‹™ã€‚


æª¢æŸ¥æœå‹™æ˜¯å¦æ­£ç¢ºå•Ÿå‹•ï¼Œä¸¦ç¢ºèªç«¯å£é…ç½®ï¼š


PowerShell ä¸æ”¯æ´ `&&`ã€‚æ”¹ç‚ºåˆ†åˆ¥å•Ÿå‹•å‰å¾Œç«¯æœå‹™ï¼š


æª¢æŸ¥ä¾è³´æ˜¯å¦å·²å®‰è£ï¼Œç„¶å¾Œå•Ÿå‹•æœå‹™ï¼š


å…ˆå•Ÿå‹•å¾Œç«¯æœå‹™ï¼Œå†å•Ÿå‹•å‰ç«¯æœå‹™ï¼š


ç­‰å¾…æœå‹™å•Ÿå‹•ï¼Œç„¶å¾Œæª¢æŸ¥ç‹€æ…‹ï¼š


å…©å€‹æœå‹™å·²å•Ÿå‹•ï¼š
- å¾Œç«¯æœå‹™ï¼š5000 ç«¯å£
- å‰ç«¯æœå‹™ï¼š3000 ç«¯å£

æ­£åœ¨é–‹å•Ÿç€è¦½å™¨ï¼š


å·²é–‹å•Ÿç€è¦½å™¨ä¸¦å•Ÿå‹•æœå‹™ã€‚

**æœå‹™ç‹€æ…‹ï¼š**
- **å‰ç«¯æœå‹™**ï¼ˆReactï¼‰ï¼šé‹è¡Œåœ¨ `http://localhost:3000`
- **å¾Œç«¯æœå‹™**ï¼ˆExpress APIï¼‰ï¼šé‹è¡Œåœ¨ `http://localhost:5000`

ç€è¦½å™¨æ‡‰å·²è‡ªå‹•æ‰“é–‹å‰ç«¯é é¢ã€‚å¦‚æœæ²’æœ‰ï¼Œè«‹æ‰‹å‹•è¨ªå•ï¼š
- **å‰ç«¯ç¶²é **ï¼šhttp://localhost:3000
- **å¾Œç«¯å¥åº·æª¢æŸ¥**ï¼šhttp://localhost:5000/health

å…©å€‹æœå‹™éƒ½åœ¨èƒŒæ™¯é‹è¡Œä¸­ã€‚å¦‚éœ€åœæ­¢æœå‹™ï¼Œå‘Šè¨´æˆ‘å³å¯ã€‚

---

**User**

ç‚ºä»€éº¼å¾Œç«¯æ‰¾ä¸åˆ°æœå‹™?

---

**Cursor**


å¾Œç«¯æ­£å¸¸é‹è¡Œï¼Œä½†ç›´æ¥è¨ªå•æ ¹è·¯å¾‘ `/` æœƒè¿”å› 404ï¼Œå› ç‚ºå¾Œç«¯æ˜¯ API æœå‹™ï¼Œæ²’æœ‰å‰ç«¯é é¢ã€‚æª¢æŸ¥å¯ç”¨çš„ç«¯é»ï¼š


å¾Œç«¯æ­£å¸¸é‹è¡Œï¼Œä½†åªæä¾› APIï¼Œæ²’æœ‰å‰ç«¯é é¢ã€‚ç›´æ¥è¨ªå• `http://localhost:5000` æœƒè§¸ç™¼ 404ã€‚

å¯ç”¨çš„ç«¯é»ï¼š
- å¥åº·æª¢æŸ¥ï¼š`http://localhost:5000/health`
- API ç«¯é»ï¼š`http://localhost:5000/api/*`

å‰ç«¯ç¶²é æ‡‰è¨ªå•ï¼š`http://localhost:3000`

ç‚ºå¾Œç«¯æ·»åŠ ä¸€å€‹æ ¹è·¯å¾‘æ­¡è¿é ï¼Œæ–¹ä¾¿æ¸¬è©¦ï¼š


```javascript
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
require('dotenv').config();

// å¼•å…¥è·¯ç”±
const ticketRoutes = require('./routes/tickets');
const targetRoutes = require('./routes/targets');
const scheduleRoutes = require('./routes/schedules');
const photoRoutes = require('./routes/photos');
const versionRoutes = require('./routes/version');

// å»ºç«‹ Express æ‡‰ç”¨ç¨‹å¼
const app = express();
const PORT = process.env.PORT || 5000;

// ä¸­ä»‹è»Ÿé«”è¨­å®š
app.use(helmet()); // å®‰å…¨æ€§ä¸­ä»‹è»Ÿé«”
app.use(cors({
  origin: true, // å…è¨±æ‰€æœ‰ä¾†æºï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
  credentials: true
})); // è·¨åŸŸè«‹æ±‚è¨­å®š
app.use(morgan('combined')); // è«‹æ±‚æ—¥èªŒ
app.use(express.json({ limit: '10mb' })); // JSON è§£æï¼Œæ”¯æ´ UTF-8
app.use(express.urlencoded({ extended: true, limit: '10mb' })); // URL ç·¨ç¢¼è§£æï¼Œæ”¯æ´ UTF-8

// æ ¹è·¯å¾‘æ­¡è¿é é¢
app.get('/', (req, res) => {
  res.json({
    success: true,
    message: 'å·¥å–®ç®¡ç†ç³»çµ±å¾Œç«¯ API æœå‹™',
    version: '1.0.0',
    endpoints: {
      health: '/health',
      tickets: '/api/tickets',
      targets: '/api/targets',
      schedules: '/api/schedules',
      photos: '/api/photos',
      version: '/api/version'
    },
    timestamp: new Date().toISOString()
  });
});

// å¥åº·æª¢æŸ¥ç«¯é»
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: 'å·¥å–®ç®¡ç†ç³»çµ±å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ',
    timestamp: new Date().toISOString()
  });
});

// API è·¯ç”±
app.use('/api/tickets', ticketRoutes);
app.use('/api/targets', targetRoutes);
app.use('/api/schedules', scheduleRoutes);
app.use('/api/photos', photoRoutes);
app.use('/api/version', versionRoutes);

// 404 è™•ç†
app.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    message: 'æ‰¾ä¸åˆ°è«‹æ±‚çš„è³‡æº'
  });
});

// å…¨åŸŸéŒ¯èª¤è™•ç†
app.use((err, req, res, next) => {
  console.error('ä¼ºæœå™¨éŒ¯èª¤:', err);
  res.status(500).json({
    success: false,
    message: 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤',
    error: process.env.NODE_ENV === 'development' ? err.message : 'è«‹ç¨å¾Œå†è©¦'
  });
});

// å•Ÿå‹•ä¼ºæœå™¨
app.listen(PORT, '0.0.0.0', () => {
  console.log(`ğŸš€ å·¥å–®ç®¡ç†ç³»çµ±å¾Œç«¯æœå‹™å·²å•Ÿå‹•`);
  console.log(`ğŸ“ æœå‹™åœ°å€: http://localhost:${PORT}`);
  console.log(`ğŸŒ å¤–éƒ¨è¨ªå•: http://[æ‚¨çš„IPåœ°å€]:${PORT}`);
  console.log(`ğŸŒ ç’°å¢ƒ: ${process.env.NODE_ENV || 'development'}`);
});

```

å·²ç‚ºå¾Œç«¯æ·»åŠ æ ¹è·¯å¾‘è™•ç†ã€‚ç”±æ–¼ä½¿ç”¨ nodemonï¼Œè®Šæ›´æœƒè‡ªå‹•é‡æ–°è¼‰å…¥ã€‚

ç¾åœ¨ï¼š
- è¨ªå• `http://localhost:5000` æœƒçœ‹åˆ° API æœå‹™ä¿¡æ¯å’Œå¯ç”¨ç«¯é»åˆ—è¡¨
- è¨ªå• `http://localhost:3000` æ˜¯å‰ç«¯ç¶²é ï¼ˆå·¥å–®ç®¡ç†ç³»çµ±ç•Œé¢ï¼‰
- è¨ªå• `http://localhost:5000/health` å¯æª¢æŸ¥å¾Œç«¯å¥åº·ç‹€æ…‹

**èªªæ˜**ï¼š
- å¾Œç«¯ï¼ˆç«¯å£ 5000ï¼‰ï¼šAPI æœå‹™å™¨ï¼Œæä¾› JSON API
- å‰ç«¯ï¼ˆç«¯å£ 3000ï¼‰ï¼šReact ç¶²é æ‡‰ç”¨ï¼Œæä¾›ç”¨æˆ¶ç•Œé¢

è«‹é‡æ–°æ•´ç† `http://localhost:5000`ï¼Œæ‡‰æœƒçœ‹åˆ°æœå‹™ä¿¡æ¯å’Œç«¯é»åˆ—è¡¨ã€‚å‰ç«¯ç¶²é è«‹è¨ªå• `http://localhost:3000`ã€‚


æª¢æ¸¬åˆ°è³‡æ–™åº«éŒ¯èª¤ï¼šè³‡æ–™åº«ç¼ºå°‘ `ProductionTarget.actualYield` æ¬„ä½ã€‚æª¢æŸ¥ Prisma schema èˆ‡è·¯ç”±ï¼Œæº–å‚™åŒæ­¥è³‡æ–™åº«ï¼š


å•é¡Œæ˜¯ Prisma Client èˆ‡è³‡æ–™åº«ä¸åŒæ­¥ã€‚é‡æ–°ç”Ÿæˆ Prisma Clientï¼Œä¸¦åŒæ­¥è³‡æ–™åº«ï¼š


æ¬Šé™éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶æ­£åœ¨ä½¿ç”¨ä¸­ã€‚æ”¹ç”¨ Prisma çš„ db push åŒæ­¥è³‡æ–™åº«æ¶æ§‹ï¼š


è³‡æ–™åº«å·²åŒæ­¥ã€‚é‡å•Ÿå¾Œç«¯æœå‹™ä»¥é‡æ–°è¼‰å…¥ Prisma Clientï¼ˆå¯èƒ½å› æ¬Šé™å•é¡Œæœªæ­£ç¢ºç”Ÿæˆï¼‰ã€‚æª¢æŸ¥å¾Œç«¯æœå‹™çš„ç‹€æ…‹ï¼š


æœå°‹ç¨‹å¼ç¢¼ä¸­æ˜¯å¦ä½¿ç”¨ `actualYield`ï¼š


ç¨‹å¼ç¢¼ä¸­æœªä½¿ç”¨ `actualYield`ï¼Œå¯èƒ½æ˜¯ Prisma Client çš„ç·©å­˜å•é¡Œã€‚æ¸¬è©¦ API æ˜¯å¦æ­£å¸¸é‹ä½œï¼š


éŒ¯èª¤å·²è®Šç‚º `productionTarget`ã€‚æª¢æŸ¥è³‡æ–™åº«çµæ§‹ï¼š


é‡æ–°ç”Ÿæˆ Prisma Clientï¼šå…ˆåœæ­¢å¾Œç«¯æœå‹™ï¼ˆé‡‹æ”¾æ–‡ä»¶é–ï¼‰ï¼Œç„¶å¾Œé‡æ–°ç”Ÿæˆã€‚


é‡æ–°ç”Ÿæˆ Prisma Clientï¼š


Prisma Client æ–‡ä»¶ä»è¢«å ç”¨ã€‚æ‰¾åˆ°ä½¿ç”¨ 5000 ç«¯å£çš„é€²ç¨‹ä¸¦åœæ­¢å®ƒï¼š


é‡æ–°ç”Ÿæˆ Prisma Clientï¼š


å·²æˆåŠŸé‡æ–°ç”Ÿæˆ Prisma Clientã€‚é‡å•Ÿå¾Œç«¯æœå‹™ï¼š


ç­‰å¾…æœå‹™å•Ÿå‹•ï¼Œç„¶å¾Œæ¸¬è©¦ APIï¼š


å•é¡Œå·²è§£æ±ºã€‚API ç¾åœ¨æ­£å¸¸é‹ä½œã€‚

**å•é¡ŒåŸå› ï¼š**
- Prisma Client èˆ‡è³‡æ–™åº«ä¸åŒæ­¥
- å¾Œç«¯æœå‹™æ­£åœ¨é‹è¡Œï¼Œå°è‡´ç„¡æ³•é‡æ–°ç”Ÿæˆ Prisma Client

**è§£æ±ºæ­¥é©Ÿï¼š**
1. åœæ­¢å¾Œç«¯æœå‹™
2. æ¸…é™¤ Prisma Client ç·©å­˜
3. é‡æ–°ç”Ÿæˆ Prisma Client
4. é‡å•Ÿå¾Œç«¯æœå‹™

**æœå‹™ç‹€æ…‹ï¼š**
- å¾Œç«¯ API æœå‹™ï¼š`http://localhost:5000`ï¼ˆæ­£å¸¸é‹è¡Œï¼‰
- å‰ç«¯ç¶²é æ‡‰ç”¨ï¼š`http://localhost:3000`ï¼ˆæ­£å¸¸é‹è¡Œï¼‰

ç¾åœ¨å¯ä»¥åœ¨ç€è¦½å™¨ä¸­è¨ªå• `http://localhost:3000`ï¼Œæ‡‰å¯æ­£å¸¸ä½¿ç”¨å·¥å–®ç®¡ç†ç³»çµ±ã€‚

---

**User**

è«‹æŠŠé€™ä¸€è¡Œæ‹¿æ‰

---

**Cursor**


æª¢è¦– `client/src/types/target.ts`ï¼Œå®šä½è¦ç§»é™¤çš„è¡Œï¼š


ç§»é™¤ç¬¬ 80 è¡Œçš„ç©ºè¡Œï¼š


```typescript
// é ç”Ÿç”¢ç›®æ¨™ç‹€æ…‹æšèˆ‰
export enum TargetStatus {
  PLANNING = 'PLANNING',     // è¦åŠƒä¸­
  IN_PROGRESS = 'IN_PROGRESS', // é€²è¡Œä¸­
  COMPLETED = 'COMPLETED',   // å·²å®Œæˆ
  CANCELLED = 'CANCELLED'    // å·²å–æ¶ˆ
}

// é ç”Ÿç”¢ç›®æ¨™è³‡æ–™ä»‹é¢
export interface ProductionTarget {
  id: string;
  name: string;                    // ç›®æ¨™åç¨±
  description?: string;            // ç›®æ¨™æè¿°
  expectedCompletionDate: string;  // é è¨ˆå®Œæˆæ™‚é–“
  status: TargetStatus;            // ç›®æ¨™ç‹€æ…‹
  createdAt: string;              // å»ºç«‹æ™‚é–“
  updatedAt: string;              // æ›´æ–°æ™‚é–“
}

// å»ºç«‹é ç”Ÿç”¢ç›®æ¨™è«‹æ±‚ä»‹é¢
export interface CreateTargetRequest {
  name: string;
  description?: string;
  expectedCompletionDate: string;
}

// æ›´æ–°é ç”Ÿç”¢ç›®æ¨™è«‹æ±‚ä»‹é¢
export interface UpdateTargetRequest {
  name?: string;
  description?: string;
  expectedCompletionDate?: string;
  status?: TargetStatus;
}

// é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨å›æ‡‰ä»‹é¢
export interface TargetListResponse {
  targets: ProductionTarget[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}

// å·¥å–®æ’ç¨‹è³‡æ–™ä»‹é¢
export interface TicketSchedule {
  id: string;
  ticketId: string;
  targetId: string;
  scheduledDate: string;          // æ’ç¨‹æ—¥æœŸ
  scheduledTime?: string;         // æ’ç¨‹æ™‚é–“
  priority: 'HIGH' | 'MEDIUM' | 'LOW'; // å„ªå…ˆç´š
  status: string;
  deviceId: string;
  createdAt: string;
  updatedAt: string;
}

// åŒ…å«é—œè¯è³‡æ–™çš„å·¥å–®æ’ç¨‹ä»‹é¢ï¼ˆç”¨æ–¼ API å›æ‡‰ï¼‰
export interface TicketScheduleWithRelations extends TicketSchedule {
  ticket: {
    id: string;
    deviceId: string;
    imageId?: string;
    status: string;
    createdAt: string;
    updatedAt: string;
  };
  target: {
    id: string;
    name: string;
    description?: string;
    expectedCompletionDate: string;
    status: TargetStatus;
    createdAt: string;
    updatedAt: string;
  };
}
// å»ºç«‹å·¥å–®æ’ç¨‹è«‹æ±‚ä»‹é¢
export interface CreateScheduleRequest {
  ticketId: string;
  targetId: string;
  scheduledDate: string;
  scheduledTime?: string;
  priority: 'HIGH' | 'MEDIUM' | 'LOW';
}

// æ›´æ–°å·¥å–®æ’ç¨‹è«‹æ±‚ä»‹é¢
export interface UpdateScheduleRequest {
  scheduledDate?: string;
  scheduledTime?: string;
  priority?: 'HIGH' | 'MEDIUM' | 'LOW';
  status?: string;
}

```

å·²ç§»é™¤ç¬¬ 80 è¡Œçš„ç©ºè¡Œã€‚æª¢æŸ¥æ˜¯å¦æœ‰èªæ³•éŒ¯èª¤ï¼š


å·²ç§»é™¤ç¬¬ 80 è¡Œçš„ç©ºè¡Œï¼Œæ²’æœ‰èªæ³•éŒ¯èª¤ã€‚æ–‡ä»¶å·²æ›´æ–°ã€‚

---

**User**

è«‹æŠŠé€™å€‹æ¬„ä½åˆªæ‰

---

**Cursor**


æœå°‹é¡¯ç¤ºã€Œç›®æ¨™ã€æ¬„ä½çš„ç¨‹å¼ç¢¼ï¼š


æœå°‹é¡¯ç¤ºã€Œç›®æ¨™ :ã€æ–‡å­—çš„å…·é«”ä½ç½®ï¼š


å·²æ‰¾åˆ°é¡¯ç¤ºã€Œç›®æ¨™ã€çš„ç¨‹å¼ç¢¼ã€‚ç§»é™¤è©²æ¬„ä½ï¼š


ç§»é™¤é¡¯ç¤ºã€Œç›®æ¨™ã€æ¬„ä½çš„ç¨‹å¼ç¢¼ï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.target.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™
  useEffect(() => {
    loadSchedules();
  }, [loadSchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                å·¥å–®æ’ç¨‹
              </Typography>
            </Box>
            <Button
              variant="contained"
              startIcon={<AddIcon />}
              onClick={() => setCreateDialogOpen(true)}
              size="small"
            >
              æ–°å¢æ’ç¨‹
            </Button>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

æª¢æŸ¥æ˜¯å¦æœ‰èªæ³•éŒ¯èª¤ï¼š


å·²ç§»é™¤é¡¯ç¤ºã€Œç›®æ¨™ï¼š{selectedTarget.name}ã€çš„æ¬„ä½ã€‚å·¥å–®æ’ç¨‹é é¢ç¾åœ¨åªé¡¯ç¤ºã€Œå·¥å–®æ’ç¨‹ã€æ¨™é¡Œï¼Œä¸å†é¡¯ç¤ºç›®æ¨™åç¨±ã€‚è®Šæ›´å·²ä¿å­˜ï¼Œæ²’æœ‰èªæ³•éŒ¯èª¤ã€‚

---

**User**

è«‹æŠŠ[å»ºç«‹å·¥å–®]çš„åŠŸèƒ½å¾é€™å€‹æ¬„ä½ä¸­ç§»é™¤

---

**Cursor**


æœå°‹é¡¯ç¤ºã€Œå»ºç«‹å·¥å–®ã€æŒ‰éˆ•çš„ç¨‹å¼ç¢¼ï¼š


æª¢è¦– `AppMUI.tsx`ï¼Œç¢ºèªéœ€è¦ç§»é™¤çš„ç¨‹å¼ç¢¼ï¼š


ç§»é™¤ã€Œå»ºç«‹å·¥å–®ã€åŠŸèƒ½ï¼šç§»é™¤æŒ‰éˆ•ã€ç›¸é—œç‹€æ…‹ã€è™•ç†å‡½æ•¸å’Œå°è©±æ¡†ã€‚


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  AppBar,
  Toolbar,
  Typography,
  Container,
  Paper,
  Drawer,
  List,
  ListItem,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Divider,
  IconButton,
  Fab,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Alert,
  CircularProgress,
  ThemeProvider,
  createTheme,
  CssBaseline,
} from '@mui/material';
import { ProductionTarget } from './types/target';
import { Ticket } from './types/ticket';
import { TargetService } from './services/targetApi';
import {
  Menu as MenuIcon,
  Dashboard as DashboardIcon,
  Assignment as AssignmentIcon,
  Schedule as ScheduleIcon,
  Add as AddIcon,
  Close as CloseIcon,
  Info as InfoIcon,
} from '@mui/icons-material';

// åŒ¯å…¥è‡ªå®šç¾©å…ƒä»¶
import TargetList from './components/TargetList';
import TicketSchedule from './components/TicketSchedule';
import CreateTargetForm from './components/CreateTargetForm';
import TicketDetailMUI from './components/TicketDetailMUI';
import VersionDialog from './components/VersionDialog';

// å»ºç«‹æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ
const medicalTheme = createTheme({
  palette: {
    mode: 'light',
    primary: {
      main: '#1976d2', // é†«ç™‚è—
      light: '#42a5f5',
      dark: '#1565c0',
      contrastText: '#ffffff',
    },
    secondary: {
      main: '#00acc1', // é’è—è‰²
      light: '#26c6da',
      dark: '#0097a7',
      contrastText: '#ffffff',
    },
    background: {
      default: '#f8fafc', // æ·ºç°ç™½
      paper: '#ffffff',
    },
    text: {
      primary: '#1a202c', // æ·±ç°
      secondary: '#4a5568', // ä¸­ç°
    },
    success: {
      main: '#10b981', // é†«ç™‚ç¶ 
      light: '#34d399',
      dark: '#059669',
    },
    warning: {
      main: '#f59e0b', // é†«ç™‚æ©™
      light: '#fbbf24',
      dark: '#d97706',
    },
    error: {
      main: '#ef4444', // é†«ç™‚ç´…
      light: '#f87171',
      dark: '#dc2626',
    },
    info: {
      main: '#3b82f6', // è³‡è¨Šè—
      light: '#60a5fa',
      dark: '#2563eb',
    },
  },
  typography: {
    fontFamily: '"Inter", "Roboto", "Helvetica", "Arial", sans-serif',
    h1: {
      fontSize: '2.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h2: {
      fontSize: '2rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h3: {
      fontSize: '1.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h4: {
      fontSize: '1.25rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h5: {
      fontSize: '1.125rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h6: {
      fontSize: '1rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    body1: {
      fontSize: '1rem',
      color: '#4a5568',
    },
    body2: {
      fontSize: '0.875rem',
      color: '#4a5568',
    },
  },
  shape: {
    borderRadius: 8,
  },
  components: {
    MuiAppBar: {
      styleOverrides: {
        root: {
          backgroundColor: '#1976d2',
          boxShadow: '0 2px 8px rgba(25, 118, 210, 0.15)',
          color: '#ffffff', // ç¢ºä¿AppBarä¸­çš„æ–‡å­—ç‚ºç™½è‰²
        },
      },
    },
    MuiCard: {
      styleOverrides: {
        root: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06)',
          border: '1px solid #e2e8f0',
        },
      },
    },
    MuiButton: {
      styleOverrides: {
        root: {
          textTransform: 'none',
          fontWeight: 500,
          borderRadius: 8,
        },
        contained: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
        },
      },
    },
    MuiPaper: {
      styleOverrides: {
        root: {
          backgroundColor: '#ffffff',
        },
      },
    },
  },
});

// ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶
const AppMUI: React.FC = () => {
  // ç‹€æ…‹ç®¡ç†
  const [targets, setTargets] = useState<ProductionTarget[]>([]);
  const [selectedTarget, setSelectedTarget] = useState<ProductionTarget | null>(null);
  const [selectedTicket, setSelectedTicket] = useState<Ticket | null>(null);
  const [createTargetDialogOpen, setCreateTargetDialogOpen] = useState(false);
  const [createTicketDialogOpen, setCreateTicketDialogOpen] = useState(false);
  const [ticketDetailDialogOpen, setTicketDetailDialogOpen] = useState(false);
  const [versionDialogOpen, setVersionDialogOpen] = useState(false);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  const loadTargets = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const response = await TargetService.getTargets(1, 100); // è¼‰å…¥æ‰€æœ‰ç›®æ¨™

      if (response.success && response.data) {
        setTargets(response.data.targets);
      } else {
        setError(response.message || 'è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—');
      }
    } catch (error: any) {
      console.error('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™éŒ¯èª¤:', error);
      setError('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, []);

  // å…ƒä»¶è¼‰å…¥æ™‚è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  useEffect(() => {
    loadTargets();
  }, [loadTargets]);

  /**
   * è™•ç†ç›®æ¨™é¸æ“‡
   * @param target é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
   */
  const handleTargetSelect = (target: ProductionTarget) => {
    setSelectedTarget(target);
    setDrawerOpen(false); // é—œé–‰å´é‚Šæ¬„
  };

  /**
   * è™•ç†å·¥å–®é¸æ“‡
   * @param ticket é¸ä¸­çš„å·¥å–®
   */
  const handleTicketSelect = (ticket: Ticket) => {
    setSelectedTicket(ticket);
    setTicketDetailDialogOpen(true);
  };

  /**
   * è™•ç†æ–°å¢ç›®æ¨™æˆåŠŸ
   * @param target æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleCreateTargetSuccess = (target: ProductionTarget) => {
    setTargets(prev => [...prev, target]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setCreateTargetDialogOpen(false);
    setSelectedTarget(target); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†ç›®æ¨™æ–°å¢ï¼ˆå¾ TargetList çµ„ä»¶ï¼‰
   * @param newTarget æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleTargetCreate = (newTarget: ProductionTarget) => {
    setTargets(prev => [...prev, newTarget]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setSelectedTarget(newTarget); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†å»ºç«‹å·¥å–®æˆåŠŸ
   * @param newTicket æ–°å»ºç«‹çš„å·¥å–®
   */
  const handleCreateTicketSuccess = (newTicket: Ticket) => {
    setCreateTicketDialogOpen(false);
    // å¯ä»¥åœ¨é€™è£¡æ·»åŠ æˆåŠŸæç¤ºæˆ–å…¶ä»–è™•ç†
  };

  /**
   * è™•ç†ç›®æ¨™æ›´æ–°
   * @param targetId ç›®æ¨™ ID
   * @param updatedTarget æ›´æ–°å¾Œçš„ç›®æ¨™
   */
  const handleTargetUpdate = (targetId: string, updatedTarget: ProductionTarget) => {
    // æ›´æ–°ç›®æ¨™åˆ—è¡¨ä¸­çš„å°æ‡‰ç›®æ¨™
    setTargets((prev: ProductionTarget[]) => prev.map((target: ProductionTarget) => 
      target.id === targetId ? updatedTarget : target
    ));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«æ›´æ–°ï¼Œæ›´æ–°é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(updatedTarget);
    }
  };

  /**
   * è™•ç†ç›®æ¨™åˆªé™¤
   * @param targetId ç›®æ¨™ ID
   */
  const handleTargetDelete = (targetId: string) => {
    setTargets(prev => prev.filter(target => target.id !== targetId));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«åˆªé™¤ï¼Œæ¸…é™¤é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(null);
    }
  };

  /**
   * è™•ç†å·¥å–®æ›´æ–°
   * @param updatedTicket æ›´æ–°å¾Œçš„å·¥å–®
   */
  const handleTicketUpdate = (updatedTicket: Ticket) => {
    setSelectedTicket(updatedTicket);
    // é€™è£¡å¯ä»¥è§¸ç™¼æ’ç¨‹åˆ—è¡¨çš„é‡æ–°è¼‰å…¥
  };

  /**
   * è™•ç†å°è©±æ¡†é—œé–‰
   */
  const handleCloseDialogs = () => {
    setCreateTargetDialogOpen(false);
    setTicketDetailDialogOpen(false);
    setSelectedTicket(null);
  };

  /**
   * è™•ç†å´é‚Šæ¬„åˆ‡æ›
   */
  const handleDrawerToggle = () => {
    setDrawerOpen(!drawerOpen);
  };

  return (
    <ThemeProvider theme={medicalTheme}>
      <CssBaseline />
      <Box sx={{ display: 'flex', height: '100vh' }}>
        {/* æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œåˆ— */}
        <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }}>
          <Toolbar>
            <IconButton
              color="inherit"
              aria-label="é–‹å•Ÿé¸å–®"
              onClick={handleDrawerToggle}
              edge="start"
              sx={{ mr: 2 }}
            >
              <MenuIcon />
            </IconButton>
            <Typography variant="h6" component="div" sx={{ flexGrow: 1, color: 'white' }}>
              å·¥å–®ç®¡ç†ç³»çµ±
            </Typography>
            <Typography variant="body2" sx={{ mr: 2, color: 'white' }}>
              é ç”Ÿç”¢ç›®æ¨™èˆ‡å·¥å–®æ’ç¨‹ç®¡ç†
            </Typography>
            <Button
              color="inherit"
              startIcon={<AddIcon />}
              onClick={() => setCreateTicketDialogOpen(true)}
              sx={{ mr: 1 }}
            >
              å»ºç«‹å·¥å–®
            </Button>
            <Button
              color="inherit"
              startIcon={<InfoIcon />}
              onClick={() => setVersionDialogOpen(true)}
              sx={{ mr: 1 }}
            >
              ç‰ˆæœ¬è³‡è¨Š
            </Button>
          </Toolbar>
        </AppBar>

        {/* å´é‚Šæ¬„ */}
        <Drawer
          variant="temporary"
          open={drawerOpen}
          onClose={handleDrawerToggle}
          sx={{
            width: 300,
            flexShrink: 0,
            '& .MuiDrawer-paper': {
              width: 300,
              boxSizing: 'border-box',
            },
          }}
        >
          <Toolbar />
          <Box sx={{ overflow: 'auto', height: '100%' }}>
            <List>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <DashboardIcon />
                  </ListItemIcon>
                  <ListItemText primary="å„€è¡¨æ¿" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <AssignmentIcon />
                  </ListItemIcon>
                  <ListItemText primary="å·¥å–®ç®¡ç†" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <ScheduleIcon />
                  </ListItemIcon>
                  <ListItemText primary="æ’ç¨‹ç®¡ç†" />
                </ListItemButton>
              </ListItem>
            </List>
            <Divider />
            <Box sx={{ p: 2 }}>
              <Button
                variant="contained"
                fullWidth
                startIcon={<AddIcon />}
                onClick={() => setCreateTargetDialogOpen(true)}
              >
                æ–°å¢é ç”Ÿç”¢ç›®æ¨™
              </Button>
            </Box>
          </Box>
        </Drawer>

        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
        <Box
          component="main"
          sx={{
            flexGrow: 1,
            display: 'flex',
            flexDirection: 'column',
            height: '100vh',
            overflow: 'hidden',
          }}
        >
          <Toolbar /> {/* ç‚º AppBar ç•™å‡ºç©ºé–“ */}
          
          <Box sx={{ display: 'flex', flex: 1, height: 'calc(100vh - 64px)' }}>
            {/* å·¦å´ï¼šé ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨ */}
            <Box sx={{ width: { xs: '100%', md: '33.33%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                  borderRight: 1,
                  borderColor: 'divider',
                }}
              >
                <TargetList
                  targets={targets}
                  onTargetSelect={handleTargetSelect}
                  selectedTargetId={selectedTarget?.id}
                  onTargetUpdate={handleTargetUpdate}
                  onTargetDelete={handleTargetDelete}
                  onTargetCreate={handleTargetCreate}
                />
              </Paper>
            </Box>

            {/* å³å´ï¼šå·¥å–®æ’ç¨‹ */}
            <Box sx={{ width: { xs: '100%', md: '66.67%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                }}
              >
                <TicketSchedule
                  selectedTarget={selectedTarget}
                  onTicketSelect={handleTicketSelect}
                  onTargetUpdate={handleTargetUpdate}
                />
              </Paper>
            </Box>
          </Box>
        </Box>

        {/* æ–°å¢é ç”Ÿç”¢ç›®æ¨™å°è©±æ¡† */}
        <CreateTargetForm
          open={createTargetDialogOpen}
          onClose={() => setCreateTargetDialogOpen(false)}
          onSuccess={handleCreateTargetSuccess}
        />

        {/* å·¥å–®è©³æƒ…å°è©±æ¡† */}
        <TicketDetailMUI
          open={ticketDetailDialogOpen}
          ticket={selectedTicket || undefined}
          onClose={() => setTicketDetailDialogOpen(false)}
          onUpdate={handleTicketUpdate}
        />

        {/* å»ºç«‹å·¥å–®å°è©±æ¡† */}
        <CreateTicketForm
          open={createTicketDialogOpen}
          onClose={() => setCreateTicketDialogOpen(false)}
          onSuccess={handleCreateTicketSuccess}
        />

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert 
            severity="error" 
            sx={{ 
              position: 'fixed', 
              top: 16, 
              right: 16, 
              zIndex: 9999,
              minWidth: 300,
            }}
            onClose={() => setError(null)}
          >
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­è¦†è“‹å±¤ */}
        {loading && (
          <Box
            sx={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'rgba(0, 0, 0, 0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
            }}
          >
            <CircularProgress size={60} />
          </Box>
        )}

        {/* ç‰ˆæœ¬è³‡è¨Šå°è©±æ¡† */}
        <VersionDialog
          open={versionDialogOpen}
          onClose={() => setVersionDialogOpen(false)}
        />
      </Box>
    </ThemeProvider>
  );
};

export default AppMUI;

```

```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  AppBar,
  Toolbar,
  Typography,
  Container,
  Paper,
  Drawer,
  List,
  ListItem,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Divider,
  IconButton,
  Fab,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Alert,
  CircularProgress,
  ThemeProvider,
  createTheme,
  CssBaseline,
} from '@mui/material';
import { ProductionTarget } from './types/target';
import { Ticket } from './types/ticket';
import { TargetService } from './services/targetApi';
import {
  Menu as MenuIcon,
  Dashboard as DashboardIcon,
  Assignment as AssignmentIcon,
  Schedule as ScheduleIcon,
  Add as AddIcon,
  Close as CloseIcon,
  Info as InfoIcon,
} from '@mui/icons-material';

// åŒ¯å…¥è‡ªå®šç¾©å…ƒä»¶
import TargetList from './components/TargetList';
import TicketSchedule from './components/TicketSchedule';
import CreateTargetForm from './components/CreateTargetForm';
import TicketDetailMUI from './components/TicketDetailMUI';
import VersionDialog from './components/VersionDialog';

// å»ºç«‹æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ
const medicalTheme = createTheme({
  palette: {
    mode: 'light',
    primary: {
      main: '#1976d2', // é†«ç™‚è—
      light: '#42a5f5',
      dark: '#1565c0',
      contrastText: '#ffffff',
    },
    secondary: {
      main: '#00acc1', // é’è—è‰²
      light: '#26c6da',
      dark: '#0097a7',
      contrastText: '#ffffff',
    },
    background: {
      default: '#f8fafc', // æ·ºç°ç™½
      paper: '#ffffff',
    },
    text: {
      primary: '#1a202c', // æ·±ç°
      secondary: '#4a5568', // ä¸­ç°
    },
    success: {
      main: '#10b981', // é†«ç™‚ç¶ 
      light: '#34d399',
      dark: '#059669',
    },
    warning: {
      main: '#f59e0b', // é†«ç™‚æ©™
      light: '#fbbf24',
      dark: '#d97706',
    },
    error: {
      main: '#ef4444', // é†«ç™‚ç´…
      light: '#f87171',
      dark: '#dc2626',
    },
    info: {
      main: '#3b82f6', // è³‡è¨Šè—
      light: '#60a5fa',
      dark: '#2563eb',
    },
  },
  typography: {
    fontFamily: '"Inter", "Roboto", "Helvetica", "Arial", sans-serif',
    h1: {
      fontSize: '2.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h2: {
      fontSize: '2rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h3: {
      fontSize: '1.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h4: {
      fontSize: '1.25rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h5: {
      fontSize: '1.125rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h6: {
      fontSize: '1rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    body1: {
      fontSize: '1rem',
      color: '#4a5568',
    },
    body2: {
      fontSize: '0.875rem',
      color: '#4a5568',
    },
  },
  shape: {
    borderRadius: 8,
  },
  components: {
    MuiAppBar: {
      styleOverrides: {
        root: {
          backgroundColor: '#1976d2',
          boxShadow: '0 2px 8px rgba(25, 118, 210, 0.15)',
          color: '#ffffff', // ç¢ºä¿AppBarä¸­çš„æ–‡å­—ç‚ºç™½è‰²
        },
      },
    },
    MuiCard: {
      styleOverrides: {
        root: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06)',
          border: '1px solid #e2e8f0',
        },
      },
    },
    MuiButton: {
      styleOverrides: {
        root: {
          textTransform: 'none',
          fontWeight: 500,
          borderRadius: 8,
        },
        contained: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
        },
      },
    },
    MuiPaper: {
      styleOverrides: {
        root: {
          backgroundColor: '#ffffff',
        },
      },
    },
  },
});

// ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶
const AppMUI: React.FC = () => {
  // ç‹€æ…‹ç®¡ç†
  const [targets, setTargets] = useState<ProductionTarget[]>([]);
  const [selectedTarget, setSelectedTarget] = useState<ProductionTarget | null>(null);
  const [selectedTicket, setSelectedTicket] = useState<Ticket | null>(null);
  const [createTargetDialogOpen, setCreateTargetDialogOpen] = useState(false);
  const [ticketDetailDialogOpen, setTicketDetailDialogOpen] = useState(false);
  const [versionDialogOpen, setVersionDialogOpen] = useState(false);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  const loadTargets = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const response = await TargetService.getTargets(1, 100); // è¼‰å…¥æ‰€æœ‰ç›®æ¨™

      if (response.success && response.data) {
        setTargets(response.data.targets);
      } else {
        setError(response.message || 'è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—');
      }
    } catch (error: any) {
      console.error('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™éŒ¯èª¤:', error);
      setError('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, []);

  // å…ƒä»¶è¼‰å…¥æ™‚è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  useEffect(() => {
    loadTargets();
  }, [loadTargets]);

  /**
   * è™•ç†ç›®æ¨™é¸æ“‡
   * @param target é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
   */
  const handleTargetSelect = (target: ProductionTarget) => {
    setSelectedTarget(target);
    setDrawerOpen(false); // é—œé–‰å´é‚Šæ¬„
  };

  /**
   * è™•ç†å·¥å–®é¸æ“‡
   * @param ticket é¸ä¸­çš„å·¥å–®
   */
  const handleTicketSelect = (ticket: Ticket) => {
    setSelectedTicket(ticket);
    setTicketDetailDialogOpen(true);
  };

  /**
   * è™•ç†æ–°å¢ç›®æ¨™æˆåŠŸ
   * @param target æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleCreateTargetSuccess = (target: ProductionTarget) => {
    setTargets(prev => [...prev, target]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setCreateTargetDialogOpen(false);
    setSelectedTarget(target); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†ç›®æ¨™æ–°å¢ï¼ˆå¾ TargetList çµ„ä»¶ï¼‰
   * @param newTarget æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleTargetCreate = (newTarget: ProductionTarget) => {
    setTargets(prev => [...prev, newTarget]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setSelectedTarget(newTarget); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†å»ºç«‹å·¥å–®æˆåŠŸ
   * @param newTicket æ–°å»ºç«‹çš„å·¥å–®
   */
  const handleCreateTicketSuccess = (newTicket: Ticket) => {
    setCreateTicketDialogOpen(false);
    // å¯ä»¥åœ¨é€™è£¡æ·»åŠ æˆåŠŸæç¤ºæˆ–å…¶ä»–è™•ç†
  };

  /**
   * è™•ç†ç›®æ¨™æ›´æ–°
   * @param targetId ç›®æ¨™ ID
   * @param updatedTarget æ›´æ–°å¾Œçš„ç›®æ¨™
   */
  const handleTargetUpdate = (targetId: string, updatedTarget: ProductionTarget) => {
    // æ›´æ–°ç›®æ¨™åˆ—è¡¨ä¸­çš„å°æ‡‰ç›®æ¨™
    setTargets((prev: ProductionTarget[]) => prev.map((target: ProductionTarget) => 
      target.id === targetId ? updatedTarget : target
    ));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«æ›´æ–°ï¼Œæ›´æ–°é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(updatedTarget);
    }
  };

  /**
   * è™•ç†ç›®æ¨™åˆªé™¤
   * @param targetId ç›®æ¨™ ID
   */
  const handleTargetDelete = (targetId: string) => {
    setTargets(prev => prev.filter(target => target.id !== targetId));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«åˆªé™¤ï¼Œæ¸…é™¤é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(null);
    }
  };

  /**
   * è™•ç†å·¥å–®æ›´æ–°
   * @param updatedTicket æ›´æ–°å¾Œçš„å·¥å–®
   */
  const handleTicketUpdate = (updatedTicket: Ticket) => {
    setSelectedTicket(updatedTicket);
    // é€™è£¡å¯ä»¥è§¸ç™¼æ’ç¨‹åˆ—è¡¨çš„é‡æ–°è¼‰å…¥
  };

  /**
   * è™•ç†å°è©±æ¡†é—œé–‰
   */
  const handleCloseDialogs = () => {
    setCreateTargetDialogOpen(false);
    setTicketDetailDialogOpen(false);
    setSelectedTicket(null);
  };

  /**
   * è™•ç†å´é‚Šæ¬„åˆ‡æ›
   */
  const handleDrawerToggle = () => {
    setDrawerOpen(!drawerOpen);
  };

  return (
    <ThemeProvider theme={medicalTheme}>
      <CssBaseline />
      <Box sx={{ display: 'flex', height: '100vh' }}>
        {/* æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œåˆ— */}
        <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }}>
          <Toolbar>
            <IconButton
              color="inherit"
              aria-label="é–‹å•Ÿé¸å–®"
              onClick={handleDrawerToggle}
              edge="start"
              sx={{ mr: 2 }}
            >
              <MenuIcon />
            </IconButton>
            <Typography variant="h6" component="div" sx={{ flexGrow: 1, color: 'white' }}>
              å·¥å–®ç®¡ç†ç³»çµ±
            </Typography>
            <Typography variant="body2" sx={{ mr: 2, color: 'white' }}>
              é ç”Ÿç”¢ç›®æ¨™èˆ‡å·¥å–®æ’ç¨‹ç®¡ç†
            </Typography>
            <Button
              color="inherit"
              startIcon={<AddIcon />}
              onClick={() => setCreateTicketDialogOpen(true)}
              sx={{ mr: 1 }}
            >
              å»ºç«‹å·¥å–®
            </Button>
            <Button
              color="inherit"
              startIcon={<InfoIcon />}
              onClick={() => setVersionDialogOpen(true)}
              sx={{ mr: 1 }}
            >
              ç‰ˆæœ¬è³‡è¨Š
            </Button>
          </Toolbar>
        </AppBar>

        {/* å´é‚Šæ¬„ */}
        <Drawer
          variant="temporary"
          open={drawerOpen}
          onClose={handleDrawerToggle}
          sx={{
            width: 300,
            flexShrink: 0,
            '& .MuiDrawer-paper': {
              width: 300,
              boxSizing: 'border-box',
            },
          }}
        >
          <Toolbar />
          <Box sx={{ overflow: 'auto', height: '100%' }}>
            <List>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <DashboardIcon />
                  </ListItemIcon>
                  <ListItemText primary="å„€è¡¨æ¿" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <AssignmentIcon />
                  </ListItemIcon>
                  <ListItemText primary="å·¥å–®ç®¡ç†" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <ScheduleIcon />
                  </ListItemIcon>
                  <ListItemText primary="æ’ç¨‹ç®¡ç†" />
                </ListItemButton>
              </ListItem>
            </List>
            <Divider />
            <Box sx={{ p: 2 }}>
              <Button
                variant="contained"
                fullWidth
                startIcon={<AddIcon />}
                onClick={() => setCreateTargetDialogOpen(true)}
              >
                æ–°å¢é ç”Ÿç”¢ç›®æ¨™
              </Button>
            </Box>
          </Box>
        </Drawer>

        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
        <Box
          component="main"
          sx={{
            flexGrow: 1,
            display: 'flex',
            flexDirection: 'column',
            height: '100vh',
            overflow: 'hidden',
          }}
        >
          <Toolbar /> {/* ç‚º AppBar ç•™å‡ºç©ºé–“ */}
          
          <Box sx={{ display: 'flex', flex: 1, height: 'calc(100vh - 64px)' }}>
            {/* å·¦å´ï¼šé ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨ */}
            <Box sx={{ width: { xs: '100%', md: '33.33%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                  borderRight: 1,
                  borderColor: 'divider',
                }}
              >
                <TargetList
                  targets={targets}
                  onTargetSelect={handleTargetSelect}
                  selectedTargetId={selectedTarget?.id}
                  onTargetUpdate={handleTargetUpdate}
                  onTargetDelete={handleTargetDelete}
                  onTargetCreate={handleTargetCreate}
                />
              </Paper>
            </Box>

            {/* å³å´ï¼šå·¥å–®æ’ç¨‹ */}
            <Box sx={{ width: { xs: '100%', md: '66.67%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                }}
              >
                <TicketSchedule
                  selectedTarget={selectedTarget}
                  onTicketSelect={handleTicketSelect}
                  onTargetUpdate={handleTargetUpdate}
                />
              </Paper>
            </Box>
          </Box>
        </Box>

        {/* æ–°å¢é ç”Ÿç”¢ç›®æ¨™å°è©±æ¡† */}
        <CreateTargetForm
          open={createTargetDialogOpen}
          onClose={() => setCreateTargetDialogOpen(false)}
          onSuccess={handleCreateTargetSuccess}
        />

        {/* å·¥å–®è©³æƒ…å°è©±æ¡† */}
        <TicketDetailMUI
          open={ticketDetailDialogOpen}
          ticket={selectedTicket || undefined}
          onClose={() => setTicketDetailDialogOpen(false)}
          onUpdate={handleTicketUpdate}
        />

        {/* å»ºç«‹å·¥å–®å°è©±æ¡† */}
        <CreateTicketForm
          open={createTicketDialogOpen}
          onClose={() => setCreateTicketDialogOpen(false)}
          onSuccess={handleCreateTicketSuccess}
        />

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert 
            severity="error" 
            sx={{ 
              position: 'fixed', 
              top: 16, 
              right: 16, 
              zIndex: 9999,
              minWidth: 300,
            }}
            onClose={() => setError(null)}
          >
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­è¦†è“‹å±¤ */}
        {loading && (
          <Box
            sx={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'rgba(0, 0, 0, 0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
            }}
          >
            <CircularProgress size={60} />
          </Box>
        )}

        {/* ç‰ˆæœ¬è³‡è¨Šå°è©±æ¡† */}
        <VersionDialog
          open={versionDialogOpen}
          onClose={() => setVersionDialogOpen(false)}
        />
      </Box>
    </ThemeProvider>
  );
};

export default AppMUI;

```

```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  AppBar,
  Toolbar,
  Typography,
  Container,
  Paper,
  Drawer,
  List,
  ListItem,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Divider,
  IconButton,
  Fab,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Alert,
  CircularProgress,
  ThemeProvider,
  createTheme,
  CssBaseline,
} from '@mui/material';
import { ProductionTarget } from './types/target';
import { Ticket } from './types/ticket';
import { TargetService } from './services/targetApi';
import {
  Menu as MenuIcon,
  Dashboard as DashboardIcon,
  Assignment as AssignmentIcon,
  Schedule as ScheduleIcon,
  Add as AddIcon,
  Close as CloseIcon,
  Info as InfoIcon,
} from '@mui/icons-material';

// åŒ¯å…¥è‡ªå®šç¾©å…ƒä»¶
import TargetList from './components/TargetList';
import TicketSchedule from './components/TicketSchedule';
import CreateTargetForm from './components/CreateTargetForm';
import TicketDetailMUI from './components/TicketDetailMUI';
import VersionDialog from './components/VersionDialog';

// å»ºç«‹æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ
const medicalTheme = createTheme({
  palette: {
    mode: 'light',
    primary: {
      main: '#1976d2', // é†«ç™‚è—
      light: '#42a5f5',
      dark: '#1565c0',
      contrastText: '#ffffff',
    },
    secondary: {
      main: '#00acc1', // é’è—è‰²
      light: '#26c6da',
      dark: '#0097a7',
      contrastText: '#ffffff',
    },
    background: {
      default: '#f8fafc', // æ·ºç°ç™½
      paper: '#ffffff',
    },
    text: {
      primary: '#1a202c', // æ·±ç°
      secondary: '#4a5568', // ä¸­ç°
    },
    success: {
      main: '#10b981', // é†«ç™‚ç¶ 
      light: '#34d399',
      dark: '#059669',
    },
    warning: {
      main: '#f59e0b', // é†«ç™‚æ©™
      light: '#fbbf24',
      dark: '#d97706',
    },
    error: {
      main: '#ef4444', // é†«ç™‚ç´…
      light: '#f87171',
      dark: '#dc2626',
    },
    info: {
      main: '#3b82f6', // è³‡è¨Šè—
      light: '#60a5fa',
      dark: '#2563eb',
    },
  },
  typography: {
    fontFamily: '"Inter", "Roboto", "Helvetica", "Arial", sans-serif',
    h1: {
      fontSize: '2.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h2: {
      fontSize: '2rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h3: {
      fontSize: '1.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h4: {
      fontSize: '1.25rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h5: {
      fontSize: '1.125rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h6: {
      fontSize: '1rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    body1: {
      fontSize: '1rem',
      color: '#4a5568',
    },
    body2: {
      fontSize: '0.875rem',
      color: '#4a5568',
    },
  },
  shape: {
    borderRadius: 8,
  },
  components: {
    MuiAppBar: {
      styleOverrides: {
        root: {
          backgroundColor: '#1976d2',
          boxShadow: '0 2px 8px rgba(25, 118, 210, 0.15)',
          color: '#ffffff', // ç¢ºä¿AppBarä¸­çš„æ–‡å­—ç‚ºç™½è‰²
        },
      },
    },
    MuiCard: {
      styleOverrides: {
        root: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06)',
          border: '1px solid #e2e8f0',
        },
      },
    },
    MuiButton: {
      styleOverrides: {
        root: {
          textTransform: 'none',
          fontWeight: 500,
          borderRadius: 8,
        },
        contained: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
        },
      },
    },
    MuiPaper: {
      styleOverrides: {
        root: {
          backgroundColor: '#ffffff',
        },
      },
    },
  },
});

// ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶
const AppMUI: React.FC = () => {
  // ç‹€æ…‹ç®¡ç†
  const [targets, setTargets] = useState<ProductionTarget[]>([]);
  const [selectedTarget, setSelectedTarget] = useState<ProductionTarget | null>(null);
  const [selectedTicket, setSelectedTicket] = useState<Ticket | null>(null);
  const [createTargetDialogOpen, setCreateTargetDialogOpen] = useState(false);
  const [ticketDetailDialogOpen, setTicketDetailDialogOpen] = useState(false);
  const [versionDialogOpen, setVersionDialogOpen] = useState(false);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  const loadTargets = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const response = await TargetService.getTargets(1, 100); // è¼‰å…¥æ‰€æœ‰ç›®æ¨™

      if (response.success && response.data) {
        setTargets(response.data.targets);
      } else {
        setError(response.message || 'è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—');
      }
    } catch (error: any) {
      console.error('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™éŒ¯èª¤:', error);
      setError('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, []);

  // å…ƒä»¶è¼‰å…¥æ™‚è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  useEffect(() => {
    loadTargets();
  }, [loadTargets]);

  /**
   * è™•ç†ç›®æ¨™é¸æ“‡
   * @param target é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
   */
  const handleTargetSelect = (target: ProductionTarget) => {
    setSelectedTarget(target);
    setDrawerOpen(false); // é—œé–‰å´é‚Šæ¬„
  };

  /**
   * è™•ç†å·¥å–®é¸æ“‡
   * @param ticket é¸ä¸­çš„å·¥å–®
   */
  const handleTicketSelect = (ticket: Ticket) => {
    setSelectedTicket(ticket);
    setTicketDetailDialogOpen(true);
  };

  /**
   * è™•ç†æ–°å¢ç›®æ¨™æˆåŠŸ
   * @param target æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleCreateTargetSuccess = (target: ProductionTarget) => {
    setTargets(prev => [...prev, target]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setCreateTargetDialogOpen(false);
    setSelectedTarget(target); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†ç›®æ¨™æ–°å¢ï¼ˆå¾ TargetList çµ„ä»¶ï¼‰
   * @param newTarget æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleTargetCreate = (newTarget: ProductionTarget) => {
    setTargets(prev => [...prev, newTarget]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setSelectedTarget(newTarget); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†ç›®æ¨™æ›´æ–°
   * @param targetId ç›®æ¨™ ID
   * @param updatedTarget æ›´æ–°å¾Œçš„ç›®æ¨™
   */
  const handleTargetUpdate = (targetId: string, updatedTarget: ProductionTarget) => {
    // æ›´æ–°ç›®æ¨™åˆ—è¡¨ä¸­çš„å°æ‡‰ç›®æ¨™
    setTargets((prev: ProductionTarget[]) => prev.map((target: ProductionTarget) => 
      target.id === targetId ? updatedTarget : target
    ));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«æ›´æ–°ï¼Œæ›´æ–°é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(updatedTarget);
    }
  };

  /**
   * è™•ç†ç›®æ¨™åˆªé™¤
   * @param targetId ç›®æ¨™ ID
   */
  const handleTargetDelete = (targetId: string) => {
    setTargets(prev => prev.filter(target => target.id !== targetId));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«åˆªé™¤ï¼Œæ¸…é™¤é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(null);
    }
  };

  /**
   * è™•ç†å·¥å–®æ›´æ–°
   * @param updatedTicket æ›´æ–°å¾Œçš„å·¥å–®
   */
  const handleTicketUpdate = (updatedTicket: Ticket) => {
    setSelectedTicket(updatedTicket);
    // é€™è£¡å¯ä»¥è§¸ç™¼æ’ç¨‹åˆ—è¡¨çš„é‡æ–°è¼‰å…¥
  };

  /**
   * è™•ç†å°è©±æ¡†é—œé–‰
   */
  const handleCloseDialogs = () => {
    setCreateTargetDialogOpen(false);
    setTicketDetailDialogOpen(false);
    setSelectedTicket(null);
  };

  /**
   * è™•ç†å´é‚Šæ¬„åˆ‡æ›
   */
  const handleDrawerToggle = () => {
    setDrawerOpen(!drawerOpen);
  };

  return (
    <ThemeProvider theme={medicalTheme}>
      <CssBaseline />
      <Box sx={{ display: 'flex', height: '100vh' }}>
        {/* æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œåˆ— */}
        <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }}>
          <Toolbar>
            <IconButton
              color="inherit"
              aria-label="é–‹å•Ÿé¸å–®"
              onClick={handleDrawerToggle}
              edge="start"
              sx={{ mr: 2 }}
            >
              <MenuIcon />
            </IconButton>
            <Typography variant="h6" component="div" sx={{ flexGrow: 1, color: 'white' }}>
              å·¥å–®ç®¡ç†ç³»çµ±
            </Typography>
            <Typography variant="body2" sx={{ mr: 2, color: 'white' }}>
              é ç”Ÿç”¢ç›®æ¨™èˆ‡å·¥å–®æ’ç¨‹ç®¡ç†
            </Typography>
            <Button
              color="inherit"
              startIcon={<AddIcon />}
              onClick={() => setCreateTicketDialogOpen(true)}
              sx={{ mr: 1 }}
            >
              å»ºç«‹å·¥å–®
            </Button>
            <Button
              color="inherit"
              startIcon={<InfoIcon />}
              onClick={() => setVersionDialogOpen(true)}
              sx={{ mr: 1 }}
            >
              ç‰ˆæœ¬è³‡è¨Š
            </Button>
          </Toolbar>
        </AppBar>

        {/* å´é‚Šæ¬„ */}
        <Drawer
          variant="temporary"
          open={drawerOpen}
          onClose={handleDrawerToggle}
          sx={{
            width: 300,
            flexShrink: 0,
            '& .MuiDrawer-paper': {
              width: 300,
              boxSizing: 'border-box',
            },
          }}
        >
          <Toolbar />
          <Box sx={{ overflow: 'auto', height: '100%' }}>
            <List>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <DashboardIcon />
                  </ListItemIcon>
                  <ListItemText primary="å„€è¡¨æ¿" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <AssignmentIcon />
                  </ListItemIcon>
                  <ListItemText primary="å·¥å–®ç®¡ç†" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <ScheduleIcon />
                  </ListItemIcon>
                  <ListItemText primary="æ’ç¨‹ç®¡ç†" />
                </ListItemButton>
              </ListItem>
            </List>
            <Divider />
            <Box sx={{ p: 2 }}>
              <Button
                variant="contained"
                fullWidth
                startIcon={<AddIcon />}
                onClick={() => setCreateTargetDialogOpen(true)}
              >
                æ–°å¢é ç”Ÿç”¢ç›®æ¨™
              </Button>
            </Box>
          </Box>
        </Drawer>

        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
        <Box
          component="main"
          sx={{
            flexGrow: 1,
            display: 'flex',
            flexDirection: 'column',
            height: '100vh',
            overflow: 'hidden',
          }}
        >
          <Toolbar /> {/* ç‚º AppBar ç•™å‡ºç©ºé–“ */}
          
          <Box sx={{ display: 'flex', flex: 1, height: 'calc(100vh - 64px)' }}>
            {/* å·¦å´ï¼šé ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨ */}
            <Box sx={{ width: { xs: '100%', md: '33.33%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                  borderRight: 1,
                  borderColor: 'divider',
                }}
              >
                <TargetList
                  targets={targets}
                  onTargetSelect={handleTargetSelect}
                  selectedTargetId={selectedTarget?.id}
                  onTargetUpdate={handleTargetUpdate}
                  onTargetDelete={handleTargetDelete}
                  onTargetCreate={handleTargetCreate}
                />
              </Paper>
            </Box>

            {/* å³å´ï¼šå·¥å–®æ’ç¨‹ */}
            <Box sx={{ width: { xs: '100%', md: '66.67%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                }}
              >
                <TicketSchedule
                  selectedTarget={selectedTarget}
                  onTicketSelect={handleTicketSelect}
                  onTargetUpdate={handleTargetUpdate}
                />
              </Paper>
            </Box>
          </Box>
        </Box>

        {/* æ–°å¢é ç”Ÿç”¢ç›®æ¨™å°è©±æ¡† */}
        <CreateTargetForm
          open={createTargetDialogOpen}
          onClose={() => setCreateTargetDialogOpen(false)}
          onSuccess={handleCreateTargetSuccess}
        />

        {/* å·¥å–®è©³æƒ…å°è©±æ¡† */}
        <TicketDetailMUI
          open={ticketDetailDialogOpen}
          ticket={selectedTicket || undefined}
          onClose={() => setTicketDetailDialogOpen(false)}
          onUpdate={handleTicketUpdate}
        />

        {/* å»ºç«‹å·¥å–®å°è©±æ¡† */}
        <CreateTicketForm
          open={createTicketDialogOpen}
          onClose={() => setCreateTicketDialogOpen(false)}
          onSuccess={handleCreateTicketSuccess}
        />

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert 
            severity="error" 
            sx={{ 
              position: 'fixed', 
              top: 16, 
              right: 16, 
              zIndex: 9999,
              minWidth: 300,
            }}
            onClose={() => setError(null)}
          >
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­è¦†è“‹å±¤ */}
        {loading && (
          <Box
            sx={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'rgba(0, 0, 0, 0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
            }}
          >
            <CircularProgress size={60} />
          </Box>
        )}

        {/* ç‰ˆæœ¬è³‡è¨Šå°è©±æ¡† */}
        <VersionDialog
          open={versionDialogOpen}
          onClose={() => setVersionDialogOpen(false)}
        />
      </Box>
    </ThemeProvider>
  );
};

export default AppMUI;

```

```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  AppBar,
  Toolbar,
  Typography,
  Container,
  Paper,
  Drawer,
  List,
  ListItem,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Divider,
  IconButton,
  Fab,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Alert,
  CircularProgress,
  ThemeProvider,
  createTheme,
  CssBaseline,
} from '@mui/material';
import { ProductionTarget } from './types/target';
import { Ticket } from './types/ticket';
import { TargetService } from './services/targetApi';
import {
  Menu as MenuIcon,
  Dashboard as DashboardIcon,
  Assignment as AssignmentIcon,
  Schedule as ScheduleIcon,
  Add as AddIcon,
  Close as CloseIcon,
  Info as InfoIcon,
} from '@mui/icons-material';

// åŒ¯å…¥è‡ªå®šç¾©å…ƒä»¶
import TargetList from './components/TargetList';
import TicketSchedule from './components/TicketSchedule';
import CreateTargetForm from './components/CreateTargetForm';
import TicketDetailMUI from './components/TicketDetailMUI';
import VersionDialog from './components/VersionDialog';

// å»ºç«‹æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ
const medicalTheme = createTheme({
  palette: {
    mode: 'light',
    primary: {
      main: '#1976d2', // é†«ç™‚è—
      light: '#42a5f5',
      dark: '#1565c0',
      contrastText: '#ffffff',
    },
    secondary: {
      main: '#00acc1', // é’è—è‰²
      light: '#26c6da',
      dark: '#0097a7',
      contrastText: '#ffffff',
    },
    background: {
      default: '#f8fafc', // æ·ºç°ç™½
      paper: '#ffffff',
    },
    text: {
      primary: '#1a202c', // æ·±ç°
      secondary: '#4a5568', // ä¸­ç°
    },
    success: {
      main: '#10b981', // é†«ç™‚ç¶ 
      light: '#34d399',
      dark: '#059669',
    },
    warning: {
      main: '#f59e0b', // é†«ç™‚æ©™
      light: '#fbbf24',
      dark: '#d97706',
    },
    error: {
      main: '#ef4444', // é†«ç™‚ç´…
      light: '#f87171',
      dark: '#dc2626',
    },
    info: {
      main: '#3b82f6', // è³‡è¨Šè—
      light: '#60a5fa',
      dark: '#2563eb',
    },
  },
  typography: {
    fontFamily: '"Inter", "Roboto", "Helvetica", "Arial", sans-serif',
    h1: {
      fontSize: '2.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h2: {
      fontSize: '2rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h3: {
      fontSize: '1.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h4: {
      fontSize: '1.25rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h5: {
      fontSize: '1.125rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h6: {
      fontSize: '1rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    body1: {
      fontSize: '1rem',
      color: '#4a5568',
    },
    body2: {
      fontSize: '0.875rem',
      color: '#4a5568',
    },
  },
  shape: {
    borderRadius: 8,
  },
  components: {
    MuiAppBar: {
      styleOverrides: {
        root: {
          backgroundColor: '#1976d2',
          boxShadow: '0 2px 8px rgba(25, 118, 210, 0.15)',
          color: '#ffffff', // ç¢ºä¿AppBarä¸­çš„æ–‡å­—ç‚ºç™½è‰²
        },
      },
    },
    MuiCard: {
      styleOverrides: {
        root: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06)',
          border: '1px solid #e2e8f0',
        },
      },
    },
    MuiButton: {
      styleOverrides: {
        root: {
          textTransform: 'none',
          fontWeight: 500,
          borderRadius: 8,
        },
        contained: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
        },
      },
    },
    MuiPaper: {
      styleOverrides: {
        root: {
          backgroundColor: '#ffffff',
        },
      },
    },
  },
});

// ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶
const AppMUI: React.FC = () => {
  // ç‹€æ…‹ç®¡ç†
  const [targets, setTargets] = useState<ProductionTarget[]>([]);
  const [selectedTarget, setSelectedTarget] = useState<ProductionTarget | null>(null);
  const [selectedTicket, setSelectedTicket] = useState<Ticket | null>(null);
  const [createTargetDialogOpen, setCreateTargetDialogOpen] = useState(false);
  const [ticketDetailDialogOpen, setTicketDetailDialogOpen] = useState(false);
  const [versionDialogOpen, setVersionDialogOpen] = useState(false);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  const loadTargets = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const response = await TargetService.getTargets(1, 100); // è¼‰å…¥æ‰€æœ‰ç›®æ¨™

      if (response.success && response.data) {
        setTargets(response.data.targets);
      } else {
        setError(response.message || 'è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—');
      }
    } catch (error: any) {
      console.error('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™éŒ¯èª¤:', error);
      setError('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, []);

  // å…ƒä»¶è¼‰å…¥æ™‚è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  useEffect(() => {
    loadTargets();
  }, [loadTargets]);

  /**
   * è™•ç†ç›®æ¨™é¸æ“‡
   * @param target é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
   */
  const handleTargetSelect = (target: ProductionTarget) => {
    setSelectedTarget(target);
    setDrawerOpen(false); // é—œé–‰å´é‚Šæ¬„
  };

  /**
   * è™•ç†å·¥å–®é¸æ“‡
   * @param ticket é¸ä¸­çš„å·¥å–®
   */
  const handleTicketSelect = (ticket: Ticket) => {
    setSelectedTicket(ticket);
    setTicketDetailDialogOpen(true);
  };

  /**
   * è™•ç†æ–°å¢ç›®æ¨™æˆåŠŸ
   * @param target æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleCreateTargetSuccess = (target: ProductionTarget) => {
    setTargets(prev => [...prev, target]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setCreateTargetDialogOpen(false);
    setSelectedTarget(target); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†ç›®æ¨™æ–°å¢ï¼ˆå¾ TargetList çµ„ä»¶ï¼‰
   * @param newTarget æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleTargetCreate = (newTarget: ProductionTarget) => {
    setTargets(prev => [...prev, newTarget]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setSelectedTarget(newTarget); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†ç›®æ¨™æ›´æ–°
   * @param targetId ç›®æ¨™ ID
   * @param updatedTarget æ›´æ–°å¾Œçš„ç›®æ¨™
   */
  const handleTargetUpdate = (targetId: string, updatedTarget: ProductionTarget) => {
    // æ›´æ–°ç›®æ¨™åˆ—è¡¨ä¸­çš„å°æ‡‰ç›®æ¨™
    setTargets((prev: ProductionTarget[]) => prev.map((target: ProductionTarget) => 
      target.id === targetId ? updatedTarget : target
    ));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«æ›´æ–°ï¼Œæ›´æ–°é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(updatedTarget);
    }
  };

  /**
   * è™•ç†ç›®æ¨™åˆªé™¤
   * @param targetId ç›®æ¨™ ID
   */
  const handleTargetDelete = (targetId: string) => {
    setTargets(prev => prev.filter(target => target.id !== targetId));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«åˆªé™¤ï¼Œæ¸…é™¤é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(null);
    }
  };

  /**
   * è™•ç†å·¥å–®æ›´æ–°
   * @param updatedTicket æ›´æ–°å¾Œçš„å·¥å–®
   */
  const handleTicketUpdate = (updatedTicket: Ticket) => {
    setSelectedTicket(updatedTicket);
    // é€™è£¡å¯ä»¥è§¸ç™¼æ’ç¨‹åˆ—è¡¨çš„é‡æ–°è¼‰å…¥
  };

  /**
   * è™•ç†å°è©±æ¡†é—œé–‰
   */
  const handleCloseDialogs = () => {
    setCreateTargetDialogOpen(false);
    setTicketDetailDialogOpen(false);
    setSelectedTicket(null);
  };

  /**
   * è™•ç†å´é‚Šæ¬„åˆ‡æ›
   */
  const handleDrawerToggle = () => {
    setDrawerOpen(!drawerOpen);
  };

  return (
    <ThemeProvider theme={medicalTheme}>
      <CssBaseline />
      <Box sx={{ display: 'flex', height: '100vh' }}>
        {/* æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œåˆ— */}
        <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }}>
          <Toolbar>
            <IconButton
              color="inherit"
              aria-label="é–‹å•Ÿé¸å–®"
              onClick={handleDrawerToggle}
              edge="start"
              sx={{ mr: 2 }}
            >
              <MenuIcon />
            </IconButton>
            <Typography variant="h6" component="div" sx={{ flexGrow: 1, color: 'white' }}>
              å·¥å–®ç®¡ç†ç³»çµ±
            </Typography>
            <Typography variant="body2" sx={{ mr: 2, color: 'white' }}>
              é ç”Ÿç”¢ç›®æ¨™èˆ‡å·¥å–®æ’ç¨‹ç®¡ç†
            </Typography>
            <Button
              color="inherit"
              startIcon={<InfoIcon />}
              onClick={() => setVersionDialogOpen(true)}
              sx={{ mr: 1 }}
            >
              ç‰ˆæœ¬è³‡è¨Š
            </Button>
          </Toolbar>
        </AppBar>

        {/* å´é‚Šæ¬„ */}
        <Drawer
          variant="temporary"
          open={drawerOpen}
          onClose={handleDrawerToggle}
          sx={{
            width: 300,
            flexShrink: 0,
            '& .MuiDrawer-paper': {
              width: 300,
              boxSizing: 'border-box',
            },
          }}
        >
          <Toolbar />
          <Box sx={{ overflow: 'auto', height: '100%' }}>
            <List>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <DashboardIcon />
                  </ListItemIcon>
                  <ListItemText primary="å„€è¡¨æ¿" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <AssignmentIcon />
                  </ListItemIcon>
                  <ListItemText primary="å·¥å–®ç®¡ç†" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <ScheduleIcon />
                  </ListItemIcon>
                  <ListItemText primary="æ’ç¨‹ç®¡ç†" />
                </ListItemButton>
              </ListItem>
            </List>
            <Divider />
            <Box sx={{ p: 2 }}>
              <Button
                variant="contained"
                fullWidth
                startIcon={<AddIcon />}
                onClick={() => setCreateTargetDialogOpen(true)}
              >
                æ–°å¢é ç”Ÿç”¢ç›®æ¨™
              </Button>
            </Box>
          </Box>
        </Drawer>

        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
        <Box
          component="main"
          sx={{
            flexGrow: 1,
            display: 'flex',
            flexDirection: 'column',
            height: '100vh',
            overflow: 'hidden',
          }}
        >
          <Toolbar /> {/* ç‚º AppBar ç•™å‡ºç©ºé–“ */}
          
          <Box sx={{ display: 'flex', flex: 1, height: 'calc(100vh - 64px)' }}>
            {/* å·¦å´ï¼šé ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨ */}
            <Box sx={{ width: { xs: '100%', md: '33.33%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                  borderRight: 1,
                  borderColor: 'divider',
                }}
              >
                <TargetList
                  targets={targets}
                  onTargetSelect={handleTargetSelect}
                  selectedTargetId={selectedTarget?.id}
                  onTargetUpdate={handleTargetUpdate}
                  onTargetDelete={handleTargetDelete}
                  onTargetCreate={handleTargetCreate}
                />
              </Paper>
            </Box>

            {/* å³å´ï¼šå·¥å–®æ’ç¨‹ */}
            <Box sx={{ width: { xs: '100%', md: '66.67%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                }}
              >
                <TicketSchedule
                  selectedTarget={selectedTarget}
                  onTicketSelect={handleTicketSelect}
                  onTargetUpdate={handleTargetUpdate}
                />
              </Paper>
            </Box>
          </Box>
        </Box>

        {/* æ–°å¢é ç”Ÿç”¢ç›®æ¨™å°è©±æ¡† */}
        <CreateTargetForm
          open={createTargetDialogOpen}
          onClose={() => setCreateTargetDialogOpen(false)}
          onSuccess={handleCreateTargetSuccess}
        />

        {/* å·¥å–®è©³æƒ…å°è©±æ¡† */}
        <TicketDetailMUI
          open={ticketDetailDialogOpen}
          ticket={selectedTicket || undefined}
          onClose={() => setTicketDetailDialogOpen(false)}
          onUpdate={handleTicketUpdate}
        />

        {/* å»ºç«‹å·¥å–®å°è©±æ¡† */}
        <CreateTicketForm
          open={createTicketDialogOpen}
          onClose={() => setCreateTicketDialogOpen(false)}
          onSuccess={handleCreateTicketSuccess}
        />

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert 
            severity="error" 
            sx={{ 
              position: 'fixed', 
              top: 16, 
              right: 16, 
              zIndex: 9999,
              minWidth: 300,
            }}
            onClose={() => setError(null)}
          >
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­è¦†è“‹å±¤ */}
        {loading && (
          <Box
            sx={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'rgba(0, 0, 0, 0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
            }}
          >
            <CircularProgress size={60} />
          </Box>
        )}

        {/* ç‰ˆæœ¬è³‡è¨Šå°è©±æ¡† */}
        <VersionDialog
          open={versionDialogOpen}
          onClose={() => setVersionDialogOpen(false)}
        />
      </Box>
    </ThemeProvider>
  );
};

export default AppMUI;

```

```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  AppBar,
  Toolbar,
  Typography,
  Container,
  Paper,
  Drawer,
  List,
  ListItem,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Divider,
  IconButton,
  Fab,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Alert,
  CircularProgress,
  ThemeProvider,
  createTheme,
  CssBaseline,
} from '@mui/material';
import { ProductionTarget } from './types/target';
import { Ticket } from './types/ticket';
import { TargetService } from './services/targetApi';
import {
  Menu as MenuIcon,
  Dashboard as DashboardIcon,
  Assignment as AssignmentIcon,
  Schedule as ScheduleIcon,
  Add as AddIcon,
  Close as CloseIcon,
  Info as InfoIcon,
} from '@mui/icons-material';

// åŒ¯å…¥è‡ªå®šç¾©å…ƒä»¶
import TargetList from './components/TargetList';
import TicketSchedule from './components/TicketSchedule';
import CreateTargetForm from './components/CreateTargetForm';
import TicketDetailMUI from './components/TicketDetailMUI';
import VersionDialog from './components/VersionDialog';

// å»ºç«‹æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ
const medicalTheme = createTheme({
  palette: {
    mode: 'light',
    primary: {
      main: '#1976d2', // é†«ç™‚è—
      light: '#42a5f5',
      dark: '#1565c0',
      contrastText: '#ffffff',
    },
    secondary: {
      main: '#00acc1', // é’è—è‰²
      light: '#26c6da',
      dark: '#0097a7',
      contrastText: '#ffffff',
    },
    background: {
      default: '#f8fafc', // æ·ºç°ç™½
      paper: '#ffffff',
    },
    text: {
      primary: '#1a202c', // æ·±ç°
      secondary: '#4a5568', // ä¸­ç°
    },
    success: {
      main: '#10b981', // é†«ç™‚ç¶ 
      light: '#34d399',
      dark: '#059669',
    },
    warning: {
      main: '#f59e0b', // é†«ç™‚æ©™
      light: '#fbbf24',
      dark: '#d97706',
    },
    error: {
      main: '#ef4444', // é†«ç™‚ç´…
      light: '#f87171',
      dark: '#dc2626',
    },
    info: {
      main: '#3b82f6', // è³‡è¨Šè—
      light: '#60a5fa',
      dark: '#2563eb',
    },
  },
  typography: {
    fontFamily: '"Inter", "Roboto", "Helvetica", "Arial", sans-serif',
    h1: {
      fontSize: '2.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h2: {
      fontSize: '2rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h3: {
      fontSize: '1.5rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h4: {
      fontSize: '1.25rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h5: {
      fontSize: '1.125rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    h6: {
      fontSize: '1rem',
      fontWeight: 600,
      color: '#1a202c',
    },
    body1: {
      fontSize: '1rem',
      color: '#4a5568',
    },
    body2: {
      fontSize: '0.875rem',
      color: '#4a5568',
    },
  },
  shape: {
    borderRadius: 8,
  },
  components: {
    MuiAppBar: {
      styleOverrides: {
        root: {
          backgroundColor: '#1976d2',
          boxShadow: '0 2px 8px rgba(25, 118, 210, 0.15)',
          color: '#ffffff', // ç¢ºä¿AppBarä¸­çš„æ–‡å­—ç‚ºç™½è‰²
        },
      },
    },
    MuiCard: {
      styleOverrides: {
        root: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06)',
          border: '1px solid #e2e8f0',
        },
      },
    },
    MuiButton: {
      styleOverrides: {
        root: {
          textTransform: 'none',
          fontWeight: 500,
          borderRadius: 8,
        },
        contained: {
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
        },
      },
    },
    MuiPaper: {
      styleOverrides: {
        root: {
          backgroundColor: '#ffffff',
        },
      },
    },
  },
});

// ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶
const AppMUI: React.FC = () => {
  // ç‹€æ…‹ç®¡ç†
  const [targets, setTargets] = useState<ProductionTarget[]>([]);
  const [selectedTarget, setSelectedTarget] = useState<ProductionTarget | null>(null);
  const [selectedTicket, setSelectedTicket] = useState<Ticket | null>(null);
  const [createTargetDialogOpen, setCreateTargetDialogOpen] = useState(false);
  const [ticketDetailDialogOpen, setTicketDetailDialogOpen] = useState(false);
  const [versionDialogOpen, setVersionDialogOpen] = useState(false);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  const loadTargets = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const response = await TargetService.getTargets(1, 100); // è¼‰å…¥æ‰€æœ‰ç›®æ¨™

      if (response.success && response.data) {
        setTargets(response.data.targets);
      } else {
        setError(response.message || 'è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—');
      }
    } catch (error: any) {
      console.error('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™éŒ¯èª¤:', error);
      setError('è¼‰å…¥é ç”Ÿç”¢ç›®æ¨™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, []);

  // å…ƒä»¶è¼‰å…¥æ™‚è¼‰å…¥ç›®æ¨™åˆ—è¡¨
  useEffect(() => {
    loadTargets();
  }, [loadTargets]);

  /**
   * è™•ç†ç›®æ¨™é¸æ“‡
   * @param target é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
   */
  const handleTargetSelect = (target: ProductionTarget) => {
    setSelectedTarget(target);
    setDrawerOpen(false); // é—œé–‰å´é‚Šæ¬„
  };

  /**
   * è™•ç†å·¥å–®é¸æ“‡
   * @param ticket é¸ä¸­çš„å·¥å–®
   */
  const handleTicketSelect = (ticket: Ticket) => {
    setSelectedTicket(ticket);
    setTicketDetailDialogOpen(true);
  };

  /**
   * è™•ç†æ–°å¢ç›®æ¨™æˆåŠŸ
   * @param target æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleCreateTargetSuccess = (target: ProductionTarget) => {
    setTargets(prev => [...prev, target]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setCreateTargetDialogOpen(false);
    setSelectedTarget(target); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†ç›®æ¨™æ–°å¢ï¼ˆå¾ TargetList çµ„ä»¶ï¼‰
   * @param newTarget æ–°å»ºç«‹çš„ç›®æ¨™
   */
  const handleTargetCreate = (newTarget: ProductionTarget) => {
    setTargets(prev => [...prev, newTarget]); // å°‡æ–°ç›®æ¨™æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    setSelectedTarget(newTarget); // è‡ªå‹•é¸ä¸­æ–°å»ºç«‹çš„ç›®æ¨™
  };

  /**
   * è™•ç†ç›®æ¨™æ›´æ–°
   * @param targetId ç›®æ¨™ ID
   * @param updatedTarget æ›´æ–°å¾Œçš„ç›®æ¨™
   */
  const handleTargetUpdate = (targetId: string, updatedTarget: ProductionTarget) => {
    // æ›´æ–°ç›®æ¨™åˆ—è¡¨ä¸­çš„å°æ‡‰ç›®æ¨™
    setTargets((prev: ProductionTarget[]) => prev.map((target: ProductionTarget) => 
      target.id === targetId ? updatedTarget : target
    ));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«æ›´æ–°ï¼Œæ›´æ–°é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(updatedTarget);
    }
  };

  /**
   * è™•ç†ç›®æ¨™åˆªé™¤
   * @param targetId ç›®æ¨™ ID
   */
  const handleTargetDelete = (targetId: string) => {
    setTargets(prev => prev.filter(target => target.id !== targetId));
    
    // å¦‚æœç•¶å‰é¸ä¸­çš„ç›®æ¨™è¢«åˆªé™¤ï¼Œæ¸…é™¤é¸ä¸­ç‹€æ…‹
    if (selectedTarget && selectedTarget.id === targetId) {
      setSelectedTarget(null);
    }
  };

  /**
   * è™•ç†å·¥å–®æ›´æ–°
   * @param updatedTicket æ›´æ–°å¾Œçš„å·¥å–®
   */
  const handleTicketUpdate = (updatedTicket: Ticket) => {
    setSelectedTicket(updatedTicket);
    // é€™è£¡å¯ä»¥è§¸ç™¼æ’ç¨‹åˆ—è¡¨çš„é‡æ–°è¼‰å…¥
  };

  /**
   * è™•ç†å°è©±æ¡†é—œé–‰
   */
  const handleCloseDialogs = () => {
    setCreateTargetDialogOpen(false);
    setTicketDetailDialogOpen(false);
    setSelectedTicket(null);
  };

  /**
   * è™•ç†å´é‚Šæ¬„åˆ‡æ›
   */
  const handleDrawerToggle = () => {
    setDrawerOpen(!drawerOpen);
  };

  return (
    <ThemeProvider theme={medicalTheme}>
      <CssBaseline />
      <Box sx={{ display: 'flex', height: '100vh' }}>
        {/* æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œåˆ— */}
        <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }}>
          <Toolbar>
            <IconButton
              color="inherit"
              aria-label="é–‹å•Ÿé¸å–®"
              onClick={handleDrawerToggle}
              edge="start"
              sx={{ mr: 2 }}
            >
              <MenuIcon />
            </IconButton>
            <Typography variant="h6" component="div" sx={{ flexGrow: 1, color: 'white' }}>
              å·¥å–®ç®¡ç†ç³»çµ±
            </Typography>
            <Typography variant="body2" sx={{ mr: 2, color: 'white' }}>
              é ç”Ÿç”¢ç›®æ¨™èˆ‡å·¥å–®æ’ç¨‹ç®¡ç†
            </Typography>
            <Button
              color="inherit"
              startIcon={<InfoIcon />}
              onClick={() => setVersionDialogOpen(true)}
              sx={{ mr: 1 }}
            >
              ç‰ˆæœ¬è³‡è¨Š
            </Button>
          </Toolbar>
        </AppBar>

        {/* å´é‚Šæ¬„ */}
        <Drawer
          variant="temporary"
          open={drawerOpen}
          onClose={handleDrawerToggle}
          sx={{
            width: 300,
            flexShrink: 0,
            '& .MuiDrawer-paper': {
              width: 300,
              boxSizing: 'border-box',
            },
          }}
        >
          <Toolbar />
          <Box sx={{ overflow: 'auto', height: '100%' }}>
            <List>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <DashboardIcon />
                  </ListItemIcon>
                  <ListItemText primary="å„€è¡¨æ¿" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <AssignmentIcon />
                  </ListItemIcon>
                  <ListItemText primary="å·¥å–®ç®¡ç†" />
                </ListItemButton>
              </ListItem>
              <ListItem disablePadding>
                <ListItemButton>
                  <ListItemIcon>
                    <ScheduleIcon />
                  </ListItemIcon>
                  <ListItemText primary="æ’ç¨‹ç®¡ç†" />
                </ListItemButton>
              </ListItem>
            </List>
            <Divider />
            <Box sx={{ p: 2 }}>
              <Button
                variant="contained"
                fullWidth
                startIcon={<AddIcon />}
                onClick={() => setCreateTargetDialogOpen(true)}
              >
                æ–°å¢é ç”Ÿç”¢ç›®æ¨™
              </Button>
            </Box>
          </Box>
        </Drawer>

        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
        <Box
          component="main"
          sx={{
            flexGrow: 1,
            display: 'flex',
            flexDirection: 'column',
            height: '100vh',
            overflow: 'hidden',
          }}
        >
          <Toolbar /> {/* ç‚º AppBar ç•™å‡ºç©ºé–“ */}
          
          <Box sx={{ display: 'flex', flex: 1, height: 'calc(100vh - 64px)' }}>
            {/* å·¦å´ï¼šé ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨ */}
            <Box sx={{ width: { xs: '100%', md: '33.33%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                  borderRight: 1,
                  borderColor: 'divider',
                }}
              >
                <TargetList
                  targets={targets}
                  onTargetSelect={handleTargetSelect}
                  selectedTargetId={selectedTarget?.id}
                  onTargetUpdate={handleTargetUpdate}
                  onTargetDelete={handleTargetDelete}
                  onTargetCreate={handleTargetCreate}
                />
              </Paper>
            </Box>

            {/* å³å´ï¼šå·¥å–®æ’ç¨‹ */}
            <Box sx={{ width: { xs: '100%', md: '66.67%' }, height: '100%' }}>
              <Paper 
                sx={{ 
                  height: '100%', 
                  borderRadius: 0,
                }}
              >
                <TicketSchedule
                  selectedTarget={selectedTarget}
                  onTicketSelect={handleTicketSelect}
                  onTargetUpdate={handleTargetUpdate}
                />
              </Paper>
            </Box>
          </Box>
        </Box>

        {/* æ–°å¢é ç”Ÿç”¢ç›®æ¨™å°è©±æ¡† */}
        <CreateTargetForm
          open={createTargetDialogOpen}
          onClose={() => setCreateTargetDialogOpen(false)}
          onSuccess={handleCreateTargetSuccess}
        />

        {/* å·¥å–®è©³æƒ…å°è©±æ¡† */}
        <TicketDetailMUI
          open={ticketDetailDialogOpen}
          ticket={selectedTicket || undefined}
          onClose={() => setTicketDetailDialogOpen(false)}
          onUpdate={handleTicketUpdate}
        />

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert 
            severity="error" 
            sx={{ 
              position: 'fixed', 
              top: 16, 
              right: 16, 
              zIndex: 9999,
              minWidth: 300,
            }}
            onClose={() => setError(null)}
          >
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­è¦†è“‹å±¤ */}
        {loading && (
          <Box
            sx={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'rgba(0, 0, 0, 0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
            }}
          >
            <CircularProgress size={60} />
          </Box>
        )}

        {/* ç‰ˆæœ¬è³‡è¨Šå°è©±æ¡† */}
        <VersionDialog
          open={versionDialogOpen}
          onClose={() => setVersionDialogOpen(false)}
        />
      </Box>
    </ThemeProvider>
  );
};

export default AppMUI;

```

æª¢æŸ¥æ˜¯å¦æœ‰èªæ³•éŒ¯èª¤ï¼š


å·²ç§»é™¤ã€Œå»ºç«‹å·¥å–®ã€åŠŸèƒ½ï¼Œè®Šæ›´å¦‚ä¸‹ï¼š

1. ç§»é™¤æ¨™é¡Œæ¬„ä¸­çš„ã€Œå»ºç«‹å·¥å–®ã€æŒ‰éˆ•ï¼ˆç¬¬ 342-349 è¡Œï¼‰
2. ç§»é™¤ `CreateTicketForm` çµ„ä»¶çš„åŒ¯å…¥
3. ç§»é™¤ `createTicketDialogOpen` ç‹€æ…‹è®Šæ•¸
4. ç§»é™¤ `handleCreateTicketSuccess` è™•ç†å‡½æ•¸
5. ç§»é™¤å»ºç«‹å·¥å–®å°è©±æ¡†çµ„ä»¶

ç¾åœ¨æ¨™é¡Œæ¬„åªæœƒé¡¯ç¤ºï¼š
- "é ç”Ÿç”¢ç›®æ¨™èˆ‡å·¥å–®æ’ç¨‹ç®¡ç†"
- "ç‰ˆæœ¬è³‡è¨Š" æŒ‰éˆ•

è®Šæ›´å·²å®Œæˆï¼Œæ²’æœ‰èªæ³•éŒ¯èª¤ã€‚é é¢æœƒè‡ªå‹•é‡æ–°è¼‰å…¥ä¸¦åæ˜ é€™äº›è®Šæ›´ã€‚

---

**User**

è«‹æ–°å¢[ä»Šæ—¥æ’ç¨‹]ï¼Œè‹¥ä»Šæ—¥ç‚º11/2ï¼Œç•¶useré»é¸[ä»Šæ—¥æ’ç¨‹]ï¼Œç³»çµ±æœƒæŠŠæ¯ä¸€å€‹ç”Ÿç”¢ç›®æ¨™ä¸­11/2çš„æ’æˆæ•´ç†åœ¨ä¸€èµ·

---

**Cursor**


æŸ¥çœ‹ `TicketSchedule.tsx` èˆ‡ APIï¼Œæº–å‚™å¯¦ä½œã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ï¼š


å¯¦ä½œã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ï¼š
1. æ–°å¢å¾Œç«¯ API ç«¯é»ï¼Œæ”¯æ´ä¾æ—¥æœŸç¯©é¸æ’ç¨‹
2. åœ¨å‰ç«¯æ–°å¢ã€Œä»Šæ—¥æ’ç¨‹ã€æŒ‰éˆ•
3. å¯¦ä½œè¼‰å…¥èˆ‡é¡¯ç¤ºé‚è¼¯ï¼Œä¾ç›®æ¨™åˆ†çµ„

å…ˆæ›´æ–°å¾Œç«¯ APIï¼š


å¯¦ä½œã€Œä»Šæ—¥æ’ç¨‹ã€ï¼šå…ˆæ›´æ–°å¾Œç«¯ API ä»¥æ”¯æ´æ—¥æœŸç¯©é¸ï¼Œå†æ›´æ–°å‰ç«¯çµ„ä»¶ã€‚


```javascript
const express = require('express');
const { body, validationResult, param } = require('express-validator');
const { PrismaClient } = require('@prisma/client');

const router = express.Router();
const prisma = new PrismaClient();

/**
 * å»ºç«‹å·¥å–®æ’ç¨‹
 * POST /api/schedules
 * è«‹æ±‚é«”ï¼š
 * - ticketId: å·¥å–® ID (å¿…å¡«)
 * - targetId: é ç”Ÿç”¢ç›®æ¨™ ID (å¿…å¡«)
 * - scheduledDate: æ’ç¨‹æ—¥æœŸ (å¿…å¡«)
 * - scheduledTime: æ’ç¨‹æ™‚é–“ (å¯é¸)
 * - priority: å„ªå…ˆç´š (å¯é¸ï¼Œé è¨­: MEDIUM)
 */
router.post('/', [
  body('ticketId')
    .isString()
    .notEmpty()
    .withMessage('å·¥å–® ID ä¸èƒ½ç‚ºç©º'),
  body('targetId')
    .isString()
    .notEmpty()
    .withMessage('é ç”Ÿç”¢ç›®æ¨™ ID ä¸èƒ½ç‚ºç©º'),
  body('scheduledDate')
    .isString()
    .notEmpty()
    .withMessage('æ’ç¨‹æ—¥æœŸä¸èƒ½ç‚ºç©º')
    .matches(/^\d{4}-\d{2}-\d{2}$/)
    .withMessage('æ’ç¨‹æ—¥æœŸæ ¼å¼å¿…é ˆç‚º YYYY-MM-DD'),
  body('scheduledTime')
    .optional()
    .isString()
    .matches(/^\d{2}:\d{2}$/)
    .withMessage('æ’ç¨‹æ™‚é–“æ ¼å¼å¿…é ˆç‚º HH:mm'),
  body('priority')
    .optional()
    .isIn(['HIGH', 'MEDIUM', 'LOW'])
    .withMessage('å„ªå…ˆç´šå¿…é ˆç‚º HIGH, MEDIUM, æˆ– LOW'),
], async (req, res) => {
  try {
    // é©—è­‰è«‹æ±‚é«”
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        message: 'è«‹æ±‚è³‡æ–™é©—è­‰å¤±æ•—',
        errors: errors.array(),
      });
    }

    const { ticketId, targetId, scheduledDate, scheduledTime, priority = 'MEDIUM' } = req.body;

    // æª¢æŸ¥å·¥å–®æ˜¯å¦å­˜åœ¨
    const ticket = await prisma.ticket.findUnique({
      where: { id: ticketId },
    });

    if (!ticket) {
      return res.status(404).json({
        success: false,
        message: 'å·¥å–®ä¸å­˜åœ¨',
      });
    }

    // æª¢æŸ¥é ç”Ÿç”¢ç›®æ¨™æ˜¯å¦å­˜åœ¨
    const target = await prisma.productionTarget.findUnique({
      where: { id: targetId },
    });

    if (!target) {
      return res.status(404).json({
        success: false,
        message: 'é ç”Ÿç”¢ç›®æ¨™ä¸å­˜åœ¨',
      });
    }

    // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨ç›¸åŒçš„æ’ç¨‹
    const existingSchedule = await prisma.ticketSchedule.findFirst({
      where: {
        ticketId,
        targetId,
        scheduledDate,
      },
    });

    if (existingSchedule) {
      return res.status(409).json({
        success: false,
        message: 'è©²å·¥å–®åœ¨æ­¤ç›®æ¨™ä¸‹å·²æœ‰ç›¸åŒæ—¥æœŸçš„æ’ç¨‹',
      });
    }

    // å»ºç«‹æ–°æ’ç¨‹
    const schedule = await prisma.ticketSchedule.create({
      data: {
        ticketId,
        targetId,
        scheduledDate,
        scheduledTime: scheduledTime || null,
        priority,
        status: 'OPEN', // é è¨­ç‹€æ…‹ç‚ºå¾…è™•ç†
      },
      include: {
        ticket: true,
        target: true,
      },
    });

    // å¦‚æœç›®æ¨™ç‹€æ…‹ç‚ºã€Œè¦åŠƒä¸­ã€ï¼Œè‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€
    if (target.status === 'PLANNING') {
      await prisma.productionTarget.update({
        where: { id: targetId },
        data: { status: 'IN_PROGRESS' },
      });
      
      // æ›´æ–°å›å‚³çš„ç›®æ¨™è³‡æ–™
      schedule.target.status = 'IN_PROGRESS';
    }

    res.status(201).json({
      success: true,
      message: 'å»ºç«‹å·¥å–®æ’ç¨‹æˆåŠŸ',
      data: schedule,
    });
  } catch (error) {
    console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—',
      error: error.message,
    });
  }
});

/**
 * æ›´æ–°å·¥å–®æ’ç¨‹
 * PUT /api/schedules/:id
 * è«‹æ±‚é«”ï¼š
 * - scheduledDate: æ’ç¨‹æ—¥æœŸ (å¯é¸)
 * - scheduledTime: æ’ç¨‹æ™‚é–“ (å¯é¸)
 * - priority: å„ªå…ˆç´š (å¯é¸)
 * - status: æ’ç¨‹ç‹€æ…‹ (å¯é¸)
 */
router.put('/:id', [
  param('id').isString().notEmpty().withMessage('æ’ç¨‹ ID ä¸èƒ½ç‚ºç©º'),
  body('scheduledDate')
    .optional()
    .isString()
    .matches(/^\d{4}-\d{2}-\d{2}$/)
    .withMessage('æ’ç¨‹æ—¥æœŸæ ¼å¼å¿…é ˆç‚º YYYY-MM-DD'),
  body('scheduledTime')
    .optional()
    .isString()
    .matches(/^\d{2}:\d{2}$/)
    .withMessage('æ’ç¨‹æ™‚é–“æ ¼å¼å¿…é ˆç‚º HH:mm'),
  body('priority')
    .optional()
    .isIn(['HIGH', 'MEDIUM', 'LOW'])
    .withMessage('å„ªå…ˆç´šå¿…é ˆç‚º HIGH, MEDIUM, æˆ– LOW'),
  body('status')
    .optional()
    .isIn(['OPEN', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'])
    .withMessage('æ’ç¨‹ç‹€æ…‹å¿…é ˆç‚º OPEN, IN_PROGRESS, COMPLETED, æˆ– CANCELLED'),
], async (req, res) => {
  try {
    // é©—è­‰åƒæ•¸å’Œè«‹æ±‚é«”
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        message: 'è«‹æ±‚è³‡æ–™é©—è­‰å¤±æ•—',
        errors: errors.array(),
      });
    }

    const { id } = req.params;
    const updateData = {};

    // åªæ›´æ–°æä¾›çš„æ¬„ä½
    if (req.body.scheduledDate !== undefined) updateData.scheduledDate = req.body.scheduledDate;
    if (req.body.scheduledTime !== undefined) updateData.scheduledTime = req.body.scheduledTime;
    if (req.body.priority !== undefined) updateData.priority = req.body.priority;
    if (req.body.status !== undefined) updateData.status = req.body.status;

    // æª¢æŸ¥æ’ç¨‹æ˜¯å¦å­˜åœ¨
    const existingSchedule = await prisma.ticketSchedule.findUnique({
      where: { id },
    });

    if (!existingSchedule) {
      return res.status(404).json({
        success: false,
        message: 'å·¥å–®æ’ç¨‹ä¸å­˜åœ¨',
      });
    }

    // æ›´æ–°æ’ç¨‹
    const updatedSchedule = await prisma.ticketSchedule.update({
      where: { id },
      data: updateData,
      include: {
        ticket: true,
        target: true,
      },
    });

    res.json({
      success: true,
      message: 'æ›´æ–°å·¥å–®æ’ç¨‹æˆåŠŸ',
      data: updatedSchedule,
    });
  } catch (error) {
    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—',
      error: error.message,
    });
  }
});

/**
 * åˆªé™¤å·¥å–®æ’ç¨‹
 * DELETE /api/schedules/:id
 */
router.delete('/:id', [
  param('id').isString().notEmpty().withMessage('æ’ç¨‹ ID ä¸èƒ½ç‚ºç©º'),
], async (req, res) => {
  try {
    // é©—è­‰åƒæ•¸
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        message: 'åƒæ•¸é©—è­‰å¤±æ•—',
        errors: errors.array(),
      });
    }

    const { id } = req.params;

    // æª¢æŸ¥æ’ç¨‹æ˜¯å¦å­˜åœ¨
    const existingSchedule = await prisma.ticketSchedule.findUnique({
      where: { id },
    });

    if (!existingSchedule) {
      return res.status(404).json({
        success: false,
        message: 'å·¥å–®æ’ç¨‹ä¸å­˜åœ¨',
      });
    }

    // åˆªé™¤æ’ç¨‹
    await prisma.ticketSchedule.delete({
      where: { id },
    });

    res.json({
      success: true,
      message: 'åˆªé™¤å·¥å–®æ’ç¨‹æˆåŠŸ',
    });
  } catch (error) {
    console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—',
      error: error.message,
    });
  }
});

/**
 * å–å¾—æ‰€æœ‰å·¥å–®æ’ç¨‹
 * GET /api/schedules
 * æŸ¥è©¢åƒæ•¸ï¼š
 * - page: é ç¢¼ (é è¨­: 1)
 * - limit: æ¯é æ•¸é‡ (é è¨­: 10)
 * - targetId: ç›®æ¨™ ID ç¯©é¸ (å¯é¸)
 * - ticketId: å·¥å–® ID ç¯©é¸ (å¯é¸)
 * - status: ç‹€æ…‹ç¯©é¸ (å¯é¸)
 */
router.get('/', async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    const targetId = req.query.targetId;
    const ticketId = req.query.ticketId;
    const status = req.query.status;
    const skip = (page - 1) * limit;

    // å»ºç«‹æŸ¥è©¢æ¢ä»¶
    const where = {};
    if (targetId) where.targetId = targetId;
    if (ticketId) where.ticketId = ticketId;
    if (status) where.status = status;
    if (req.query.date) where.scheduledDate = req.query.date; // æ”¯æ´æ—¥æœŸç¯©é¸

    // æŸ¥è©¢æ’ç¨‹ç¸½æ•¸
    const total = await prisma.ticketSchedule.count({ where });

    // æŸ¥è©¢æ’ç¨‹åˆ—è¡¨
    const schedules = await prisma.ticketSchedule.findMany({
      where,
      include: {
        ticket: true,
        target: true,
      },
      orderBy: [
        { scheduledDate: 'asc' },
        { scheduledTime: 'asc' },
      ],
      skip,
      take: limit,
    });

    // è¨ˆç®—åˆ†é è³‡è¨Š
    const totalPages = Math.ceil(total / limit);

    res.json({
      success: true,
      message: 'å–å¾—å·¥å–®æ’ç¨‹åˆ—è¡¨æˆåŠŸ',
      data: {
        schedules,
        pagination: {
          page,
          limit,
          total,
          totalPages,
        },
      },
    });
  } catch (error) {
    console.error('å–å¾—å·¥å–®æ’ç¨‹åˆ—è¡¨éŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'å–å¾—å·¥å–®æ’ç¨‹åˆ—è¡¨å¤±æ•—',
      error: error.message,
    });
  }
});

/**
 * å–å¾—æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
 * GET /api/schedules/target/:targetId
 */
router.get('/target/:targetId', [
  param('targetId').isString().notEmpty().withMessage('ç›®æ¨™ ID ä¸èƒ½ç‚ºç©º'),
], async (req, res) => {
  try {
    // é©—è­‰åƒæ•¸
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        message: 'åƒæ•¸é©—è­‰å¤±æ•—',
        errors: errors.array(),
      });
    }

    const { targetId } = req.params;

    // æŸ¥è©¢æŒ‡å®šç›®æ¨™çš„æ’ç¨‹
    const schedules = await prisma.ticketSchedule.findMany({
      where: { targetId },
      include: {
        ticket: true,
        target: true,
      },
      orderBy: [
        { scheduledDate: 'asc' },
        { scheduledTime: 'asc' },
      ],
    });

    res.json({
      success: true,
      message: 'å–å¾—ç›®æ¨™å·¥å–®æ’ç¨‹æˆåŠŸ',
      data: schedules,
    });
  } catch (error) {
    console.error('å–å¾—ç›®æ¨™å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'å–å¾—ç›®æ¨™å·¥å–®æ’ç¨‹å¤±æ•—',
      error: error.message,
    });
  }
});

/**
 * å–å¾—å–®ä¸€å·¥å–®æ’ç¨‹è©³æƒ…
 * GET /api/schedules/:id
 */
router.get('/:id', [
  param('id').isString().notEmpty().withMessage('æ’ç¨‹ ID ä¸èƒ½ç‚ºç©º'),
], async (req, res) => {
  try {
    // é©—è­‰åƒæ•¸
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        message: 'åƒæ•¸é©—è­‰å¤±æ•—',
        errors: errors.array(),
      });
    }

    const { id } = req.params;

    // æŸ¥è©¢æ’ç¨‹è©³æƒ…
    const schedule = await prisma.ticketSchedule.findUnique({
      where: { id },
      include: {
        ticket: true,
        target: true,
      },
    });

    if (!schedule) {
      return res.status(404).json({
        success: false,
        message: 'å·¥å–®æ’ç¨‹ä¸å­˜åœ¨',
      });
    }

    res.json({
      success: true,
      message: 'å–å¾—å·¥å–®æ’ç¨‹è©³æƒ…æˆåŠŸ',
      data: schedule,
    });
  } catch (error) {
    console.error('å–å¾—å·¥å–®æ’ç¨‹è©³æƒ…éŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'å–å¾—å·¥å–®æ’ç¨‹è©³æƒ…å¤±æ•—',
      error: error.message,
    });
  }
});

module.exports = router;

```

æ–°å¢å‰ç«¯ API æ–¹æ³•ä»¥å–å¾—ä»Šæ—¥æ’ç¨‹ï¼š


```typescript
import axios from 'axios';
import { 
  ProductionTarget, 
  CreateTargetRequest, 
  UpdateTargetRequest, 
  TargetListResponse,
  TicketSchedule,
  TicketScheduleWithRelations,
  CreateScheduleRequest,
  UpdateScheduleRequest
} from '../types/target';
import { ApiResponse } from '../types/ticket';

// å»ºç«‹ axios å¯¦ä¾‹ï¼Œè¨­å®šåŸºç¤ URL
const api = axios.create({
  baseURL: process.env.REACT_APP_API_URL || 'http://localhost:5000/api',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// é ç”Ÿç”¢ç›®æ¨™ API æœå‹™é¡åˆ¥
export class TargetService {
  /**
   * å–å¾—æ‰€æœ‰é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨
   * @param page é ç¢¼
   * @param limit æ¯é æ•¸é‡
   * @param status ç‹€æ…‹ç¯©é¸
   */
  static async getTargets(
    page: number = 1, 
    limit: number = 10, 
    status?: string
  ): Promise<ApiResponse<TargetListResponse>> {
    try {
      const params = new URLSearchParams({
        page: page.toString(),
        limit: limit.toString(),
        ...(status && { status }),
      });

      const response = await api.get(`/targets?${params}`);
      return response.data;
    } catch (error: any) {
      console.error('å–å¾—é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å–å¾—é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨å¤±æ•—',
      };
    }
  }

  /**
   * å–å¾—å–®ä¸€é ç”Ÿç”¢ç›®æ¨™è©³æƒ…
   * @param targetId ç›®æ¨™ ID
   */
  static async getTarget(targetId: string): Promise<ApiResponse<ProductionTarget>> {
    try {
      const response = await api.get(`/targets/${targetId}`);
      return response.data;
    } catch (error: any) {
      console.error('å–å¾—é ç”Ÿç”¢ç›®æ¨™è©³æƒ…å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å–å¾—é ç”Ÿç”¢ç›®æ¨™è©³æƒ…å¤±æ•—',
      };
    }
  }

  /**
   * å»ºç«‹æ–°çš„é ç”Ÿç”¢ç›®æ¨™
   * @param data ç›®æ¨™è³‡æ–™
   */
  static async createTarget(data: CreateTargetRequest): Promise<ApiResponse<ProductionTarget>> {
    try {
      const response = await api.post('/targets', data);
      return response.data;
    } catch (error: any) {
      console.error('å»ºç«‹é ç”Ÿç”¢ç›®æ¨™å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å»ºç«‹é ç”Ÿç”¢ç›®æ¨™å¤±æ•—',
      };
    }
  }

  /**
   * æ›´æ–°é ç”Ÿç”¢ç›®æ¨™
   * @param targetId ç›®æ¨™ ID
   * @param data æ›´æ–°è³‡æ–™
   */
  static async updateTarget(
    targetId: string, 
    data: UpdateTargetRequest
  ): Promise<ApiResponse<ProductionTarget>> {
    try {
      const response = await api.put(`/targets/${targetId}`, data);
      return response.data;
    } catch (error: any) {
      console.error('æ›´æ–°é ç”Ÿç”¢ç›®æ¨™å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'æ›´æ–°é ç”Ÿç”¢ç›®æ¨™å¤±æ•—',
      };
    }
  }

  /**
   * åˆªé™¤é ç”Ÿç”¢ç›®æ¨™
   * @param targetId ç›®æ¨™ ID
   */
  static async deleteTarget(targetId: string): Promise<ApiResponse<void>> {
    try {
      const response = await api.delete(`/targets/${targetId}`);
      return response.data;
    } catch (error: any) {
      console.error('åˆªé™¤é ç”Ÿç”¢ç›®æ¨™å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'åˆªé™¤é ç”Ÿç”¢ç›®æ¨™å¤±æ•—',
      };
    }
  }

  /**
   * å–å¾—æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
   * @param targetId ç›®æ¨™ ID
   */
  static async getTargetSchedules(targetId: string): Promise<ApiResponse<TicketSchedule[]>> {
    try {
      const response = await api.get(`/schedules/target/${targetId}`);
      return response.data;
    } catch (error: any) {
      console.error('å–å¾—å·¥å–®æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å–å¾—å·¥å–®æ’ç¨‹å¤±æ•—',
      };
    }
  }

  /**
   * å–å¾—æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰æ’ç¨‹
   * @param date æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
   */
  static async getSchedulesByDate(date: string): Promise<ApiResponse<TicketScheduleWithRelations[]>> {
    try {
      const response = await api.get(`/schedules?date=${date}&limit=1000`);
      if (response.data.success && response.data.data?.schedules) {
        return {
          success: true,
          message: response.data.message,
          data: response.data.data.schedules,
        };
      }
      return {
        success: false,
        message: response.data.message || 'å–å¾—ä»Šæ—¥æ’ç¨‹å¤±æ•—',
      };
    } catch (error: any) {
      console.error('å–å¾—ä»Šæ—¥æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å–å¾—ä»Šæ—¥æ’ç¨‹å¤±æ•—',
      };
    }
  }

  /**
   * å»ºç«‹å·¥å–®æ’ç¨‹
   * @param data æ’ç¨‹è³‡æ–™
   */
  static async createSchedule(data: CreateScheduleRequest): Promise<ApiResponse<TicketScheduleWithRelations>> {
    try {
      const response = await api.post('/schedules', data);
      return response.data;
    } catch (error: any) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—',
      };
    }
  }

  /**
   * æ›´æ–°å·¥å–®æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   * @param data æ›´æ–°è³‡æ–™
   */
  static async updateSchedule(
    scheduleId: string, 
    data: UpdateScheduleRequest
  ): Promise<ApiResponse<TicketSchedule>> {
    try {
      const response = await api.put(`/schedules/${scheduleId}`, data);
      return response.data;
    } catch (error: any) {
      console.error('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—',
      };
    }
  }

  /**
   * åˆªé™¤å·¥å–®æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  static async deleteSchedule(scheduleId: string): Promise<ApiResponse<void>> {
    try {
      const response = await api.delete(`/schedules/${scheduleId}`);
      return response.data;
    } catch (error: any) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—',
      };
    }
  }
}

```

æ›´æ–° TicketSchedule çµ„ä»¶ï¼Œæ–°å¢ã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ï¼š


æ›´æ–° TicketSchedule çµ„ä»¶ï¼Œæ–°å¢ã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.target.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™
  useEffect(() => {
    loadSchedules();
  }, [loadSchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                å·¥å–®æ’ç¨‹
              </Typography>
            </Box>
            <Button
              variant="contained"
              startIcon={<AddIcon />}
              onClick={() => setCreateDialogOpen(true)}
              size="small"
            >
              æ–°å¢æ’ç¨‹
            </Button>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è¼‰å…¥ä»Šæ—¥æ’ç¨‹
   */
  const loadTodaySchedules = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
      const today = dayjs().format('YYYY-MM-DD');
      
      // è¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
      const response = await TargetService.getSchedulesByDate(today);
      
      if (response.success && response.data) {
        setTodaySchedules(response.data);
        setShowTodaySchedules(true);
      } else {
        setError(response.message || 'è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—');
        setTodaySchedules([]);
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼é¡¯ç¤ºå·¥å–®åç¨±ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥ä»Šæ—¥æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setTodaySchedules([]);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ï¼ˆä»Šæ—¥æ’ç¨‹ / ç›®æ¨™æ’ç¨‹ï¼‰
   */
  const handleToggleView = () => {
    if (showTodaySchedules) {
      // åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼
      setShowTodaySchedules(false);
      if (selectedTarget) {
        loadSchedules();
      }
    } else {
      // åˆ‡æ›åˆ°ä»Šæ—¥æ’ç¨‹æ¨¡å¼
      loadTodaySchedules();
    }
  };

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.target.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™
  useEffect(() => {
    loadSchedules();
  }, [loadSchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                å·¥å–®æ’ç¨‹
              </Typography>
            </Box>
            <Button
              variant="contained"
              startIcon={<AddIcon />}
              onClick={() => setCreateDialogOpen(true)}
              size="small"
            >
              æ–°å¢æ’ç¨‹
            </Button>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

æ›´æ–° UIï¼Œæ–°å¢ã€Œä»Šæ—¥æ’ç¨‹ã€æŒ‰éˆ•ï¼Œä¸¦å¯¦ä½œæŒ‰ç›®æ¨™åˆ†çµ„çš„é¡¯ç¤ºé‚è¼¯ï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è¼‰å…¥ä»Šæ—¥æ’ç¨‹
   */
  const loadTodaySchedules = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
      const today = dayjs().format('YYYY-MM-DD');
      
      // è¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
      const response = await TargetService.getSchedulesByDate(today);
      
      if (response.success && response.data) {
        setTodaySchedules(response.data);
        setShowTodaySchedules(true);
      } else {
        setError(response.message || 'è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—');
        setTodaySchedules([]);
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼é¡¯ç¤ºå·¥å–®åç¨±ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥ä»Šæ—¥æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setTodaySchedules([]);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ï¼ˆä»Šæ—¥æ’ç¨‹ / ç›®æ¨™æ’ç¨‹ï¼‰
   */
  const handleToggleView = () => {
    if (showTodaySchedules) {
      // åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼
      setShowTodaySchedules(false);
      if (selectedTarget) {
        loadSchedules();
      }
    } else {
      // åˆ‡æ›åˆ°ä»Šæ—¥æ’ç¨‹æ¨¡å¼
      loadTodaySchedules();
    }
  };

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.target.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™
  useEffect(() => {
    loadSchedules();
  }, [loadSchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                {showTodaySchedules ? 'ä»Šæ—¥æ’ç¨‹' : 'å·¥å–®æ’ç¨‹'}
              </Typography>
              {showTodaySchedules && (
                <Typography variant="body2" color="text.secondary">
                  {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')}
                </Typography>
              )}
            </Box>
            <Box sx={{ display: 'flex', gap: 1 }}>
              <Button
                variant={showTodaySchedules ? "outlined" : "contained"}
                startIcon={<CalendarIcon />}
                onClick={handleToggleView}
                size="small"
              >
                ä»Šæ—¥æ’ç¨‹
              </Button>
              {!showTodaySchedules && (
                <Button
                  variant="contained"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                  size="small"
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              )}
            </Box>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

æ›´æ–°æ’ç¨‹åˆ—è¡¨é¡¯ç¤ºé‚è¼¯ï¼Œæ”¯æ´æŒ‰ç›®æ¨™åˆ†çµ„çš„ä»Šæ—¥æ’ç¨‹ï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è¼‰å…¥ä»Šæ—¥æ’ç¨‹
   */
  const loadTodaySchedules = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
      const today = dayjs().format('YYYY-MM-DD');
      
      // è¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
      const response = await TargetService.getSchedulesByDate(today);
      
      if (response.success && response.data) {
        setTodaySchedules(response.data);
        setShowTodaySchedules(true);
      } else {
        setError(response.message || 'è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—');
        setTodaySchedules([]);
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼é¡¯ç¤ºå·¥å–®åç¨±ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥ä»Šæ—¥æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setTodaySchedules([]);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ï¼ˆä»Šæ—¥æ’ç¨‹ / ç›®æ¨™æ’ç¨‹ï¼‰
   */
  const handleToggleView = () => {
    if (showTodaySchedules) {
      // åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼
      setShowTodaySchedules(false);
      if (selectedTarget) {
        loadSchedules();
      }
    } else {
      // åˆ‡æ›åˆ°ä»Šæ—¥æ’ç¨‹æ¨¡å¼
      loadTodaySchedules();
    }
  };

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.target.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™
  useEffect(() => {
    loadSchedules();
  }, [loadSchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                {showTodaySchedules ? 'ä»Šæ—¥æ’ç¨‹' : 'å·¥å–®æ’ç¨‹'}
              </Typography>
              {showTodaySchedules && (
                <Typography variant="body2" color="text.secondary">
                  {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')}
                </Typography>
              )}
            </Box>
            <Box sx={{ display: 'flex', gap: 1 }}>
              <Button
                variant={showTodaySchedules ? "outlined" : "contained"}
                startIcon={<CalendarIcon />}
                onClick={handleToggleView}
                size="small"
              >
                ä»Šæ—¥æ’ç¨‹
              </Button>
              {!showTodaySchedules && (
                <Button
                  variant="contained"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                  size="small"
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              )}
            </Box>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {showTodaySchedules ? (
              // ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼šæŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤º
              todaySchedules.length === 0 ? (
                <Paper sx={{ p: 4, textAlign: 'center' }}>
                  <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="h6" gutterBottom>
                    ä»Šæ—¥å°šç„¡æ’ç¨‹
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')} æ²’æœ‰ä»»ä½•å·¥å–®æ’ç¨‹
                  </Typography>
                </Paper>
              ) : (
                // æŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
                (() => {
                  // æŒ‰ç›®æ¨™ ID åˆ†çµ„
                  const groupedByTarget = todaySchedules.reduce((acc, schedule) => {
                    const targetId = schedule.targetId;
                    if (!acc[targetId]) {
                      acc[targetId] = {
                        target: schedule.target,
                        schedules: [],
                      };
                    }
                    acc[targetId].schedules.push(schedule);
                    return acc;
                  }, {} as Record<string, { target: any; schedules: TicketScheduleWithRelations[] }>);

                  return (
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
                      {Object.values(groupedByTarget).map((group, index) => (
                        <Card key={group.target.id} sx={{ border: 1, borderColor: 'divider' }}>
                          <CardContent>
                            <Typography variant="h6" gutterBottom sx={{ mb: 2, pb: 1, borderBottom: 1, borderColor: 'divider' }}>
                              {group.target.name}
                            </Typography>
                            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                              {group.schedules.map((schedule) => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                return (
                                  <Card 
                                    key={schedule.id}
                                    sx={{ 
                                      backgroundColor: 'background.paper',
                                      '&:hover': { 
                                        boxShadow: 2,
                                        cursor: 'pointer' 
                                      } 
                                    }}
                                    onClick={() => ticket && onTicketSelect(ticket)}
                                  >
                                    <CardContent>
                                      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <Box sx={{ flex: 1 }}>
                                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                            <Typography variant="h6" component="div">
                                              {ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®'}
                                            </Typography>
                                            <Chip
                                              icon={getStatusIcon(schedule.status)}
                                              label={getStatusText(schedule.status)}
                                              color={getStatusColor(schedule.status)}
                                              size="small"
                                            />
                                            <Chip
                                              icon={getPriorityIcon(schedule.priority)}
                                              label={getPriorityText(schedule.priority)}
                                              color={getPriorityColor(schedule.priority)}
                                              size="small"
                                            />
                                          </Box>
                                          <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
                                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                              <CalendarIcon fontSize="small" color="action" />
                                              <Typography variant="body2" color="text.secondary">
                                                {schedule.scheduledDate}
                                              </Typography>
                                            </Box>
                                            {schedule.scheduledTime && (
                                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                                <TimeIcon fontSize="small" color="action" />
                                                <Typography variant="body2" color="text.secondary">
                                                  {schedule.scheduledTime}
                                                </Typography>
                                              </Box>
                                            )}
                                          </Box>
                                        </Box>
                                        <Box sx={{ display: 'flex', gap: 1 }}>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setEditingSchedule(schedule);
                                              setEditDialogOpen(true);
                                            }}
                                          >
                                            <EditIcon fontSize="small" />
                                          </IconButton>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleDeleteSchedule(schedule.id);
                                            }}
                                          >
                                            <DeleteIcon fontSize="small" />
                                          </IconButton>
                                        </Box>
                                      </Box>
                                    </CardContent>
                                  </Card>
                                );
                              })}
                            </Box>
                          </CardContent>
                        </Card>
                      ))}
                    </Box>
                  );
                })()
              )
            ) : schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

æ›´æ–°åˆªé™¤æ’ç¨‹å‡½æ•¸ï¼Œä½¿å…¶åœ¨ä»Šæ—¥æ’ç¨‹æ¨¡å¼ä¸‹ä¹Ÿèƒ½æ­£ç¢ºæ›´æ–°ï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è¼‰å…¥ä»Šæ—¥æ’ç¨‹
   */
  const loadTodaySchedules = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
      const today = dayjs().format('YYYY-MM-DD');
      
      // è¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
      const response = await TargetService.getSchedulesByDate(today);
      
      if (response.success && response.data) {
        setTodaySchedules(response.data);
        setShowTodaySchedules(true);
      } else {
        setError(response.message || 'è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—');
        setTodaySchedules([]);
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼é¡¯ç¤ºå·¥å–®åç¨±ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥ä»Šæ—¥æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setTodaySchedules([]);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ï¼ˆä»Šæ—¥æ’ç¨‹ / ç›®æ¨™æ’ç¨‹ï¼‰
   */
  const handleToggleView = () => {
    if (showTodaySchedules) {
      // åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼
      setShowTodaySchedules(false);
      if (selectedTarget) {
        loadSchedules();
      }
    } else {
      // åˆ‡æ›åˆ°ä»Šæ—¥æ’ç¨‹æ¨¡å¼
      loadTodaySchedules();
    }
  };

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.target.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        if (showTodaySchedules) {
          // æ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
          setTodaySchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        } else {
          // æ›´æ–°ç›®æ¨™æ’ç¨‹åˆ—è¡¨
          setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        }
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™
  useEffect(() => {
    loadSchedules();
  }, [loadSchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                {showTodaySchedules ? 'ä»Šæ—¥æ’ç¨‹' : 'å·¥å–®æ’ç¨‹'}
              </Typography>
              {showTodaySchedules && (
                <Typography variant="body2" color="text.secondary">
                  {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')}
                </Typography>
              )}
            </Box>
            <Box sx={{ display: 'flex', gap: 1 }}>
              <Button
                variant={showTodaySchedules ? "outlined" : "contained"}
                startIcon={<CalendarIcon />}
                onClick={handleToggleView}
                size="small"
              >
                ä»Šæ—¥æ’ç¨‹
              </Button>
              {!showTodaySchedules && (
                <Button
                  variant="contained"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                  size="small"
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              )}
            </Box>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {showTodaySchedules ? (
              // ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼šæŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤º
              todaySchedules.length === 0 ? (
                <Paper sx={{ p: 4, textAlign: 'center' }}>
                  <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="h6" gutterBottom>
                    ä»Šæ—¥å°šç„¡æ’ç¨‹
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')} æ²’æœ‰ä»»ä½•å·¥å–®æ’ç¨‹
                  </Typography>
                </Paper>
              ) : (
                // æŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
                (() => {
                  // æŒ‰ç›®æ¨™ ID åˆ†çµ„
                  const groupedByTarget = todaySchedules.reduce((acc, schedule) => {
                    const targetId = schedule.targetId;
                    if (!acc[targetId]) {
                      acc[targetId] = {
                        target: schedule.target,
                        schedules: [],
                      };
                    }
                    acc[targetId].schedules.push(schedule);
                    return acc;
                  }, {} as Record<string, { target: any; schedules: TicketScheduleWithRelations[] }>);

                  return (
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
                      {Object.values(groupedByTarget).map((group, index) => (
                        <Card key={group.target.id} sx={{ border: 1, borderColor: 'divider' }}>
                          <CardContent>
                            <Typography variant="h6" gutterBottom sx={{ mb: 2, pb: 1, borderBottom: 1, borderColor: 'divider' }}>
                              {group.target.name}
                            </Typography>
                            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                              {group.schedules.map((schedule) => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                return (
                                  <Card 
                                    key={schedule.id}
                                    sx={{ 
                                      backgroundColor: 'background.paper',
                                      '&:hover': { 
                                        boxShadow: 2,
                                        cursor: 'pointer' 
                                      } 
                                    }}
                                    onClick={() => ticket && onTicketSelect(ticket)}
                                  >
                                    <CardContent>
                                      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <Box sx={{ flex: 1 }}>
                                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                            <Typography variant="h6" component="div">
                                              {ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®'}
                                            </Typography>
                                            <Chip
                                              icon={getStatusIcon(schedule.status)}
                                              label={getStatusText(schedule.status)}
                                              color={getStatusColor(schedule.status)}
                                              size="small"
                                            />
                                            <Chip
                                              icon={getPriorityIcon(schedule.priority)}
                                              label={getPriorityText(schedule.priority)}
                                              color={getPriorityColor(schedule.priority)}
                                              size="small"
                                            />
                                          </Box>
                                          <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
                                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                              <CalendarIcon fontSize="small" color="action" />
                                              <Typography variant="body2" color="text.secondary">
                                                {schedule.scheduledDate}
                                              </Typography>
                                            </Box>
                                            {schedule.scheduledTime && (
                                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                                <TimeIcon fontSize="small" color="action" />
                                                <Typography variant="body2" color="text.secondary">
                                                  {schedule.scheduledTime}
                                                </Typography>
                                              </Box>
                                            )}
                                          </Box>
                                        </Box>
                                        <Box sx={{ display: 'flex', gap: 1 }}>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setEditingSchedule(schedule);
                                              setEditDialogOpen(true);
                                            }}
                                          >
                                            <EditIcon fontSize="small" />
                                          </IconButton>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleDeleteSchedule(schedule.id);
                                            }}
                                          >
                                            <DeleteIcon fontSize="small" />
                                          </IconButton>
                                        </Box>
                                      </Box>
                                    </CardContent>
                                  </Card>
                                );
                              })}
                            </Box>
                          </CardContent>
                        </Card>
                      ))}
                    </Box>
                  );
                })()
              )
            ) : schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

æ›´æ–°æ–°å¢æ’ç¨‹å‡½æ•¸ï¼Œç¢ºä¿åœ¨æ–°å¢ä»Šæ—¥æ’ç¨‹å¾Œæ­£ç¢ºæ›´æ–°åˆ—è¡¨ï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è¼‰å…¥ä»Šæ—¥æ’ç¨‹
   */
  const loadTodaySchedules = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
      const today = dayjs().format('YYYY-MM-DD');
      
      // è¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
      const response = await TargetService.getSchedulesByDate(today);
      
      if (response.success && response.data) {
        setTodaySchedules(response.data);
        setShowTodaySchedules(true);
      } else {
        setError(response.message || 'è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—');
        setTodaySchedules([]);
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼é¡¯ç¤ºå·¥å–®åç¨±ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥ä»Šæ—¥æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setTodaySchedules([]);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ï¼ˆä»Šæ—¥æ’ç¨‹ / ç›®æ¨™æ’ç¨‹ï¼‰
   */
  const handleToggleView = () => {
    if (showTodaySchedules) {
      // åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼
      setShowTodaySchedules(false);
      if (selectedTarget) {
        loadSchedules();
      }
    } else {
      // åˆ‡æ›åˆ°ä»Šæ—¥æ’ç¨‹æ¨¡å¼
      loadTodaySchedules();
    }
  };

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœæ–°æ’ç¨‹æ˜¯ä»Šæ—¥çš„ï¼Œä¸”ç•¶å‰è™•æ–¼ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼Œæ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
        const today = dayjs().format('YYYY-MM-DD');
        if (showTodaySchedules && response.data.scheduledDate === today) {
          setTodaySchedules(prev => [...prev, response.data!]);
        }
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        if (showTodaySchedules) {
          // æ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
          setTodaySchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        } else {
          // æ›´æ–°ç›®æ¨™æ’ç¨‹åˆ—è¡¨
          setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        }
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™
  useEffect(() => {
    loadSchedules();
  }, [loadSchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                {showTodaySchedules ? 'ä»Šæ—¥æ’ç¨‹' : 'å·¥å–®æ’ç¨‹'}
              </Typography>
              {showTodaySchedules && (
                <Typography variant="body2" color="text.secondary">
                  {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')}
                </Typography>
              )}
            </Box>
            <Box sx={{ display: 'flex', gap: 1 }}>
              <Button
                variant={showTodaySchedules ? "outlined" : "contained"}
                startIcon={<CalendarIcon />}
                onClick={handleToggleView}
                size="small"
              >
                ä»Šæ—¥æ’ç¨‹
              </Button>
              {!showTodaySchedules && (
                <Button
                  variant="contained"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                  size="small"
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              )}
            </Box>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {showTodaySchedules ? (
              // ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼šæŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤º
              todaySchedules.length === 0 ? (
                <Paper sx={{ p: 4, textAlign: 'center' }}>
                  <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="h6" gutterBottom>
                    ä»Šæ—¥å°šç„¡æ’ç¨‹
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')} æ²’æœ‰ä»»ä½•å·¥å–®æ’ç¨‹
                  </Typography>
                </Paper>
              ) : (
                // æŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
                (() => {
                  // æŒ‰ç›®æ¨™ ID åˆ†çµ„
                  const groupedByTarget = todaySchedules.reduce((acc, schedule) => {
                    const targetId = schedule.targetId;
                    if (!acc[targetId]) {
                      acc[targetId] = {
                        target: schedule.target,
                        schedules: [],
                      };
                    }
                    acc[targetId].schedules.push(schedule);
                    return acc;
                  }, {} as Record<string, { target: any; schedules: TicketScheduleWithRelations[] }>);

                  return (
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
                      {Object.values(groupedByTarget).map((group, index) => (
                        <Card key={group.target.id} sx={{ border: 1, borderColor: 'divider' }}>
                          <CardContent>
                            <Typography variant="h6" gutterBottom sx={{ mb: 2, pb: 1, borderBottom: 1, borderColor: 'divider' }}>
                              {group.target.name}
                            </Typography>
                            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                              {group.schedules.map((schedule) => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                return (
                                  <Card 
                                    key={schedule.id}
                                    sx={{ 
                                      backgroundColor: 'background.paper',
                                      '&:hover': { 
                                        boxShadow: 2,
                                        cursor: 'pointer' 
                                      } 
                                    }}
                                    onClick={() => ticket && onTicketSelect(ticket)}
                                  >
                                    <CardContent>
                                      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <Box sx={{ flex: 1 }}>
                                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                            <Typography variant="h6" component="div">
                                              {ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®'}
                                            </Typography>
                                            <Chip
                                              icon={getStatusIcon(schedule.status)}
                                              label={getStatusText(schedule.status)}
                                              color={getStatusColor(schedule.status)}
                                              size="small"
                                            />
                                            <Chip
                                              icon={getPriorityIcon(schedule.priority)}
                                              label={getPriorityText(schedule.priority)}
                                              color={getPriorityColor(schedule.priority)}
                                              size="small"
                                            />
                                          </Box>
                                          <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
                                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                              <CalendarIcon fontSize="small" color="action" />
                                              <Typography variant="body2" color="text.secondary">
                                                {schedule.scheduledDate}
                                              </Typography>
                                            </Box>
                                            {schedule.scheduledTime && (
                                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                                <TimeIcon fontSize="small" color="action" />
                                                <Typography variant="body2" color="text.secondary">
                                                  {schedule.scheduledTime}
                                                </Typography>
                                              </Box>
                                            )}
                                          </Box>
                                        </Box>
                                        <Box sx={{ display: 'flex', gap: 1 }}>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setEditingSchedule(schedule);
                                              setEditDialogOpen(true);
                                            }}
                                          >
                                            <EditIcon fontSize="small" />
                                          </IconButton>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleDeleteSchedule(schedule.id);
                                            }}
                                          >
                                            <DeleteIcon fontSize="small" />
                                          </IconButton>
                                        </Box>
                                      </Box>
                                    </CardContent>
                                  </Card>
                                );
                              })}
                            </Box>
                          </CardContent>
                        </Card>
                      ))}
                    </Box>
                  );
                })()
              )
            ) : schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

æª¢æŸ¥ä¸¦æ›´æ–° useEffectï¼Œç¢ºä¿åœ¨ç›®æ¨™æ”¹è®Šæ™‚æ­£ç¢ºè™•ç†ï¼š


æ›´æ–° useEffectï¼Œç¢ºä¿åœ¨ç›®æ¨™æ”¹è®Šæ™‚æ­£ç¢ºè™•ç†ï¼Œä¸¦æª¢æŸ¥èªæ³•éŒ¯èª¤ï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è¼‰å…¥ä»Šæ—¥æ’ç¨‹
   */
  const loadTodaySchedules = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
      const today = dayjs().format('YYYY-MM-DD');
      
      // è¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
      const response = await TargetService.getSchedulesByDate(today);
      
      if (response.success && response.data) {
        setTodaySchedules(response.data);
        setShowTodaySchedules(true);
      } else {
        setError(response.message || 'è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—');
        setTodaySchedules([]);
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼é¡¯ç¤ºå·¥å–®åç¨±ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥ä»Šæ—¥æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setTodaySchedules([]);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ï¼ˆä»Šæ—¥æ’ç¨‹ / ç›®æ¨™æ’ç¨‹ï¼‰
   */
  const handleToggleView = () => {
    if (showTodaySchedules) {
      // åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼
      setShowTodaySchedules(false);
      if (selectedTarget) {
        loadSchedules();
      }
    } else {
      // åˆ‡æ›åˆ°ä»Šæ—¥æ’ç¨‹æ¨¡å¼
      loadTodaySchedules();
    }
  };

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœæ–°æ’ç¨‹æ˜¯ä»Šæ—¥çš„ï¼Œä¸”ç•¶å‰è™•æ–¼ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼Œæ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
        const today = dayjs().format('YYYY-MM-DD');
        if (showTodaySchedules && response.data.scheduledDate === today) {
          setTodaySchedules(prev => [...prev, response.data!]);
        }
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        if (showTodaySchedules) {
          // æ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
          setTodaySchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        } else {
          // æ›´æ–°ç›®æ¨™æ’ç¨‹åˆ—è¡¨
          setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        }
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™ï¼ˆåƒ…åœ¨éä»Šæ—¥æ’ç¨‹æ¨¡å¼ä¸‹ï¼‰
  useEffect(() => {
    if (!showTodaySchedules && selectedTarget) {
      loadSchedules();
    }
  }, [selectedTarget, showTodaySchedules, loadSchedules]);
  
  // ç•¶åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼æ™‚ï¼Œé‡ç½®ä»Šæ—¥æ’ç¨‹ç‹€æ…‹
  useEffect(() => {
    if (!showTodaySchedules) {
      setTodaySchedules([]);
    }
  }, [showTodaySchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                {showTodaySchedules ? 'ä»Šæ—¥æ’ç¨‹' : 'å·¥å–®æ’ç¨‹'}
              </Typography>
              {showTodaySchedules && (
                <Typography variant="body2" color="text.secondary">
                  {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')}
                </Typography>
              )}
            </Box>
            <Box sx={{ display: 'flex', gap: 1 }}>
              <Button
                variant={showTodaySchedules ? "outlined" : "contained"}
                startIcon={<CalendarIcon />}
                onClick={handleToggleView}
                size="small"
              >
                ä»Šæ—¥æ’ç¨‹
              </Button>
              {!showTodaySchedules && (
                <Button
                  variant="contained"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                  size="small"
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              )}
            </Box>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {showTodaySchedules ? (
              // ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼šæŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤º
              todaySchedules.length === 0 ? (
                <Paper sx={{ p: 4, textAlign: 'center' }}>
                  <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="h6" gutterBottom>
                    ä»Šæ—¥å°šç„¡æ’ç¨‹
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')} æ²’æœ‰ä»»ä½•å·¥å–®æ’ç¨‹
                  </Typography>
                </Paper>
              ) : (
                // æŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
                (() => {
                  // æŒ‰ç›®æ¨™ ID åˆ†çµ„
                  const groupedByTarget = todaySchedules.reduce((acc, schedule) => {
                    const targetId = schedule.targetId;
                    if (!acc[targetId]) {
                      acc[targetId] = {
                        target: schedule.target,
                        schedules: [],
                      };
                    }
                    acc[targetId].schedules.push(schedule);
                    return acc;
                  }, {} as Record<string, { target: any; schedules: TicketScheduleWithRelations[] }>);

                  return (
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
                      {Object.values(groupedByTarget).map((group, index) => (
                        <Card key={group.target.id} sx={{ border: 1, borderColor: 'divider' }}>
                          <CardContent>
                            <Typography variant="h6" gutterBottom sx={{ mb: 2, pb: 1, borderBottom: 1, borderColor: 'divider' }}>
                              {group.target.name}
                            </Typography>
                            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                              {group.schedules.map((schedule) => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                return (
                                  <Card 
                                    key={schedule.id}
                                    sx={{ 
                                      backgroundColor: 'background.paper',
                                      '&:hover': { 
                                        boxShadow: 2,
                                        cursor: 'pointer' 
                                      } 
                                    }}
                                    onClick={() => ticket && onTicketSelect(ticket)}
                                  >
                                    <CardContent>
                                      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <Box sx={{ flex: 1 }}>
                                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                            <Typography variant="h6" component="div">
                                              {ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®'}
                                            </Typography>
                                            <Chip
                                              icon={getStatusIcon(schedule.status)}
                                              label={getStatusText(schedule.status)}
                                              color={getStatusColor(schedule.status)}
                                              size="small"
                                            />
                                            <Chip
                                              icon={getPriorityIcon(schedule.priority)}
                                              label={getPriorityText(schedule.priority)}
                                              color={getPriorityColor(schedule.priority)}
                                              size="small"
                                            />
                                          </Box>
                                          <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
                                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                              <CalendarIcon fontSize="small" color="action" />
                                              <Typography variant="body2" color="text.secondary">
                                                {schedule.scheduledDate}
                                              </Typography>
                                            </Box>
                                            {schedule.scheduledTime && (
                                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                                <TimeIcon fontSize="small" color="action" />
                                                <Typography variant="body2" color="text.secondary">
                                                  {schedule.scheduledTime}
                                                </Typography>
                                              </Box>
                                            )}
                                          </Box>
                                        </Box>
                                        <Box sx={{ display: 'flex', gap: 1 }}>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setEditingSchedule(schedule);
                                              setEditDialogOpen(true);
                                            }}
                                          >
                                            <EditIcon fontSize="small" />
                                          </IconButton>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleDeleteSchedule(schedule.id);
                                            }}
                                          >
                                            <DeleteIcon fontSize="small" />
                                          </IconButton>
                                        </Box>
                                      </Box>
                                    </CardContent>
                                  </Card>
                                );
                              })}
                            </Box>
                          </CardContent>
                        </Card>
                      ))}
                    </Box>
                  );
                })()
              )
            ) : schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

ä¿®æ­£é¡å‹éŒ¯èª¤ï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è¼‰å…¥ä»Šæ—¥æ’ç¨‹
   */
  const loadTodaySchedules = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
      const today = dayjs().format('YYYY-MM-DD');
      
      // è¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
      const response = await TargetService.getSchedulesByDate(today);
      
      if (response.success && response.data) {
        setTodaySchedules(response.data);
        setShowTodaySchedules(true);
      } else {
        setError(response.message || 'è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—');
        setTodaySchedules([]);
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼é¡¯ç¤ºå·¥å–®åç¨±ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥ä»Šæ—¥æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setTodaySchedules([]);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ï¼ˆä»Šæ—¥æ’ç¨‹ / ç›®æ¨™æ’ç¨‹ï¼‰
   */
  const handleToggleView = () => {
    if (showTodaySchedules) {
      // åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼
      setShowTodaySchedules(false);
      if (selectedTarget) {
        loadSchedules();
      }
    } else {
      // åˆ‡æ›åˆ°ä»Šæ—¥æ’ç¨‹æ¨¡å¼
      loadTodaySchedules();
    }
  };

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœæ–°æ’ç¨‹æ˜¯ä»Šæ—¥çš„ï¼Œä¸”ç•¶å‰è™•æ–¼ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼Œæ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
        const today = dayjs().format('YYYY-MM-DD');
        if (showTodaySchedules && response.data.scheduledDate === today) {
          setTodaySchedules(prev => [...prev, response.data!]);
        }
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.target.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        if (showTodaySchedules) {
          // æ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
          setTodaySchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        } else {
          // æ›´æ–°ç›®æ¨™æ’ç¨‹åˆ—è¡¨
          setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        }
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™ï¼ˆåƒ…åœ¨éä»Šæ—¥æ’ç¨‹æ¨¡å¼ä¸‹ï¼‰
  useEffect(() => {
    if (!showTodaySchedules && selectedTarget) {
      loadSchedules();
    }
  }, [selectedTarget, showTodaySchedules, loadSchedules]);
  
  // ç•¶åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼æ™‚ï¼Œé‡ç½®ä»Šæ—¥æ’ç¨‹ç‹€æ…‹
  useEffect(() => {
    if (!showTodaySchedules) {
      setTodaySchedules([]);
    }
  }, [showTodaySchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary">
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                {showTodaySchedules ? 'ä»Šæ—¥æ’ç¨‹' : 'å·¥å–®æ’ç¨‹'}
              </Typography>
              {showTodaySchedules && (
                <Typography variant="body2" color="text.secondary">
                  {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')}
                </Typography>
              )}
            </Box>
            <Box sx={{ display: 'flex', gap: 1 }}>
              <Button
                variant={showTodaySchedules ? "outlined" : "contained"}
                startIcon={<CalendarIcon />}
                onClick={handleToggleView}
                size="small"
              >
                ä»Šæ—¥æ’ç¨‹
              </Button>
              {!showTodaySchedules && (
                <Button
                  variant="contained"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                  size="small"
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              )}
            </Box>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {showTodaySchedules ? (
              // ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼šæŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤º
              todaySchedules.length === 0 ? (
                <Paper sx={{ p: 4, textAlign: 'center' }}>
                  <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="h6" gutterBottom>
                    ä»Šæ—¥å°šç„¡æ’ç¨‹
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')} æ²’æœ‰ä»»ä½•å·¥å–®æ’ç¨‹
                  </Typography>
                </Paper>
              ) : (
                // æŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
                (() => {
                  // æŒ‰ç›®æ¨™ ID åˆ†çµ„
                  const groupedByTarget = todaySchedules.reduce((acc, schedule) => {
                    const targetId = schedule.targetId;
                    if (!acc[targetId]) {
                      acc[targetId] = {
                        target: schedule.target,
                        schedules: [],
                      };
                    }
                    acc[targetId].schedules.push(schedule);
                    return acc;
                  }, {} as Record<string, { target: any; schedules: TicketScheduleWithRelations[] }>);

                  return (
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
                      {Object.values(groupedByTarget).map((group, index) => (
                        <Card key={group.target.id} sx={{ border: 1, borderColor: 'divider' }}>
                          <CardContent>
                            <Typography variant="h6" gutterBottom sx={{ mb: 2, pb: 1, borderBottom: 1, borderColor: 'divider' }}>
                              {group.target.name}
                            </Typography>
                            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                              {group.schedules.map((schedule) => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                return (
                                  <Card 
                                    key={schedule.id}
                                    sx={{ 
                                      backgroundColor: 'background.paper',
                                      '&:hover': { 
                                        boxShadow: 2,
                                        cursor: 'pointer' 
                                      } 
                                    }}
                                    onClick={() => ticket && onTicketSelect(ticket)}
                                  >
                                    <CardContent>
                                      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <Box sx={{ flex: 1 }}>
                                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                            <Typography variant="h6" component="div">
                                              {ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®'}
                                            </Typography>
                                            <Chip
                                              icon={getStatusIcon(schedule.status)}
                                              label={getStatusText(schedule.status)}
                                              color={getStatusColor(schedule.status)}
                                              size="small"
                                            />
                                            <Chip
                                              icon={getPriorityIcon(schedule.priority)}
                                              label={getPriorityText(schedule.priority)}
                                              color={getPriorityColor(schedule.priority)}
                                              size="small"
                                            />
                                          </Box>
                                          <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
                                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                              <CalendarIcon fontSize="small" color="action" />
                                              <Typography variant="body2" color="text.secondary">
                                                {schedule.scheduledDate}
                                              </Typography>
                                            </Box>
                                            {schedule.scheduledTime && (
                                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                                <TimeIcon fontSize="small" color="action" />
                                                <Typography variant="body2" color="text.secondary">
                                                  {schedule.scheduledTime}
                                                </Typography>
                                              </Box>
                                            )}
                                          </Box>
                                        </Box>
                                        <Box sx={{ display: 'flex', gap: 1 }}>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setEditingSchedule(schedule);
                                              setEditDialogOpen(true);
                                            }}
                                          >
                                            <EditIcon fontSize="small" />
                                          </IconButton>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleDeleteSchedule(schedule.id);
                                            }}
                                          >
                                            <DeleteIcon fontSize="small" />
                                          </IconButton>
                                        </Box>
                                      </Box>
                                    </CardContent>
                                  </Card>
                                );
                              })}
                            </Box>
                          </CardContent>
                        </Card>
                      ))}
                    </Box>
                  );
                })()
              )
            ) : schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

èª¿æ•´é‚è¼¯ï¼Œå…è¨±åœ¨ä»Šæ—¥æ’ç¨‹æ¨¡å¼ä¸‹å³ä½¿æ²’æœ‰é¸ä¸­ç›®æ¨™ä¹Ÿèƒ½é¡¯ç¤ºï¼š


```typescriptreact
import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  IconButton,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Alert,
  CircularProgress,
  Paper,
  Divider,
  Tooltip,
  Badge,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Avatar,
} from '@mui/material';
import {
  Schedule as ScheduleIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Visibility as ViewIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  PlayArrow as PlayArrowIcon,
  Warning as WarningIcon,
  CalendarToday as CalendarIcon,
  AccessTime as TimeIcon,
  PriorityHigh as HighPriorityIcon,
  Circle as MediumPriorityIcon,
  LowPriority as LowPriorityIcon,
  PhotoCamera,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import 'dayjs/locale/zh-tw';

import { ProductionTarget, TicketSchedule, TicketScheduleWithRelations, CreateScheduleRequest, UpdateScheduleRequest, TargetStatus } from '../types/target';
import { Ticket } from '../types/ticket';
import { TargetService } from '../services/targetApi';
import { TicketService } from '../services/api';
import { formatTicketDisplay, getStationDisplay, getTicketName } from '../utils/stationMapping';

// å·¥å–®æ’ç¨‹å…ƒä»¶å±¬æ€§ä»‹é¢
interface TicketScheduleProps {
  selectedTarget: ProductionTarget | null; // é¸ä¸­çš„é ç”Ÿç”¢ç›®æ¨™
  onTicketSelect: (ticket: Ticket) => void; // å·¥å–®é¸æ“‡å›èª¿å‡½æ•¸
  onTargetUpdate?: (targetId: string, updatedTarget: ProductionTarget) => void; // ç›®æ¨™æ›´æ–°å›èª¿å‡½æ•¸
}

// å·¥å–®æ’ç¨‹å…ƒä»¶
const TicketScheduleComponent: React.FC<TicketScheduleProps> = ({ 
  selectedTarget, 
  onTicketSelect,
  onTargetUpdate
}) => {
  // ç‹€æ…‹ç®¡ç†
  const [schedules, setSchedules] = useState<TicketSchedule[]>([]);
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showTodaySchedules, setShowTodaySchedules] = useState(false); // æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
  const [todaySchedules, setTodaySchedules] = useState<TicketScheduleWithRelations[]>([]); // ä»Šæ—¥æ’ç¨‹è³‡æ–™
  
  // å°è©±æ¡†ç‹€æ…‹
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<TicketSchedule | null>(null);

  // æ–°å¢æ’ç¨‹è¡¨å–®ç‹€æ…‹
  const [newSchedule, setNewSchedule] = useState<CreateScheduleRequest>({
    ticketId: '',
    targetId: '',
    scheduledDate: '',
    scheduledTime: '',
    priority: 'MEDIUM',
  });

  // è¡¨å–®é©—è­‰éŒ¯èª¤ç‹€æ…‹
  const [formErrors, setFormErrors] = useState<{ [key: string]: string }>({});

  /**
   * è¼‰å…¥å·¥å–®æ’ç¨‹è³‡æ–™
   */
  const loadSchedules = useCallback(async () => {
    if (!selectedTarget) {
      setSchedules([]);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // è¼‰å…¥æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
      const scheduleResponse = await TargetService.getTargetSchedules(selectedTarget.id);
      
      if (scheduleResponse.success && scheduleResponse.data) {
        setSchedules(scheduleResponse.data);
      } else {
        setError(scheduleResponse.message || 'è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—');
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼æ–°å¢æ’ç¨‹æ™‚é¸æ“‡ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  }, [selectedTarget]);

  /**
   * è¼‰å…¥ä»Šæ—¥æ’ç¨‹
   */
  const loadTodaySchedules = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      // å–å¾—ä»Šå¤©çš„æ—¥æœŸï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
      const today = dayjs().format('YYYY-MM-DD');
      
      // è¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
      const response = await TargetService.getSchedulesByDate(today);
      
      if (response.success && response.data) {
        setTodaySchedules(response.data);
        setShowTodaySchedules(true);
      } else {
        setError(response.message || 'è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—');
        setTodaySchedules([]);
      }

      // è¼‰å…¥æ‰€æœ‰å·¥å–®ï¼ˆç”¨æ–¼é¡¯ç¤ºå·¥å–®åç¨±ï¼‰
      const ticketResponse = await TicketService.getTickets();
      
      if (ticketResponse.success && ticketResponse.data) {
        setTickets(ticketResponse.data.tickets);
      }
    } catch (error: any) {
      console.error('è¼‰å…¥ä»Šæ—¥æ’ç¨‹éŒ¯èª¤:', error);
      setError('è¼‰å…¥ä»Šæ—¥æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setTodaySchedules([]);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼ï¼ˆä»Šæ—¥æ’ç¨‹ / ç›®æ¨™æ’ç¨‹ï¼‰
   */
  const handleToggleView = () => {
    if (showTodaySchedules) {
      // åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼
      setShowTodaySchedules(false);
      if (selectedTarget) {
        loadSchedules();
      }
    } else {
      // åˆ‡æ›åˆ°ä»Šæ—¥æ’ç¨‹æ¨¡å¼
      loadTodaySchedules();
    }
  };

  /**
   * è™•ç†æ–°å¢æ’ç¨‹
   */
  const handleCreateSchedule = async () => {
    // è¡¨å–®é©—è­‰
    const errors: { [key: string]: string } = {};
    if (!newSchedule.ticketId) {
      errors.ticketId = 'è«‹é¸æ“‡å·¥å–®';
    }
    if (!newSchedule.scheduledDate) {
      errors.scheduledDate = 'è«‹é¸æ“‡æ’ç¨‹æ—¥æœŸ';
    }

    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }

    try {
      // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
      const scheduleData: any = {
        ticketId: newSchedule.ticketId,
        targetId: selectedTarget!.id,
        scheduledDate: newSchedule.scheduledDate,
      };
      
      // å¯é¸æ¬„ä½
      if (newSchedule.scheduledTime) {
        scheduleData.scheduledTime = newSchedule.scheduledTime;
      }
      if (newSchedule.priority) {
        scheduleData.priority = newSchedule.priority;
      }
      
      // èª¿è©¦ï¼šé¡¯ç¤ºè¦ç™¼é€çš„è³‡æ–™
      console.log('æº–å‚™å»ºç«‹æ’ç¨‹è³‡æ–™:', scheduleData);
      console.log('å¯ç”¨å·¥å–®åˆ—è¡¨:', tickets);
      console.log('åŸå§‹ newSchedule:', newSchedule);
      
      const response = await TargetService.createSchedule(scheduleData);

      if (response.success && response.data) {
        setSchedules(prev => [...prev, response.data!]);
        
        // å¦‚æœæ–°æ’ç¨‹æ˜¯ä»Šæ—¥çš„ï¼Œä¸”ç•¶å‰è™•æ–¼ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼Œæ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
        const today = dayjs().format('YYYY-MM-DD');
        if (showTodaySchedules && response.data.scheduledDate === today) {
          setTodaySchedules(prev => [...prev, response.data!]);
        }
        
        // å¦‚æœç›®æ¨™ç‹€æ…‹è¢«è‡ªå‹•æ›´æ–°ç‚ºã€Œé€²è¡Œä¸­ã€ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶
        if (response.data.target && response.data.target.status === TargetStatus.IN_PROGRESS && onTargetUpdate) {
          // å°‡ API å›æ‡‰çš„ target è½‰æ›ç‚º ProductionTarget é¡å‹
          const updatedTarget: ProductionTarget = {
            id: response.data.target.id,
            name: response.data.target.name,
            description: response.data.target.description,
            expectedCompletionDate: response.data.target.expectedCompletionDate,
            status: response.data.target.status,
            createdAt: response.data.target.createdAt,
            updatedAt: response.data.target.updatedAt,
          };
          onTargetUpdate(response.data.targetId, updatedTarget);
        }
        
        setCreateDialogOpen(false);
        setNewSchedule({
          ticketId: '',
          targetId: '',
          scheduledDate: '',
          scheduledTime: '',
          priority: 'MEDIUM',
        });
        setFormErrors({});
      } else {
        setError(response.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * è™•ç†åˆªé™¤æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  const handleDeleteSchedule = async (scheduleId: string) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å·¥å–®æ’ç¨‹å—ï¼Ÿ')) {
      return;
    }

    try {
      const response = await TargetService.deleteSchedule(scheduleId);

      if (response.success) {
        if (showTodaySchedules) {
          // æ›´æ–°ä»Šæ—¥æ’ç¨‹åˆ—è¡¨
          setTodaySchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        } else {
          // æ›´æ–°ç›®æ¨™æ’ç¨‹åˆ—è¡¨
          setSchedules(prev => prev.filter(schedule => schedule.id !== scheduleId));
        }
      } else {
        setError(response.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—');
      }
    } catch (error) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
      setError('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šé¡è‰²
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityColor = (priority: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (priority) {
      case 'HIGH':
        return 'error';
      case 'MEDIUM':
        return 'warning';
      case 'LOW':
        return 'info';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šåœ–ç¤º
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'HIGH':
        return <HighPriorityIcon />;
      case 'MEDIUM':
        return <MediumPriorityIcon />;
      case 'LOW':
        return <LowPriorityIcon />;
      default:
        return <MediumPriorityIcon />;
    }
  };

  /**
   * å–å¾—å„ªå…ˆç´šæ–‡å­—
   * @param priority å„ªå…ˆç´š
   */
  const getPriorityText = (priority: string): string => {
    switch (priority) {
      case 'HIGH':
        return 'é«˜';
      case 'MEDIUM':
        return 'ä¸­';
      case 'LOW':
        return 'ä½';
      default:
        return 'æœªçŸ¥';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹é¡è‰²
   * @param status ç‹€æ…‹
   */
  const getStatusColor = (status: string): 'default' | 'primary' | 'secondary' | 'error' | 'info' | 'success' | 'warning' => {
    switch (status) {
      case 'OPEN':
        return 'info';
      case 'IN_PROGRESS':
        return 'primary';
      case 'COMPLETED':
        return 'success';
      case 'CLOSED':
        return 'success';
      case 'CANCELLED':
        return 'error';
      default:
        return 'default';
    }
  };

  /**
   * å–å¾—ç‹€æ…‹åœ–ç¤º
   * @param status ç‹€æ…‹
   */
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'OPEN':
        return <ScheduleIcon />;
      case 'IN_PROGRESS':
        return <PlayArrowIcon />;
      case 'COMPLETED':
      case 'CLOSED':
        return <CheckCircleIcon />;
      case 'CANCELLED':
        return <CancelIcon />;
      default:
        return <WarningIcon />;
    }
  };

  /**
   * å–å¾—ç‹€æ…‹æ–‡å­—
   * @param status ç‹€æ…‹
   */
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'OPEN':
        return 'å¾…è™•ç†';
      case 'IN_PROGRESS':
        return 'é€²è¡Œä¸­';
      case 'COMPLETED':
        return 'å·²å®Œæˆ';
      case 'CLOSED':
        return 'å·²é—œé–‰';
      case 'CANCELLED':
        return 'å·²å–æ¶ˆ';
      default:
        return 'æœªçŸ¥ç‹€æ…‹';
    }
  };

  // ç•¶é¸ä¸­ç›®æ¨™è®Šæ›´æ™‚è¼‰å…¥æ’ç¨‹è³‡æ–™ï¼ˆåƒ…åœ¨éä»Šæ—¥æ’ç¨‹æ¨¡å¼ä¸‹ï¼‰
  useEffect(() => {
    if (!showTodaySchedules && selectedTarget) {
      loadSchedules();
    }
  }, [selectedTarget, showTodaySchedules, loadSchedules]);
  
  // ç•¶åˆ‡æ›å›ç›®æ¨™æ’ç¨‹æ¨¡å¼æ™‚ï¼Œé‡ç½®ä»Šæ—¥æ’ç¨‹ç‹€æ…‹
  useEffect(() => {
    if (!showTodaySchedules) {
      setTodaySchedules([]);
    }
  }, [showTodaySchedules]);

  // å¦‚æœæ²’æœ‰é¸ä¸­ç›®æ¨™ä¸”ä¸åœ¨ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
  if (!selectedTarget && !showTodaySchedules) {
    return (
      <Box sx={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Paper sx={{ p: 4, textAlign: 'center', maxWidth: 400 }}>
          <CalendarIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" gutterBottom>
            è«‹é¸æ“‡é ç”Ÿç”¢ç›®æ¨™
          </Typography>
          <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
            å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€å€‹é ç”Ÿç”¢ç›®æ¨™ï¼ŒæŸ¥çœ‹å…¶å·¥å–®æ’ç¨‹
          </Typography>
          <Button
            variant="contained"
            startIcon={<CalendarIcon />}
            onClick={loadTodaySchedules}
          >
            æŸ¥çœ‹ä»Šæ—¥æ’ç¨‹
          </Button>
        </Paper>
      </Box>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDayjs} adapterLocale="zh-tw">
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* æ¨™é¡Œåˆ— */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Box>
              <Typography variant="h6" component="h2" gutterBottom>
                {showTodaySchedules ? 'ä»Šæ—¥æ’ç¨‹' : 'å·¥å–®æ’ç¨‹'}
              </Typography>
              {showTodaySchedules && (
                <Typography variant="body2" color="text.secondary">
                  {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')}
                </Typography>
              )}
            </Box>
            <Box sx={{ display: 'flex', gap: 1 }}>
              <Button
                variant={showTodaySchedules ? "outlined" : "contained"}
                startIcon={<CalendarIcon />}
                onClick={handleToggleView}
                size="small"
              >
                ä»Šæ—¥æ’ç¨‹
              </Button>
              {!showTodaySchedules && (
                <Button
                  variant="contained"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                  size="small"
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              )}
            </Box>
          </Box>
        </Box>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {error && (
          <Alert severity="error" sx={{ m: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* è¼‰å…¥ä¸­ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        )}

        {/* æ’ç¨‹åˆ—è¡¨ */}
        {!loading && (
          <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
            {showTodaySchedules ? (
              // ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼šæŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤º
              todaySchedules.length === 0 ? (
                <Paper sx={{ p: 4, textAlign: 'center' }}>
                  <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="h6" gutterBottom>
                    ä»Šæ—¥å°šç„¡æ’ç¨‹
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {dayjs().format('YYYYå¹´MMæœˆDDæ—¥')} æ²’æœ‰ä»»ä½•å·¥å–®æ’ç¨‹
                  </Typography>
                </Paper>
              ) : (
                // æŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤ºä»Šæ—¥æ’ç¨‹
                (() => {
                  // æŒ‰ç›®æ¨™ ID åˆ†çµ„
                  const groupedByTarget = todaySchedules.reduce((acc, schedule) => {
                    const targetId = schedule.targetId;
                    if (!acc[targetId]) {
                      acc[targetId] = {
                        target: schedule.target,
                        schedules: [],
                      };
                    }
                    acc[targetId].schedules.push(schedule);
                    return acc;
                  }, {} as Record<string, { target: any; schedules: TicketScheduleWithRelations[] }>);

                  return (
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
                      {Object.values(groupedByTarget).map((group, index) => (
                        <Card key={group.target.id} sx={{ border: 1, borderColor: 'divider' }}>
                          <CardContent>
                            <Typography variant="h6" gutterBottom sx={{ mb: 2, pb: 1, borderBottom: 1, borderColor: 'divider' }}>
                              {group.target.name}
                            </Typography>
                            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                              {group.schedules.map((schedule) => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                return (
                                  <Card 
                                    key={schedule.id}
                                    sx={{ 
                                      backgroundColor: 'background.paper',
                                      '&:hover': { 
                                        boxShadow: 2,
                                        cursor: 'pointer' 
                                      } 
                                    }}
                                    onClick={() => ticket && onTicketSelect(ticket)}
                                  >
                                    <CardContent>
                                      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <Box sx={{ flex: 1 }}>
                                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                            <Typography variant="h6" component="div">
                                              {ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®'}
                                            </Typography>
                                            <Chip
                                              icon={getStatusIcon(schedule.status)}
                                              label={getStatusText(schedule.status)}
                                              color={getStatusColor(schedule.status)}
                                              size="small"
                                            />
                                            <Chip
                                              icon={getPriorityIcon(schedule.priority)}
                                              label={getPriorityText(schedule.priority)}
                                              color={getPriorityColor(schedule.priority)}
                                              size="small"
                                            />
                                          </Box>
                                          <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
                                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                              <CalendarIcon fontSize="small" color="action" />
                                              <Typography variant="body2" color="text.secondary">
                                                {schedule.scheduledDate}
                                              </Typography>
                                            </Box>
                                            {schedule.scheduledTime && (
                                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                                <TimeIcon fontSize="small" color="action" />
                                                <Typography variant="body2" color="text.secondary">
                                                  {schedule.scheduledTime}
                                                </Typography>
                                              </Box>
                                            )}
                                          </Box>
                                        </Box>
                                        <Box sx={{ display: 'flex', gap: 1 }}>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              setEditingSchedule(schedule);
                                              setEditDialogOpen(true);
                                            }}
                                          >
                                            <EditIcon fontSize="small" />
                                          </IconButton>
                                          <IconButton
                                            size="small"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleDeleteSchedule(schedule.id);
                                            }}
                                          >
                                            <DeleteIcon fontSize="small" />
                                          </IconButton>
                                        </Box>
                                      </Box>
                                    </CardContent>
                                  </Card>
                                );
                              })}
                            </Box>
                          </CardContent>
                        </Card>
                      ))}
                    </Box>
                  );
                })()
              )
            ) : schedules.length === 0 ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                <Typography variant="h6" gutterBottom>
                  å°šç„¡å·¥å–®æ’ç¨‹
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  é»æ“Šã€Œæ–°å¢æ’ç¨‹ã€æŒ‰éˆ•ç‚ºæ­¤ç›®æ¨™å®‰æ’å·¥å–®
                </Typography>
                <Button
                  variant="outlined"
                  startIcon={<AddIcon />}
                  onClick={() => setCreateDialogOpen(true)}
                >
                  æ–°å¢æ’ç¨‹
                </Button>
              </Paper>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                {schedules.map((schedule) => {
                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                  
                  return (
                    <Box key={schedule.id}>
                      <Card sx={{ 
                        '&:hover': { 
                          boxShadow: 3,
                          cursor: 'pointer' 
                        } 
                      }}>
                        <CardContent>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <Box sx={{ flex: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                                <Typography variant="h6" component="div">
                                  {(() => {
                                    const ticket = tickets.find(t => t.id === schedule.ticketId);
                                    return ticket ? getTicketName(ticket.deviceId) : 'æœªçŸ¥å·¥å–®';
                                  })()}
                                </Typography>
                                <Chip
                                  icon={getStatusIcon(schedule.status)}
                                  label={getStatusText(schedule.status)}
                                  color={getStatusColor(schedule.status)}
                                  size="small"
                                />
                                <Chip
                                  icon={getPriorityIcon(schedule.priority)}
                                  label={getPriorityText(schedule.priority)}
                                  color={getPriorityColor(schedule.priority)}
                                  size="small"
                                />
                              </Box>
                              
                              <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                Station: {(() => {
                                  const ticket = tickets.find(t => t.id === schedule.ticketId);
                                  return ticket ? getStationDisplay(ticket.deviceId) : 'æœªçŸ¥';
                                })()}
                              </Typography>
                              
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <CalendarIcon fontSize="small" />
                                  <Typography variant="body2">
                                    {dayjs(schedule.scheduledDate).format('YYYY-MM-DD')}
                                  </Typography>
                                </Box>
                                {schedule.scheduledTime && (
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <TimeIcon fontSize="small" />
                                    <Typography variant="body2">
                                      {schedule.scheduledTime}
                                    </Typography>
                                  </Box>
                                )}
                              </Box>
                            </Box>
                            
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="æŸ¥çœ‹è©³æƒ…">
                                <IconButton
                                  size="small"
                                  onClick={() => ticket && onTicketSelect(ticket)}
                                >
                                  <ViewIcon />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="ç·¨è¼¯æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => {
                                    setEditingSchedule(schedule);
                                    setEditDialogOpen(true);
                                  }}
                                >
                                  <EditIcon />
                                </IconButton>
                              </Tooltip>
                              {/* å·¥å–®ç…§ç‰‡æŒ‰éˆ• - åªæœ‰AOIå·¥å–®æ‰é¡¯ç¤ºï¼ŒåŒ…å«ä¸Šå‚³å’ŒæŸ¥çœ‹åŠŸèƒ½ */}
                              {(() => {
                                const ticket = tickets.find(t => t.id === schedule.ticketId);
                                // åªå°AOIå·¥å–®é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º
                                return ticket && ticket.deviceId === 'AOI' ? (
                                  <Tooltip title={`${getTicketName(ticket.deviceId)}ç…§ç‰‡ç®¡ç†ï¼ˆä¸Šå‚³/æŸ¥çœ‹ï¼‰`}>
                                    <IconButton
                                      size="small"
                                      onClick={() => {
                                        const photoUrl = `/ticket/${ticket.id}/photos`;
                                        window.open(photoUrl, '_blank');
                                      }}
                                      sx={{ color: 'primary.main' }}
                                    >
                                      <PhotoCamera />
                                    </IconButton>
                                  </Tooltip>
                                ) : null;
                              })()}
                              <Tooltip title="åˆªé™¤æ’ç¨‹">
                                <IconButton
                                  size="small"
                                  onClick={() => handleDeleteSchedule(schedule.id)}
                                >
                                  <DeleteIcon />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </CardContent>
                      </Card>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
        )}

        {/* æ–°å¢æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>æ–°å¢å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                fullWidth
                select
                label="é¸æ“‡å·¥å–®"
                value={newSchedule.ticketId}
                onChange={(e) => setNewSchedule(prev => ({ ...prev, ticketId: e.target.value }))}
                error={!!formErrors.ticketId}
                helperText={formErrors.ticketId}
                required
              >
                {tickets.map((ticket) => (
                  <MenuItem key={ticket.id} value={ticket.id}>
                    <Typography>
                      {getTicketName(ticket.deviceId)}
                    </Typography>
                  </MenuItem>
                ))}
              </TextField>
              
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={newSchedule.scheduledDate ? dayjs(newSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    error: !!formErrors.scheduledDate,
                    helperText: formErrors.scheduledDate,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={newSchedule.scheduledTime ? dayjs(newSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setNewSchedule(prev => ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }))
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={newSchedule.priority}
                onChange={(e) => setNewSchedule(prev => ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }))}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setCreateDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button onClick={handleCreateSchedule} variant="contained">
              å»ºç«‹æ’ç¨‹
            </Button>
          </DialogActions>
        </Dialog>

        {/* ç·¨è¼¯æ’ç¨‹å°è©±æ¡† */}
        <Dialog
          open={editDialogOpen}
          onClose={() => setEditDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ç·¨è¼¯å·¥å–®æ’ç¨‹</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <DatePicker
                label="æ’ç¨‹æ—¥æœŸ"
                value={editingSchedule?.scheduledDate ? dayjs(editingSchedule.scheduledDate) : null}
                onChange={(date: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledDate: date ? date.format('YYYY-MM-DD') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                    required: true,
                  },
                }}
              />
              
              <TimePicker
                label="æ’ç¨‹æ™‚é–“"
                value={editingSchedule?.scheduledTime ? dayjs(editingSchedule.scheduledTime, 'HH:mm') : null}
                onChange={(time: Dayjs | null) => 
                  setEditingSchedule(prev => prev ? ({ 
                    ...prev, 
                    scheduledTime: time ? time.format('HH:mm') : '' 
                  }) : null)
                }
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
              
              <TextField
                fullWidth
                select
                label="å„ªå…ˆç´š"
                value={editingSchedule?.priority || 'MEDIUM'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  priority: e.target.value as 'HIGH' | 'MEDIUM' | 'LOW' 
                }) : null)}
              >
                <MenuItem value="HIGH">é«˜</MenuItem>
                <MenuItem value="MEDIUM">ä¸­</MenuItem>
                <MenuItem value="LOW">ä½</MenuItem>
              </TextField>

              <TextField
                fullWidth
                select
                label="ç‹€æ…‹"
                value={editingSchedule?.status || 'OPEN'}
                onChange={(e) => setEditingSchedule(prev => prev ? ({ 
                  ...prev, 
                  status: e.target.value as 'OPEN' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED' 
                }) : null)}
              >
                <MenuItem value="OPEN">å¾…è™•ç†</MenuItem>
                <MenuItem value="IN_PROGRESS">é€²è¡Œä¸­</MenuItem>
                <MenuItem value="COMPLETED">å·²å®Œæˆ</MenuItem>
                <MenuItem value="CANCELLED">å·²å–æ¶ˆ</MenuItem>
              </TextField>
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setEditDialogOpen(false)}>
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={async () => {
                if (editingSchedule) {
                  // ç¢ºä¿è³‡æ–™æ ¼å¼ç¬¦åˆå¾Œç«¯ API é©—è­‰è¦å‰‡
                  const updateData: any = {};
                  
                  // æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD
                  if (editingSchedule.scheduledDate) {
                    updateData.scheduledDate = editingSchedule.scheduledDate;
                  }
                  
                  // æ™‚é–“æ ¼å¼ï¼šHH:mm
                  if (editingSchedule.scheduledTime) {
                    updateData.scheduledTime = editingSchedule.scheduledTime;
                  }
                  
                  // å„ªå…ˆç´šï¼šHIGH, MEDIUM, LOW
                  if (editingSchedule.priority) {
                    updateData.priority = editingSchedule.priority;
                  }
                  
                  // ç‹€æ…‹ï¼šOPEN, IN_PROGRESS, COMPLETED, CANCELLED
                  if (editingSchedule.status) {
                    updateData.status = editingSchedule.status;
                  }
                  
                  console.log('æº–å‚™æ›´æ–°æ’ç¨‹è³‡æ–™:', updateData);
                  
                  try {
                    const response = await TargetService.updateSchedule(editingSchedule.id, updateData);
                    
                    if (response.success && response.data) {
                      setSchedules(prev => prev.map(schedule => 
                        schedule.id === editingSchedule.id ? response.data! : schedule
                      ));
                      setEditDialogOpen(false);
                      setEditingSchedule(null);
                    } else {
                      setError(response.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—');
                    }
                  } catch (error) {
                    console.error('æ›´æ–°å·¥å–®æ’ç¨‹éŒ¯èª¤:', error);
                    setError('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  }
                }
              }} 
              variant="contained"
            >
              å„²å­˜
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </LocalizationProvider>
  );
};

export default TicketScheduleComponent;

```

å·²å¯¦ä½œã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ã€‚è®Šæ›´å¦‚ä¸‹ï¼š

## å¯¦ä½œç¸½çµï¼š

### 1. **å¾Œç«¯ API** (`server/routes/schedules.js`)
   - åœ¨ GET `/api/schedules` ç«¯é»æ–°å¢æ—¥æœŸç¯©é¸åŠŸèƒ½ï¼Œæ”¯æ´ `date` æŸ¥è©¢åƒæ•¸

### 2. **å‰ç«¯ API æœå‹™** (`client/src/services/targetApi.ts`)
   - æ–°å¢ `getSchedulesByDate()` æ–¹æ³•ï¼Œç”¨æ–¼ç²å–æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰æ’ç¨‹

### 3. **å‰ç«¯çµ„ä»¶** (`client/src/components/TicketSchedule.tsx`)
   - æ–°å¢ã€Œä»Šæ—¥æ’ç¨‹ã€æŒ‰éˆ•
   - æ–°å¢ç‹€æ…‹ç®¡ç†ï¼š
     - `showTodaySchedules`ï¼šæ§åˆ¶æ˜¯å¦é¡¯ç¤ºä»Šæ—¥æ’ç¨‹æ¨¡å¼
     - `todaySchedules`ï¼šå„²å­˜ä»Šæ—¥æ’ç¨‹è³‡æ–™
   - æ–°å¢ `loadTodaySchedules()` å‡½æ•¸ï¼šè¼‰å…¥ä»Šæ—¥æ‰€æœ‰æ’ç¨‹
   - æ–°å¢ `handleToggleView()` å‡½æ•¸ï¼šåœ¨ä»Šæ—¥æ’ç¨‹èˆ‡ç›®æ¨™æ’ç¨‹æ¨¡å¼é–“åˆ‡æ›
   - æŒ‰ç›®æ¨™åˆ†çµ„é¡¯ç¤ºä»Šæ—¥æ’ç¨‹ï¼šå°‡ä»Šæ—¥æ‰€æœ‰æ’ç¨‹ä¾ç›®æ¨™åˆ†çµ„é¡¯ç¤º
   - æ›´æ–°åˆªé™¤èˆ‡æ–°å¢æ’ç¨‹é‚è¼¯ï¼Œç¢ºä¿åœ¨å…©ç¨®æ¨¡å¼ä¸‹éƒ½èƒ½æ­£ç¢ºæ›´æ–°

### åŠŸèƒ½ç‰¹é»ï¼š
- é»æ“Šã€Œä»Šæ—¥æ’ç¨‹ã€æœƒè¼‰å…¥ä»Šæ—¥ï¼ˆä¾‹å¦‚ 11/2ï¼‰çš„æ‰€æœ‰æ’ç¨‹
- æ’ç¨‹ä¾ç”Ÿç”¢ç›®æ¨™åˆ†çµ„é¡¯ç¤ºï¼Œæ¯å€‹ç›®æ¨™ç‚ºä¸€å€‹å€å¡Š
- é¡¯ç¤ºæ ¼å¼åŒ…å«ï¼šå·¥å–®åç¨±ã€ç‹€æ…‹ã€å„ªå…ˆç´šã€æ—¥æœŸèˆ‡æ™‚é–“
- å¯ç·¨è¼¯èˆ‡åˆªé™¤ä»Šæ—¥æ’ç¨‹
- æ–°å¢æ’ç¨‹æ™‚ï¼Œè‹¥ç‚ºä»Šæ—¥æ’ç¨‹ä¸”è™•æ–¼ä»Šæ—¥æ’ç¨‹æ¨¡å¼ï¼Œæœƒè‡ªå‹•æ›´æ–°åˆ—è¡¨

åŠŸèƒ½å·²å¯¦ä½œå®Œæˆï¼Œèªæ³•æª¢æŸ¥é€šéã€‚å¯åœ¨ç€è¦½å™¨ä¸­æ¸¬è©¦ã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ã€‚

---

**User**

å¯ä»¥è®“æˆ‘æª¢è¦–ç›®å‰ä½¿ç”¨çš„APIå—?

---

**Cursor**


æª¢è¦–å°ˆæ¡ˆä¸­çš„ API ç«¯é»å’Œæ–‡æª”ï¼š


æª¢è¦–æ‰€æœ‰è·¯ç”±æ–‡ä»¶ï¼Œæ•´ç†å®Œæ•´çš„ API åˆ—è¡¨ï¼š


å»ºç«‹å®Œæ•´çš„ API æ–‡æª”ï¼Œåˆ—å‡ºæ‰€æœ‰å¯ç”¨ç«¯é»ï¼š


```markdown
# å·¥å–®ç®¡ç†ç³»çµ± - å®Œæ•´ API æ–‡æª”

## åŸºç¤è³‡è¨Š
- **Base URL**: `http://localhost:5000`
- **Content-Type**: `application/json`
- **èªè­‰**: ç„¡éœ€èªè­‰ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰

---

## ğŸ“‹ 1. ç³»çµ±è³‡è¨Š

### 1.1 æ ¹è·¯å¾‘ - æŸ¥çœ‹ API è³‡è¨Š
```http
GET /
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å·¥å–®ç®¡ç†ç³»çµ±å¾Œç«¯ API æœå‹™",
  "version": "1.0.0",
  "endpoints": {
    "health": "/health",
    "tickets": "/api/tickets",
    "targets": "/api/targets",
    "schedules": "/api/schedules",
    "photos": "/api/photos",
    "version": "/api/version"
  },
  "timestamp": "2025-11-02T12:00:00.000Z"
}
```

### 1.2 å¥åº·æª¢æŸ¥
```http
GET /health
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "status": "OK",
  "message": "å·¥å–®ç®¡ç†ç³»çµ±å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ",
  "timestamp": "2025-11-02T12:00:00.000Z"
}
```

---

## ğŸ« 2. å·¥å–®ç®¡ç† API (`/api/tickets`)

### 2.1 å»ºç«‹å·¥å–®
```http
POST /api/tickets
```

**è«‹æ±‚é«”**:
```json
{
  "deviceId": "CELL-001",
  "imageId": "IMG-2024-001"  // å¯é¸
}
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å·¥å–®å»ºç«‹æˆåŠŸ",
  "data": {
    "id": "clx1234567890",
    "deviceId": "CELL-001",
    "imageId": "IMG-2024-001",
    "status": "OPEN",
    "createdAt": "2025-11-02T12:00:00.000Z",
    "updatedAt": "2025-11-02T12:00:00.000Z"
  }
}
```

### 2.2 æŸ¥è©¢å·¥å–®åˆ—è¡¨
```http
GET /api/tickets?status=OPEN&deviceId=CELL-001&page=1&limit=10
```

**æŸ¥è©¢åƒæ•¸**:
- `status` (å¯é¸): OPEN | CLOSED
- `deviceId` (å¯é¸): è¨­å‚™ ID
- `page` (å¯é¸): é ç¢¼ï¼Œé è¨­ 1
- `limit` (å¯é¸): æ¯é æ•¸é‡ï¼Œé è¨­ 10

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "æŸ¥è©¢å·¥å–®åˆ—è¡¨æˆåŠŸ",
  "data": {
    "tickets": [...],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 1,
      "totalPages": 1
    }
  }
}
```

### 2.3 æŸ¥è©¢å–®ä¸€å·¥å–®è©³æƒ…
```http
GET /api/tickets/:id
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "æŸ¥è©¢å·¥å–®è©³æƒ…æˆåŠŸ",
  "data": {
    "id": "clx1234567890",
    "deviceId": "CELL-001",
    "imageId": "IMG-2024-001",
    "status": "OPEN",
    "createdAt": "2025-11-02T12:00:00.000Z",
    "updatedAt": "2025-11-02T12:00:00.000Z"
  }
}
```

### 2.4 æ›´æ–°å·¥å–®
```http
PUT /api/tickets/:id
```

**è«‹æ±‚é«”**:
```json
{
  "status": "CLOSED"  // å¯é¸
}
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å·¥å–®æ›´æ–°æˆåŠŸ",
  "data": {
    "id": "clx1234567890",
    "deviceId": "CELL-001",
    "status": "CLOSED",
    "updatedAt": "2025-11-02T12:30:00.000Z"
  }
}
```

---

## ğŸ¯ 3. é ç”Ÿç”¢ç›®æ¨™ API (`/api/targets`)

### 3.1 å–å¾—æ‰€æœ‰é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨
```http
GET /api/targets?page=1&limit=10&status=PLANNING
```

**æŸ¥è©¢åƒæ•¸**:
- `page` (å¯é¸): é ç¢¼ï¼Œé è¨­ 1
- `limit` (å¯é¸): æ¯é æ•¸é‡ï¼Œé è¨­ 10
- `status` (å¯é¸): PLANNING | IN_PROGRESS | COMPLETED | CANCELLED

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å–å¾—é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨æˆåŠŸ",
  "data": {
    "targets": [
      {
        "id": "target123",
        "name": "DS1-2",
        "description": "ç›®æ¨™æè¿°",
        "expectedCompletionDate": "2025-11-30",
        "status": "PLANNING",
        "createdAt": "2025-11-02T12:00:00.000Z",
        "updatedAt": "2025-11-02T12:00:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 1,
      "totalPages": 1
    }
  }
}
```

### 3.2 å–å¾—å–®ä¸€é ç”Ÿç”¢ç›®æ¨™è©³æƒ…
```http
GET /api/targets/:id
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å–å¾—é ç”Ÿç”¢ç›®æ¨™è©³æƒ…æˆåŠŸ",
  "data": {
    "id": "target123",
    "name": "DS1-2",
    "description": "ç›®æ¨™æè¿°",
    "expectedCompletionDate": "2025-11-30",
    "status": "PLANNING",
    "createdAt": "2025-11-02T12:00:00.000Z",
    "updatedAt": "2025-11-02T12:00:00.000Z"
  }
}
```

### 3.3 å»ºç«‹æ–°çš„é ç”Ÿç”¢ç›®æ¨™
```http
POST /api/targets
```

**è«‹æ±‚é«”**:
```json
{
  "name": "DS1-2",
  "description": "ç›®æ¨™æè¿°",  // å¯é¸
  "expectedCompletionDate": "2025-11-30"
}
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å»ºç«‹é ç”Ÿç”¢ç›®æ¨™æˆåŠŸ",
  "data": {
    "id": "target123",
    "name": "DS1-2",
    "status": "PLANNING",
    "createdAt": "2025-11-02T12:00:00.000Z",
    "updatedAt": "2025-11-02T12:00:00.000Z"
  }
}
```

### 3.4 æ›´æ–°é ç”Ÿç”¢ç›®æ¨™
```http
PUT /api/targets/:id
```

**è«‹æ±‚é«”**:
```json
{
  "name": "DS1-2-æ›´æ–°",  // å¯é¸
  "description": "æ›´æ–°æè¿°",  // å¯é¸
  "expectedCompletionDate": "2025-12-01",  // å¯é¸
  "status": "IN_PROGRESS"  // å¯é¸: PLANNING | IN_PROGRESS | COMPLETED | CANCELLED
}
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "æ›´æ–°é ç”Ÿç”¢ç›®æ¨™æˆåŠŸ",
  "data": {
    "id": "target123",
    "name": "DS1-2-æ›´æ–°",
    "status": "IN_PROGRESS",
    "updatedAt": "2025-11-02T12:30:00.000Z"
  }
}
```

### 3.5 åˆªé™¤é ç”Ÿç”¢ç›®æ¨™
```http
DELETE /api/targets/:id
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "åˆªé™¤é ç”Ÿç”¢ç›®æ¨™æˆåŠŸ"
}
```

### 3.6 å–å¾—æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
```http
GET /api/targets/:id/schedules
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å–å¾—å·¥å–®æ’ç¨‹æˆåŠŸ",
  "data": [
    {
      "id": "schedule123",
      "ticketId": "ticket123",
      "targetId": "target123",
      "scheduledDate": "2025-11-02",
      "scheduledTime": "09:00",
      "priority": "HIGH",
      "status": "OPEN",
      "ticket": {
        "id": "ticket123",
        "deviceId": "CELL-001",
        "status": "OPEN"
      },
      "createdAt": "2025-11-02T12:00:00.000Z",
      "updatedAt": "2025-11-02T12:00:00.000Z"
    }
  ]
}
```

---

## ğŸ“… 4. å·¥å–®æ’ç¨‹ API (`/api/schedules`)

### 4.1 å»ºç«‹å·¥å–®æ’ç¨‹
```http
POST /api/schedules
```

**è«‹æ±‚é«”**:
```json
{
  "ticketId": "ticket123",
  "targetId": "target123",
  "scheduledDate": "2025-11-02",
  "scheduledTime": "09:00",  // å¯é¸ï¼Œæ ¼å¼: HH:mm
  "priority": "MEDIUM"  // å¯é¸: HIGH | MEDIUM | LOWï¼Œé è¨­: MEDIUM
}
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å»ºç«‹å·¥å–®æ’ç¨‹æˆåŠŸ",
  "data": {
    "id": "schedule123",
    "ticketId": "ticket123",
    "targetId": "target123",
    "scheduledDate": "2025-11-02",
    "scheduledTime": "09:00",
    "priority": "MEDIUM",
    "status": "OPEN",
    "ticket": {...},
    "target": {...},
    "createdAt": "2025-11-02T12:00:00.000Z",
    "updatedAt": "2025-11-02T12:00:00.000Z"
  }
}
```

### 4.2 å–å¾—æ‰€æœ‰å·¥å–®æ’ç¨‹åˆ—è¡¨
```http
GET /api/schedules?page=1&limit=10&targetId=target123&ticketId=ticket123&status=OPEN&date=2025-11-02
```

**æŸ¥è©¢åƒæ•¸**:
- `page` (å¯é¸): é ç¢¼ï¼Œé è¨­ 1
- `limit` (å¯é¸): æ¯é æ•¸é‡ï¼Œé è¨­ 10
- `targetId` (å¯é¸): ç›®æ¨™ ID ç¯©é¸
- `ticketId` (å¯é¸): å·¥å–® ID ç¯©é¸
- `status` (å¯é¸): ç‹€æ…‹ç¯©é¸
- `date` (å¯é¸): æ—¥æœŸç¯©é¸ï¼Œæ ¼å¼: YYYY-MM-DDï¼ˆ**æ–°å¢åŠŸèƒ½ï¼šç”¨æ–¼ä»Šæ—¥æ’ç¨‹**ï¼‰

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å–å¾—å·¥å–®æ’ç¨‹åˆ—è¡¨æˆåŠŸ",
  "data": {
    "schedules": [
      {
        "id": "schedule123",
        "ticketId": "ticket123",
        "targetId": "target123",
        "scheduledDate": "2025-11-02",
        "scheduledTime": "09:00",
        "priority": "MEDIUM",
        "status": "OPEN",
        "ticket": {...},
        "target": {...}
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 1,
      "totalPages": 1
    }
  }
}
```

### 4.3 å–å¾—æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
```http
GET /api/schedules/target/:targetId
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å–å¾—ç›®æ¨™å·¥å–®æ’ç¨‹æˆåŠŸ",
  "data": [
    {
      "id": "schedule123",
      "ticketId": "ticket123",
      "targetId": "target123",
      "scheduledDate": "2025-11-02",
      "scheduledTime": "09:00",
      "priority": "HIGH",
      "status": "OPEN",
      "ticket": {...},
      "target": {...}
    }
  ]
}
```

### 4.4 å–å¾—å–®ä¸€å·¥å–®æ’ç¨‹è©³æƒ…
```http
GET /api/schedules/:id
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å–å¾—å·¥å–®æ’ç¨‹è©³æƒ…æˆåŠŸ",
  "data": {
    "id": "schedule123",
    "ticketId": "ticket123",
    "targetId": "target123",
    "scheduledDate": "2025-11-02",
    "scheduledTime": "09:00",
    "priority": "HIGH",
    "status": "OPEN",
    "ticket": {...},
    "target": {...}
  }
}
```

### 4.5 æ›´æ–°å·¥å–®æ’ç¨‹
```http
PUT /api/schedules/:id
```

**è«‹æ±‚é«”**:
```json
{
  "scheduledDate": "2025-11-03",  // å¯é¸ï¼Œæ ¼å¼: YYYY-MM-DD
  "scheduledTime": "10:00",  // å¯é¸ï¼Œæ ¼å¼: HH:mm
  "priority": "HIGH",  // å¯é¸: HIGH | MEDIUM | LOW
  "status": "IN_PROGRESS"  // å¯é¸: OPEN | IN_PROGRESS | COMPLETED | CANCELLED
}
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "æ›´æ–°å·¥å–®æ’ç¨‹æˆåŠŸ",
  "data": {
    "id": "schedule123",
    "scheduledDate": "2025-11-03",
    "scheduledTime": "10:00",
    "priority": "HIGH",
    "status": "IN_PROGRESS",
    "updatedAt": "2025-11-02T12:30:00.000Z"
  }
}
```

### 4.6 åˆªé™¤å·¥å–®æ’ç¨‹
```http
DELETE /api/schedules/:id
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "åˆªé™¤å·¥å–®æ’ç¨‹æˆåŠŸ"
}
```

---

## ğŸ“· 5. ç…§ç‰‡ API (`/api/photos`)

### 5.1 ä¸Šå‚³ç…§ç‰‡åˆ°æŒ‡å®šå·¥å–®
```http
POST /api/photos/upload
Content-Type: multipart/form-data
```

**è¡¨å–®è³‡æ–™**:
- `photo` (file): ç…§ç‰‡æ–‡ä»¶ï¼ˆJPEG, JPG, PNG, GIF, BMP, WEBPï¼Œæœ€å¤§ 10MBï¼‰
- `ticketId` (string): å·¥å–® IDï¼ˆå¿…å¡«ï¼‰
- `description` (string): ç…§ç‰‡æè¿°ï¼ˆå¯é¸ï¼‰

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "ç…§ç‰‡ä¸Šå‚³æˆåŠŸ",
  "data": {
    "id": "photo123",
    "filename": "1761579584168_820092929.jpg",
    "originalName": "image.jpg",
    "fileSize": 102400,
    "mimeType": "image/jpeg",
    "description": "ç…§ç‰‡æè¿°",
    "uploadedAt": "2025-11-02T12:00:00.000Z",
    "url": "/api/photos/photo123/view"
  }
}
```

### 5.2 æŸ¥çœ‹ç…§ç‰‡
```http
GET /api/photos/:id/view
```

**å›æ‡‰**: è¿”å›ç…§ç‰‡æ–‡ä»¶ï¼ˆåœ–ç‰‡ï¼‰

### 5.3 ç²å–æŒ‡å®šå·¥å–®çš„æ‰€æœ‰ç…§ç‰‡
```http
GET /api/photos/ticket/:ticketId
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "ç²å–ç…§ç‰‡åˆ—è¡¨æˆåŠŸ",
  "data": [
    {
      "id": "photo123",
      "filename": "1761579584168_820092929.jpg",
      "originalName": "image.jpg",
      "fileSize": 102400,
      "mimeType": "image/jpeg",
      "description": "ç…§ç‰‡æè¿°",
      "uploadedAt": "2025-11-02T12:00:00.000Z",
      "url": "/api/photos/photo123/view"
    }
  ]
}
```

### 5.4 åˆªé™¤ç…§ç‰‡
```http
DELETE /api/photos/:id
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "ç…§ç‰‡åˆªé™¤æˆåŠŸ"
}
```

---

## ğŸ“¦ 6. ç‰ˆæœ¬è³‡è¨Š API (`/api/version`)

### 6.1 ç²å–ç‰ˆæœ¬è³‡è¨Š
```http
GET /api/version
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "version": "1.0.0",
    "buildNumber": "20251102",
    "changelog": [
      {
        "version": "1.0.0",
        "date": "2025-11-02",
        "changes": ["åˆå§‹ç‰ˆæœ¬"]
      }
    ]
  },
  "timestamp": "2025-11-02T12:00:00.000Z"
}
```

### 6.2 ç²å–æ›´æ–°æ—¥èªŒ
```http
GET /api/version/changelog
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "changelog": [...],
    "currentVersion": "1.0.0",
    "buildNumber": "20251102"
  }
}
```

### 6.3 æª¢æŸ¥æ›´æ–°
```http
GET /api/version/check?version=1.0.0
```

**æŸ¥è©¢åƒæ•¸**:
- `version` (å¯é¸): å®¢æˆ¶ç«¯ç‰ˆæœ¬è™Ÿï¼Œé è¨­ "1.0.0"

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "hasUpdate": false,
    "currentVersion": "1.0.0",
    "clientVersion": "1.0.0",
    "latestChangelog": {...},
    "updateAvailable": false
  }
}
```

---

## ğŸš¨ éŒ¯èª¤è™•ç†

### é©—è­‰éŒ¯èª¤ (400)
```json
{
  "success": false,
  "message": "è«‹æ±‚è³‡æ–™é©—è­‰å¤±æ•—",
  "errors": [
    {
      "msg": "è¨­å‚™ ID ç‚ºå¿…å¡«æ¬„ä½",
      "param": "deviceId"
    }
  ]
}
```

### è³‡æºä¸å­˜åœ¨ (404)
```json
{
  "success": false,
  "message": "æ‰¾ä¸åˆ°æŒ‡å®šçš„è³‡æº"
}
```

### ä¼ºæœå™¨éŒ¯èª¤ (500)
```json
{
  "success": false,
  "message": "ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤",
  "error": "è©³ç´°éŒ¯èª¤è¨Šæ¯"
}
```

---

## ğŸ“ è³‡æ–™æ¨¡å‹

### Ticket å·¥å–®
| æ¬„ä½ | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| id | String | âœ… | å·¥å–®å”¯ä¸€è­˜åˆ¥ç¢¼ |
| deviceId | String | âœ… | è¨­å‚™ ID |
| imageId | String | âŒ | å½±åƒ ID |
| status | Enum | âœ… | å·¥å–®ç‹€æ…‹ (OPEN/CLOSED) |
| createdAt | DateTime | âœ… | å»ºç«‹æ™‚é–“ |
| updatedAt | DateTime | âœ… | æ›´æ–°æ™‚é–“ |

### ProductionTarget é ç”Ÿç”¢ç›®æ¨™
| æ¬„ä½ | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| id | String | âœ… | ç›®æ¨™å”¯ä¸€è­˜åˆ¥ç¢¼ |
| name | String | âœ… | ç›®æ¨™åç¨± |
| description | String | âŒ | ç›®æ¨™æè¿° |
| expectedCompletionDate | String | âœ… | é è¨ˆå®Œæˆæ™‚é–“ (YYYY-MM-DD) |
| status | Enum | âœ… | ç›®æ¨™ç‹€æ…‹ (PLANNING/IN_PROGRESS/COMPLETED/CANCELLED) |
| createdAt | DateTime | âœ… | å»ºç«‹æ™‚é–“ |
| updatedAt | DateTime | âœ… | æ›´æ–°æ™‚é–“ |

### TicketSchedule å·¥å–®æ’ç¨‹
| æ¬„ä½ | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| id | String | âœ… | æ’ç¨‹å”¯ä¸€è­˜åˆ¥ç¢¼ |
| ticketId | String | âœ… | å·¥å–® ID |
| targetId | String | âœ… | é ç”Ÿç”¢ç›®æ¨™ ID |
| scheduledDate | String | âœ… | æ’ç¨‹æ—¥æœŸ (YYYY-MM-DD) |
| scheduledTime | String | âŒ | æ’ç¨‹æ™‚é–“ (HH:mm) |
| priority | Enum | âœ… | å„ªå…ˆç´š (HIGH/MEDIUM/LOW) |
| status | Enum | âœ… | æ’ç¨‹ç‹€æ…‹ (OPEN/IN_PROGRESS/COMPLETED/CANCELLED) |
| createdAt | DateTime | âœ… | å»ºç«‹æ™‚é–“ |
| updatedAt | DateTime | âœ… | æ›´æ–°æ™‚é–“ |

### Photo ç…§ç‰‡
| æ¬„ä½ | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| id | String | âœ… | ç…§ç‰‡å”¯ä¸€è­˜åˆ¥ç¢¼ |
| ticketId | String | âœ… | å·¥å–® ID |
| filename | String | âœ… | å­˜å„²æ–‡ä»¶å |
| originalName | String | âœ… | åŸå§‹æ–‡ä»¶å |
| filePath | String | âœ… | æ–‡ä»¶è·¯å¾‘ |
| fileSize | Int | âœ… | æ–‡ä»¶å¤§å°ï¼ˆå­—ç¯€ï¼‰ |
| mimeType | String | âœ… | MIMEé¡å‹ |
| description | String | âŒ | ç…§ç‰‡æè¿° |
| uploadedAt | DateTime | âœ… | ä¸Šå‚³æ™‚é–“ |

---

## ğŸ”§ ä½¿ç”¨ç¯„ä¾‹

### ä½¿ç”¨ curl æ¸¬è©¦ API

```bash
# 1. æª¢æŸ¥æœå‹™ç‹€æ…‹
curl http://localhost:5000/health

# 2. æŸ¥çœ‹ API è³‡è¨Š
curl http://localhost:5000/

# 3. å»ºç«‹å·¥å–®
curl -X POST http://localhost:5000/api/tickets \
  -H "Content-Type: application/json" \
  -d '{"deviceId": "CELL-001"}'

# 4. æŸ¥è©¢å·¥å–®åˆ—è¡¨
curl http://localhost:5000/api/tickets?page=1&limit=10

# 5. å»ºç«‹é ç”Ÿç”¢ç›®æ¨™
curl -X POST http://localhost:5000/api/targets \
  -H "Content-Type: application/json" \
  -d '{"name": "DS1-2", "expectedCompletionDate": "2025-11-30"}'

# 6. å»ºç«‹å·¥å–®æ’ç¨‹
curl -X POST http://localhost:5000/api/schedules \
  -H "Content-Type: application/json" \
  -d '{"ticketId": "ticket123", "targetId": "target123", "scheduledDate": "2025-11-02"}'

# 7. æŸ¥è©¢ä»Šæ—¥æ’ç¨‹ï¼ˆæ–°åŠŸèƒ½ï¼‰
curl "http://localhost:5000/api/schedules?date=2025-11-02&limit=1000"

# 8. ä¸Šå‚³ç…§ç‰‡
curl -X POST http://localhost:5000/api/photos/upload \
  -F "photo=@image.jpg" \
  -F "ticketId=ticket123" \
  -F "description=ç…§ç‰‡æè¿°"
```

### ä½¿ç”¨ JavaScript/Fetch

```javascript
// å»ºç«‹å·¥å–®
const createTicket = async (ticketData) => {
  const response = await fetch('http://localhost:5000/api/tickets', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(ticketData)
  });
  return await response.json();
};

// æŸ¥è©¢ä»Šæ—¥æ’ç¨‹
const getTodaySchedules = async () => {
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  const response = await fetch(`http://localhost:5000/api/schedules?date=${today}&limit=1000`);
  return await response.json();
};

// å–å¾—ç›®æ¨™åˆ—è¡¨
const getTargets = async (page = 1, limit = 100) => {
  const response = await fetch(`http://localhost:5000/api/targets?page=${page}&limit=${limit}`);
  return await response.json();
};
```

---

## ğŸ“Œ æœ€æ–°æ›´æ–°

### æ–°å¢åŠŸèƒ½ï¼ˆ2025-11-02ï¼‰
- âœ… **ä»Šæ—¥æ’ç¨‹åŠŸèƒ½**: åœ¨ `/api/schedules` ç«¯é»æ–°å¢ `date` æŸ¥è©¢åƒæ•¸ï¼Œæ”¯æ´æŒ‰æ—¥æœŸç¯©é¸æ’ç¨‹
  - ä½¿ç”¨æ–¹å¼: `GET /api/schedules?date=2025-11-02&limit=1000`
  - å¯ç²å–æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰æ’ç¨‹ï¼Œæ–¹ä¾¿å¯¦ç¾ã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½

---

## ğŸ”— ç›¸é—œé€£çµ
- å‰ç«¯æ‡‰ç”¨: `http://localhost:3000`
- å¾Œç«¯ API: `http://localhost:5000`
- API æ ¹è·¯å¾‘: `http://localhost:5000/`
- å¥åº·æª¢æŸ¥: `http://localhost:5000/health`

```

å·²åœ¨ `server/API_COMPLETE.md` å»ºç«‹å®Œæ•´çš„ API æ–‡æª”ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨ç«¯é»ã€‚åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ï¼š


å·²å»ºç«‹å®Œæ•´çš„ API æ–‡æª”ï¼Œä¸¦åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹äº† API æ ¹è·¯å¾‘ã€‚

## API æ–‡æª”ä½ç½®

**å®Œæ•´æ–‡æª”**: `server/API_COMPLETE.md`

**ç€è¦½å™¨ä¸­æŸ¥çœ‹**:
- API è³‡è¨Šé é¢: `http://localhost:5000/`ï¼ˆå·²æ‰“é–‹ï¼‰
- æ­¤é é¢æœƒé¡¯ç¤ºæ‰€æœ‰å¯ç”¨çš„ API ç«¯é»åˆ—è¡¨

## ä¸»è¦ API ç«¯é»æ‘˜è¦

### ç³»çµ±è³‡è¨Š
- `GET /` - API è³‡è¨Šèˆ‡ç«¯é»åˆ—è¡¨
- `GET /health` - å¥åº·æª¢æŸ¥

### å·¥å–®ç®¡ç† (`/api/tickets`)
- `GET /api/tickets` - æŸ¥è©¢å·¥å–®åˆ—è¡¨
- `POST /api/tickets` - å»ºç«‹å·¥å–®
- `GET /api/tickets/:id` - æŸ¥è©¢å·¥å–®è©³æƒ…
- `PUT /api/tickets/:id` - æ›´æ–°å·¥å–®

### é ç”Ÿç”¢ç›®æ¨™ (`/api/targets`)
- `GET /api/targets` - å–å¾—ç›®æ¨™åˆ—è¡¨
- `POST /api/targets` - å»ºç«‹ç›®æ¨™
- `GET /api/targets/:id` - å–å¾—ç›®æ¨™è©³æƒ…
- `PUT /api/targets/:id` - æ›´æ–°ç›®æ¨™
- `DELETE /api/targets/:id` - åˆªé™¤ç›®æ¨™
- `GET /api/targets/:id/schedules` - å–å¾—ç›®æ¨™çš„æ’ç¨‹

### å·¥å–®æ’ç¨‹ (`/api/schedules`)
- `GET /api/schedules` - å–å¾—æ’ç¨‹åˆ—è¡¨ï¼ˆæ”¯æ´ `date` åƒæ•¸ç”¨æ–¼ä»Šæ—¥æ’ç¨‹ï¼‰
- `POST /api/schedules` - å»ºç«‹æ’ç¨‹
- `GET /api/schedules/target/:targetId` - å–å¾—æŒ‡å®šç›®æ¨™çš„æ’ç¨‹
- `GET /api/schedules/:id` - å–å¾—æ’ç¨‹è©³æƒ…
- `PUT /api/schedules/:id` - æ›´æ–°æ’ç¨‹
- `DELETE /api/schedules/:id` - åˆªé™¤æ’ç¨‹

### ç…§ç‰‡ç®¡ç† (`/api/photos`)
- `POST /api/photos/upload` - ä¸Šå‚³ç…§ç‰‡
- `GET /api/photos/:id/view` - æŸ¥çœ‹ç…§ç‰‡
- `GET /api/photos/ticket/:ticketId` - å–å¾—å·¥å–®çš„ç…§ç‰‡åˆ—è¡¨
- `DELETE /api/photos/:id` - åˆªé™¤ç…§ç‰‡

### ç‰ˆæœ¬è³‡è¨Š (`/api/version`)
- `GET /api/version` - å–å¾—ç‰ˆæœ¬è³‡è¨Š
- `GET /api/version/changelog` - å–å¾—æ›´æ–°æ—¥èªŒ
- `GET /api/version/check` - æª¢æŸ¥æ›´æ–°

å®Œæ•´è©³ç´°çš„ API æ–‡æª”å·²ä¿å­˜åœ¨ `server/API_COMPLETE.md`ï¼ŒåŒ…å«æ‰€æœ‰ç«¯é»çš„è«‹æ±‚ç¯„ä¾‹ã€å›æ‡‰æ ¼å¼å’Œèªªæ˜ã€‚

---

**User**

å·¥å–®ç³»çµ±çš„ç¶²é å¯ä»¥è®“æˆ‘åˆ†äº«çµ¦æœ‹å‹å—? ä¹Ÿè®“ä»–å¯ä»¥æ¸¬è©¦åŠŸèƒ½ä¸¦å›é¥‹

---

**Cursor**


æª¢æŸ¥é…ç½®ï¼Œç¢ºä¿æœå‹™å¯è¢«å¤–éƒ¨è¨ªå•ï¼š


æª¢æŸ¥ä¸¦å»ºç«‹é…ç½®ï¼Œè®“æœ‹å‹èƒ½å¾å¤–éƒ¨è¨ªå•ç³»çµ±ï¼š


ç‚ºäº†è®“æœ‹å‹å¯å¾å¤–éƒ¨è¨ªå•ï¼Œéœ€åšå…©ä»¶äº‹ï¼š
1. è®“å‰ç«¯å¯å¾å¤–éƒ¨è¨ªå•ï¼ˆè¨­å®š HOST=0.0.0.0ï¼‰
2. è®“å‰ç«¯ä½¿ç”¨æ­£ç¢ºçš„ API åœ°å€ï¼ˆä¸èƒ½æ˜¯ localhostï¼‰

å»ºç«‹ä¸€å€‹è‡ªå‹•é…ç½®çš„å•Ÿå‹•è…³æœ¬å’Œåˆ†äº«æŒ‡å—ï¼š


```bat
@echo off
chcp 65001 >nul
echo ========================================
echo ğŸš€ å•Ÿå‹•å·¥å–®ç®¡ç†ç³»çµ±ï¼ˆå¤–éƒ¨åˆ†äº«æ¨¡å¼ï¼‰
echo ========================================
echo.

REM ç²å–æœ¬æ©Ÿ IP åœ°å€
for /f "tokens=2 delims=:" %%a in ('ipconfig ^| findstr /c:"IPv4"') do (
    set LOCAL_IP=%%a
    goto :ip_found
)
:ip_found
REM æ¸…ç†IPåœ°å€ï¼ˆç§»é™¤ç©ºæ ¼ï¼‰
set LOCAL_IP=%LOCAL_IP: =%

echo ğŸ“ æª¢æ¸¬åˆ°æœ¬æ©Ÿ IP åœ°å€: %LOCAL_IP%
echo.

REM è¨­å®šç’°å¢ƒè®Šæ•¸
set HOST=0.0.0.0
set PORT=3000
set REACT_APP_API_URL=http://%LOCAL_IP%:5000/api

echo âœ… ç’°å¢ƒè®Šæ•¸å·²è¨­å®š:
echo    HOST=%HOST%
echo    PORT=%PORT%
echo    REACT_APP_API_URL=%REACT_APP_API_URL%
echo.

echo ğŸ”§ å•Ÿå‹•å¾Œç«¯æœå‹™...
start "å¾Œç«¯æœå‹™" cmd /k "cd /d %~dp0server && npm run dev"

echo ç­‰å¾…å¾Œç«¯æœå‹™å•Ÿå‹•...
timeout /t 5 /nobreak >nul

echo ğŸŒ å•Ÿå‹•å‰ç«¯æœå‹™ï¼ˆå…è¨±å¤–éƒ¨è¨ªå•ï¼‰...
start "å‰ç«¯æœå‹™" cmd /k "cd /d %~dp0client && set HOST=0.0.0.0 && set REACT_APP_API_URL=%REACT_APP_API_URL% && npm start"

echo.
echo ========================================
echo âœ… æœå‹™å•Ÿå‹•å®Œæˆï¼
echo ========================================
echo.
echo ğŸ“± åˆ†äº«çµ¦æœ‹å‹çš„è¨ªå•åœ°å€ï¼š
echo    å‰ç«¯ç¶²é : http://%LOCAL_IP%:3000
echo    å¾Œç«¯API: http://%LOCAL_IP%:5000
echo.
echo ğŸ’» æœ¬æ©Ÿè¨ªå•åœ°å€ï¼š
echo    å‰ç«¯ç¶²é : http://localhost:3000
echo    å¾Œç«¯API: http://localhost:5000
echo.
echo ========================================
echo ğŸ“‹ åˆ†äº«èªªæ˜ï¼š
echo ========================================
echo 1. ç¢ºä¿ä½ çš„é›»è…¦å’Œæœ‹å‹çš„è¨­å‚™åœ¨åŒä¸€ç¶²è·¯
echo    æˆ–åœ¨åŒä¸€å€‹ WiFi ä¸‹
echo.
echo 2. åˆ†äº«çµ¦æœ‹å‹ä»¥ä¸‹ç¶²å€ï¼š
echo    http://%LOCAL_IP%:3000
echo.
echo 3. å¦‚æœç„¡æ³•è¨ªå•ï¼Œè«‹æª¢æŸ¥ï¼š
echo    - Windows é˜²ç«ç‰†æ˜¯å¦å…è¨± Node.js è¨ªå•
echo    - è·¯ç”±å™¨æ˜¯å¦å…è¨±å…§ç¶²è¨ªå•
echo    - å…©å€‹è¨­å‚™æ˜¯å¦åœ¨åŒä¸€ç¶²è·¯
echo.
echo 4. é˜²ç«ç‰†è¨­å®šæ–¹æ³•ï¼š
echo    æ§åˆ¶å° ^> ç³»çµ±èˆ‡å®‰å…¨æ€§ ^> Windows Defender é˜²ç«ç‰†
echo    ^> å…è¨±æ‡‰ç”¨ç¨‹å¼é€šéé˜²ç«ç‰†
echo    å‹¾é¸ Node.js çš„ã€Œç§äººç¶²è·¯ã€é¸é …
echo.
echo ========================================
echo.
echo æŒ‰ä»»æ„éµé—œé–‰æ­¤è¦–çª—...
pause >nul

```

```markdown
# ğŸ“± å·¥å–®ç®¡ç†ç³»çµ± - åˆ†äº«çµ¦æœ‹å‹ä½¿ç”¨æŒ‡å—

## ğŸ¯ å¿«é€Ÿé–‹å§‹

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªå‹•å•Ÿå‹•è…³æœ¬ï¼ˆæ¨è–¦ï¼‰

1. **é›™æ“Šé‹è¡Œ** `start-for-sharing.bat`
2. **ç­‰å¾…æœå‹™å•Ÿå‹•**ï¼ˆç´„ 10-15 ç§’ï¼‰
3. **åˆ†äº«ç¶²å€**çµ¦æœ‹å‹ï¼šè…³æœ¬æœƒé¡¯ç¤ºæ‚¨çš„ IP åœ°å€å’Œè¨ªå•ç¶²å€

---

## ğŸ“ ç²å–æ‚¨çš„ IP åœ°å€

å¦‚æœæ²’æœ‰ä½¿ç”¨è‡ªå‹•å•Ÿå‹•è…³æœ¬ï¼Œæ‚¨å¯ä»¥ï¼š

### Windows æ–¹å¼ï¼š
```bash
# é›™æ“Šé‹è¡Œ
get-ip.bat

# æˆ–æ‰‹å‹•æŸ¥è©¢
ipconfig | findstr /i "IPv4"
```

### é¡¯ç¤ºçµæœé¡ä¼¼ï¼š
```
IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.0.186
```

---

## ğŸŒ å•Ÿå‹•æœå‹™ï¼ˆå…è¨±å¤–éƒ¨è¨ªå•ï¼‰

### é¸é … Aï¼šä½¿ç”¨åˆ†äº«è…³æœ¬ï¼ˆæœ€ç°¡å–®ï¼‰
```bash
start-for-sharing.bat
```

### é¸é … Bï¼šæ‰‹å‹•å•Ÿå‹•

**1. å•Ÿå‹•å¾Œç«¯æœå‹™**ï¼ˆå·²é…ç½®ç‚ºå…è¨±å¤–éƒ¨è¨ªå•ï¼‰
```bash
cd server
npm run dev
```

**2. å•Ÿå‹•å‰ç«¯æœå‹™**ï¼ˆéœ€è¦è¨­ç½®ç’°å¢ƒè®Šæ•¸ï¼‰

åœ¨ PowerShell ä¸­ï¼š
```powershell
cd client
$env:HOST="0.0.0.0"
$env:REACT_APP_API_URL="http://192.168.0.186:5000/api"
npm start
```

æˆ–è€…å‰µå»º `.env` æ–‡ä»¶åœ¨ `client/` ç›®éŒ„ä¸‹ï¼š
```env
HOST=0.0.0.0
REACT_APP_API_URL=http://192.168.0.186:5000/api
```

**æ³¨æ„**ï¼šè«‹å°‡ `192.168.0.186` æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› IP åœ°å€ï¼

---

## ğŸ”— åˆ†äº«è¨ªå•åœ°å€

### å‰ç«¯ç¶²é ï¼ˆçµ¦æœ‹å‹è¨ªå•ï¼‰
```
http://æ‚¨çš„IPåœ°å€:3000
ä¾‹å¦‚ï¼šhttp://192.168.0.186:3000
```

### å¾Œç«¯ APIï¼ˆå¦‚éœ€ç›´æ¥æ¸¬è©¦ APIï¼‰
```
http://æ‚¨çš„IPåœ°å€:5000
ä¾‹å¦‚ï¼šhttp://192.168.0.186:5000
```

---

## âœ… è¨ªå•æ¢ä»¶

### å¿…é ˆæ»¿è¶³ï¼š
1. âœ… **åŒä¸€ç¶²è·¯**ï¼šæ‚¨çš„é›»è…¦å’Œæœ‹å‹çš„è¨­å‚™å¿…é ˆé€£æ¥åˆ°åŒä¸€å€‹ WiFi æˆ–å€åŸŸç¶²è·¯
2. âœ… **æœå‹™é‹è¡Œä¸­**ï¼šç¢ºä¿å‰ç«¯å’Œå¾Œç«¯æœå‹™éƒ½åœ¨é‹è¡Œ
3. âœ… **é˜²ç«ç‰†å…è¨±**ï¼šWindows é˜²ç«ç‰†éœ€è¦å…è¨± Node.js çš„ç¶²è·¯è¨ªå•

---

## ğŸ”¥ Windows é˜²ç«ç‰†è¨­å®š

### å¦‚æœæœ‹å‹ç„¡æ³•è¨ªå•ï¼Œè«‹æª¢æŸ¥é˜²ç«ç‰†ï¼š

**æ–¹æ³•ä¸€ï¼šé€šéæ§åˆ¶å°**
1. æ‰“é–‹ã€Œæ§åˆ¶å°ã€â†’ã€Œç³»çµ±èˆ‡å®‰å…¨æ€§ã€â†’ã€ŒWindows Defender é˜²ç«ç‰†ã€
2. é»æ“Šã€Œå…è¨±æ‡‰ç”¨ç¨‹å¼é€šéé˜²ç«ç‰†ã€
3. æ‰¾åˆ°ã€ŒNode.jsã€æˆ–ã€ŒNode.exeã€
4. å‹¾é¸ã€Œç§äººç¶²è·¯ã€é¸é …
5. å¦‚æœæ‰¾ä¸åˆ°ï¼Œé»æ“Šã€Œè®Šæ›´è¨­å®šã€â†’ã€Œå…è¨±å¦ä¸€å€‹æ‡‰ç”¨ç¨‹å¼ã€â†’ é¸æ“‡ Node.js

**æ–¹æ³•äºŒï¼šé€šé PowerShellï¼ˆç®¡ç†å“¡æ¬Šé™ï¼‰**
```powershell
# å…è¨± Node.js é€šéé˜²ç«ç‰†ï¼ˆç§æœ‰ç¶²è·¯ï¼‰
New-NetFirewallRule -DisplayName "Node.js Server" -Direction Inbound -Program "C:\Program Files\nodejs\node.exe" -Action Allow -Profile Private
```

**æ–¹æ³•ä¸‰ï¼šæš«æ™‚é—œé–‰é˜²ç«ç‰†æ¸¬è©¦**
âš ï¸ **åƒ…ç”¨æ–¼æ¸¬è©¦ï¼Œä¸å»ºè­°é•·æœŸä½¿ç”¨**

---

## ğŸ“± ä¸åŒè¨­å‚™è¨ªå•æ–¹å¼

### ğŸ’» é›»è…¦/ç­†è¨˜æœ¬
1. æ‰“é–‹ç€è¦½å™¨ï¼ˆChromeã€Edgeã€Firefox ç­‰ï¼‰
2. è¼¸å…¥ï¼š`http://æ‚¨çš„IP:3000`
3. ä¾‹å¦‚ï¼š`http://192.168.0.186:3000`

### ğŸ“± æ‰‹æ©Ÿ/å¹³æ¿ï¼ˆåŒä¸€ WiFiï¼‰
1. é€£æ¥åˆ°èˆ‡æ‚¨é›»è…¦ç›¸åŒçš„ WiFi
2. æ‰“é–‹æ‰‹æ©Ÿç€è¦½å™¨
3. è¼¸å…¥ï¼š`http://æ‚¨çš„IP:3000`
4. ä¾‹å¦‚ï¼š`http://192.168.0.186:3000`

---

## ğŸ” æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šæœ‹å‹ç„¡æ³•è¨ªå•ç¶²é 
**å¯èƒ½åŸå› **ï¼š
- âŒ ä¸åœ¨åŒä¸€ç¶²è·¯
- âŒ é˜²ç«ç‰†é˜»æ“‹
- âŒ æœå‹™æœªå•Ÿå‹•

**è§£æ±ºæ–¹æ³•**ï¼š
1. ç¢ºèªå…©å€‹è¨­å‚™åœ¨åŒä¸€ WiFi
2. æª¢æŸ¥é˜²ç«ç‰†è¨­å®šï¼ˆè¦‹ä¸Šæ–¹ï¼‰
3. ç¢ºèªæœå‹™æ­£åœ¨é‹è¡Œï¼ˆæŸ¥çœ‹å‘½ä»¤æç¤ºå­—å…ƒè¦–çª—ï¼‰

### å•é¡Œ 2ï¼šç¶²é æ‰“é–‹ä½† API éŒ¯èª¤
**å¯èƒ½åŸå› **ï¼š
- âŒ å‰ç«¯ä½¿ç”¨çš„ API URL æ˜¯ `localhost`ï¼Œè€Œä¸æ˜¯æ‚¨çš„ IP

**è§£æ±ºæ–¹æ³•**ï¼š
1. ä½¿ç”¨ `start-for-sharing.bat` è‡ªå‹•è¨­ç½®
2. æˆ–æ‰‹å‹•è¨­ç½®ç’°å¢ƒè®Šæ•¸ `REACT_APP_API_URL`

### å•é¡Œ 3ï¼šå¯ä»¥è¨ªå•ä½†åŠŸèƒ½ä¸æ­£å¸¸
**å¯èƒ½åŸå› **ï¼š
- âŒ å¾Œç«¯æœå‹™æœªå•Ÿå‹•
- âŒ å¾Œç«¯ç›£è½åœ°å€éŒ¯èª¤

**è§£æ±ºæ–¹æ³•**ï¼š
ç¢ºèªå¾Œç«¯æœå‹™æ­£åœ¨é‹è¡Œï¼Œä¸¦æª¢æŸ¥ `server/index.js` ä¸­çš„ç›£è½è¨­å®šç‚º `0.0.0.0`

---

## ğŸŒ è·¨ç¶²éš›ç¶²è·¯åˆ†äº«ï¼ˆé€²éšï¼‰

å¦‚æœæ‚¨æƒ³è®“æœ‹å‹å¾ä¸åŒçš„ç¶²è·¯ï¼ˆä¾‹å¦‚ä¸åŒåŸå¸‚ï¼‰è¨ªå•ï¼Œéœ€è¦ï¼š

1. **ä½¿ç”¨å…§ç¶²ç©¿é€å·¥å…·**ï¼š
   - ngrok
   - localtunnel
   - Cloudflare Tunnel

2. **ç¯„ä¾‹ï¼šä½¿ç”¨ ngrok**
   ```bash
   # å®‰è£ ngrok
   # ä¸‹è¼‰ï¼šhttps://ngrok.com/
   
   # å•Ÿå‹•å¾Œç«¯æœå‹™
   cd server && npm run dev
   
   # åœ¨å¦ä¸€å€‹çµ‚ç«¯é‹è¡Œ
   ngrok http 5000
   
   # æœƒå¾—åˆ°é¡ä¼¼ï¼šhttps://abc123.ngrok.io
   # åˆ†äº«é€™å€‹ç¶²å€çµ¦æœ‹å‹
   ```

3. **æ³¨æ„äº‹é …**ï¼š
   - âš ï¸ å…¬é–‹åˆ†äº«å¯èƒ½å¸¶ä¾†å®‰å…¨é¢¨éšª
   - âš ï¸ å»ºè­°åƒ…ç”¨æ–¼æ¸¬è©¦ç’°å¢ƒ
   - âš ï¸ ç”Ÿç”¢ç’°å¢ƒéœ€è¦é…ç½® HTTPS å’Œèªè­‰

---

## ğŸ“‹ æª¢æŸ¥æ¸…å–®

åˆ†äº«å‰è«‹ç¢ºèªï¼š
- [ ] å¾Œç«¯æœå‹™æ­£åœ¨é‹è¡Œï¼ˆç«¯å£ 5000ï¼‰
- [ ] å‰ç«¯æœå‹™æ­£åœ¨é‹è¡Œï¼ˆç«¯å£ 3000ï¼‰
- [ ] å·²ç¶“è¨­ç½® `HOST=0.0.0.0`
- [ ] å·²ç¶“è¨­ç½® `REACT_APP_API_URL` ç‚ºæ‚¨çš„ IP åœ°å€
- [ ] é˜²ç«ç‰†å·²å…è¨± Node.js è¨ªå•
- [ ] çŸ¥é“æ‚¨çš„æœ¬æ©Ÿ IP åœ°å€
- [ ] æœ‹å‹èˆ‡æ‚¨åœ¨åŒä¸€ç¶²è·¯

---

## ğŸ’¡ æç¤º

1. **IP åœ°å€å¯èƒ½æœƒè®Š**ï¼šé‡æ–°é€£æ¥ WiFi å¾Œ IP åœ°å€å¯èƒ½æœƒæ”¹è®Šï¼Œè¨˜å¾—é‡æ–°æª¢æŸ¥
2. **ä½¿ç”¨å›ºå®š IP**ï¼šå¦‚æœç¶“å¸¸åˆ†äº«ï¼Œå»ºè­°åœ¨è·¯ç”±å™¨ä¸­ç‚ºæ‚¨çš„é›»è…¦è¨­ç½®å›ºå®š IP
3. **æ¸¬è©¦é€£ç·š**ï¼šå¯ä»¥å…ˆåœ¨æ‚¨çš„æ‰‹æ©Ÿï¼ˆåŒä¸€ WiFiï¼‰ä¸Šæ¸¬è©¦æ˜¯å¦èƒ½è¨ªå•
4. **åˆ†äº« API æ–‡æª”**ï¼šå¯ä»¥åˆ†äº« `server/API_COMPLETE.md` çµ¦æœ‹å‹æŸ¥çœ‹æ‰€æœ‰ API ç«¯é»

---

## ğŸ“ éœ€è¦å¹«åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š
1. çµ‚ç«¯è¦–çª—çš„éŒ¯èª¤è¨Šæ¯
2. ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·çš„ Consoleï¼ˆF12ï¼‰
3. ç¶²è·¯é€£ç·šç‹€æ…‹
4. æœå‹™æ—¥èªŒè¼¸å‡º

---

ç¥æ‚¨åˆ†äº«é †åˆ©ï¼ğŸ‰

```

å»ºç«‹ä¸€å€‹æ›´æ™ºèƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼Œè®“å‰ç«¯è‡ªå‹•ä½¿ç”¨æ­£ç¢ºçš„ API URLï¼š


```typescript
/**
 * å‹•æ…‹ç²å– API URL
 * å¦‚æœå¾å¤–éƒ¨è¨ªå•ï¼Œè‡ªå‹•ä½¿ç”¨ç•¶å‰ä¸»æ©Ÿçš„ IP åœ°å€
 */
export const getApiUrl = (): string => {
  // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸
  if (process.env.REACT_APP_API_URL) {
    return process.env.REACT_APP_API_URL;
  }

  // å¦‚æœç•¶å‰è¨ªå•åœ°å€ä¸æ˜¯ localhostï¼Œè‡ªå‹•æ§‹å»º API URL
  const currentHost = window.location.hostname;
  
  if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
    // æœ¬æ©Ÿè¨ªå•ï¼Œä½¿ç”¨ localhost
    return 'http://localhost:5000/api';
  } else {
    // å¤–éƒ¨è¨ªå•ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰ï¼Œæ§‹å»ºå°æ‡‰çš„ API URL
    const port = window.location.port === '3000' ? '5000' : window.location.port;
    return `http://${currentHost}:${port}/api`;
  }
};

// ç²å–å®Œæ•´çš„ API åŸºç¤ URLï¼ˆä¸å« /apiï¼‰
export const getApiBaseUrl = (): string => {
  const apiUrl = getApiUrl();
  return apiUrl.replace('/api', '');
};

```

æ›´æ–° API æœå‹™æ–‡ä»¶ï¼Œä½¿å…¶èƒ½è‡ªå‹•æª¢æ¸¬ä¸¦ä½¿ç”¨æ­£ç¢ºçš„ API URLï¼š


```typescript
import axios, { AxiosResponse } from 'axios';
import { 
  Ticket, 
  CreateTicketRequest, 
  UpdateTicketRequest, 
  ApiResponse, 
  TicketListResponse 
} from '../types/ticket';

// å‹•æ…‹ç²å– API URLï¼ˆæ”¯æ´å¤–éƒ¨è¨ªå•ï¼‰
const getApiBaseUrl = (): string => {
  // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸
  if (process.env.REACT_APP_API_URL) {
    return process.env.REACT_APP_API_URL;
  }

  // å¦‚æœç•¶å‰è¨ªå•åœ°å€ä¸æ˜¯ localhostï¼Œè‡ªå‹•æ§‹å»º API URL
  const currentHost = window.location.hostname;
  
  if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
    // æœ¬æ©Ÿè¨ªå•ï¼Œä½¿ç”¨ localhost
    return 'http://localhost:5000/api';
  } else {
    // å¤–éƒ¨è¨ªå•ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰ï¼Œæ§‹å»ºå°æ‡‰çš„ API URL
    return `http://${currentHost}:5000/api`;
  }
};

// å»ºç«‹ axios å¯¦ä¾‹ï¼Œè¨­å®šåŸºç¤ URL å’Œé è¨­é…ç½®
const api = axios.create({
  baseURL: getApiBaseUrl(),
  timeout: 10000, // 10 ç§’è¶…æ™‚
  headers: {
    'Content-Type': 'application/json; charset=utf-8',
  },
});

// è«‹æ±‚æ””æˆªå™¨ - åœ¨ç™¼é€è«‹æ±‚å‰æ·»åŠ èªè­‰è³‡è¨Šç­‰
api.interceptors.request.use(
  (config) => {
    console.log(`ç™¼é€ API è«‹æ±‚: ${config.method?.toUpperCase()} ${config.url}`);
    return config;
  },
  (error) => {
    console.error('è«‹æ±‚æ””æˆªå™¨éŒ¯èª¤:', error);
    return Promise.reject(error);
  }
);

// å›æ‡‰æ””æˆªå™¨ - çµ±ä¸€è™•ç†å›æ‡‰å’ŒéŒ¯èª¤
api.interceptors.response.use(
  (response: AxiosResponse) => {
    console.log(`API å›æ‡‰æˆåŠŸ: ${response.status} ${response.config.url}`);
    return response;
  },
  (error) => {
    console.error('API å›æ‡‰éŒ¯èª¤:', error);
    
    // çµ±ä¸€éŒ¯èª¤è™•ç†
    if (error.response) {
      // ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤
      const { status, data } = error.response;
      console.error(`ä¼ºæœå™¨éŒ¯èª¤ ${status}:`, data);
    } else if (error.request) {
      // ç¶²è·¯éŒ¯èª¤
      console.error('ç¶²è·¯éŒ¯èª¤:', error.request);
    } else {
      // å…¶ä»–éŒ¯èª¤
      console.error('è«‹æ±‚è¨­å®šéŒ¯èª¤:', error.message);
    }
    
    return Promise.reject(error);
  }
);

// å·¥å–® API æœå‹™é¡åˆ¥
export class TicketService {
  /**
   * å»ºç«‹æ–°å·¥å–®
   * @param ticketData å·¥å–®è³‡æ–™
   * @returns Promise<ApiResponse<Ticket>>
   */
  static async createTicket(ticketData: CreateTicketRequest): Promise<ApiResponse<Ticket>> {
    try {
      const response = await api.post('/tickets', ticketData);
      return response.data;
    } catch (error) {
      console.error('å»ºç«‹å·¥å–®å¤±æ•—:', error);
      throw error;
    }
  }

  /**
   * æŸ¥è©¢å·¥å–®åˆ—è¡¨
   * @param params æŸ¥è©¢åƒæ•¸
   * @returns Promise<ApiResponse<TicketListResponse>>
   */
  static async getTickets(params?: {
    status?: string;
    deviceId?: string;
    page?: number;
    limit?: number;
  }): Promise<ApiResponse<TicketListResponse>> {
    try {
      const response = await api.get('/tickets', { params });
      return response.data;
    } catch (error) {
      console.error('æŸ¥è©¢å·¥å–®åˆ—è¡¨å¤±æ•—:', error);
      throw error;
    }
  }

  /**
   * æŸ¥è©¢å–®ä¸€å·¥å–®è©³æƒ…
   * @param id å·¥å–® ID
   * @returns Promise<ApiResponse<Ticket>>
   */
  static async getTicket(id: string): Promise<ApiResponse<Ticket>> {
    try {
      const response = await api.get(`/tickets/${id}`);
      return response.data;
    } catch (error) {
      console.error('æŸ¥è©¢å·¥å–®è©³æƒ…å¤±æ•—:', error);
      throw error;
    }
  }

  /**
   * æ›´æ–°å·¥å–®
   * @param id å·¥å–® ID
   * @param updateData æ›´æ–°è³‡æ–™
   * @returns Promise<ApiResponse<Ticket>>
   */
  static async updateTicket(id: string, updateData: UpdateTicketRequest): Promise<ApiResponse<Ticket>> {
    try {
      const response = await api.put(`/tickets/${id}`, updateData);
      return response.data;
    } catch (error) {
      console.error('æ›´æ–°å·¥å–®å¤±æ•—:', error);
      throw error;
    }
  }
}

export default api;

```

```typescript
import axios from 'axios';
import { 
  ProductionTarget, 
  CreateTargetRequest, 
  UpdateTargetRequest, 
  TargetListResponse,
  TicketSchedule,
  TicketScheduleWithRelations,
  CreateScheduleRequest,
  UpdateScheduleRequest
} from '../types/target';
import { ApiResponse } from '../types/ticket';

// å‹•æ…‹ç²å– API URLï¼ˆæ”¯æ´å¤–éƒ¨è¨ªå•ï¼‰
const getApiBaseUrl = (): string => {
  // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸
  if (process.env.REACT_APP_API_URL) {
    return process.env.REACT_APP_API_URL;
  }

  // å¦‚æœç•¶å‰è¨ªå•åœ°å€ä¸æ˜¯ localhostï¼Œè‡ªå‹•æ§‹å»º API URL
  const currentHost = typeof window !== 'undefined' ? window.location.hostname : 'localhost';
  
  if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
    // æœ¬æ©Ÿè¨ªå•ï¼Œä½¿ç”¨ localhost
    return 'http://localhost:5000/api';
  } else {
    // å¤–éƒ¨è¨ªå•ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰ï¼Œæ§‹å»ºå°æ‡‰çš„ API URL
    return `http://${currentHost}:5000/api`;
  }
};

// å»ºç«‹ axios å¯¦ä¾‹ï¼Œè¨­å®šåŸºç¤ URL
const api = axios.create({
  baseURL: getApiBaseUrl(),
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// é ç”Ÿç”¢ç›®æ¨™ API æœå‹™é¡åˆ¥
export class TargetService {
  /**
   * å–å¾—æ‰€æœ‰é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨
   * @param page é ç¢¼
   * @param limit æ¯é æ•¸é‡
   * @param status ç‹€æ…‹ç¯©é¸
   */
  static async getTargets(
    page: number = 1, 
    limit: number = 10, 
    status?: string
  ): Promise<ApiResponse<TargetListResponse>> {
    try {
      const params = new URLSearchParams({
        page: page.toString(),
        limit: limit.toString(),
        ...(status && { status }),
      });

      const response = await api.get(`/targets?${params}`);
      return response.data;
    } catch (error: any) {
      console.error('å–å¾—é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å–å¾—é ç”Ÿç”¢ç›®æ¨™åˆ—è¡¨å¤±æ•—',
      };
    }
  }

  /**
   * å–å¾—å–®ä¸€é ç”Ÿç”¢ç›®æ¨™è©³æƒ…
   * @param targetId ç›®æ¨™ ID
   */
  static async getTarget(targetId: string): Promise<ApiResponse<ProductionTarget>> {
    try {
      const response = await api.get(`/targets/${targetId}`);
      return response.data;
    } catch (error: any) {
      console.error('å–å¾—é ç”Ÿç”¢ç›®æ¨™è©³æƒ…å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å–å¾—é ç”Ÿç”¢ç›®æ¨™è©³æƒ…å¤±æ•—',
      };
    }
  }

  /**
   * å»ºç«‹æ–°çš„é ç”Ÿç”¢ç›®æ¨™
   * @param data ç›®æ¨™è³‡æ–™
   */
  static async createTarget(data: CreateTargetRequest): Promise<ApiResponse<ProductionTarget>> {
    try {
      const response = await api.post('/targets', data);
      return response.data;
    } catch (error: any) {
      console.error('å»ºç«‹é ç”Ÿç”¢ç›®æ¨™å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å»ºç«‹é ç”Ÿç”¢ç›®æ¨™å¤±æ•—',
      };
    }
  }

  /**
   * æ›´æ–°é ç”Ÿç”¢ç›®æ¨™
   * @param targetId ç›®æ¨™ ID
   * @param data æ›´æ–°è³‡æ–™
   */
  static async updateTarget(
    targetId: string, 
    data: UpdateTargetRequest
  ): Promise<ApiResponse<ProductionTarget>> {
    try {
      const response = await api.put(`/targets/${targetId}`, data);
      return response.data;
    } catch (error: any) {
      console.error('æ›´æ–°é ç”Ÿç”¢ç›®æ¨™å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'æ›´æ–°é ç”Ÿç”¢ç›®æ¨™å¤±æ•—',
      };
    }
  }

  /**
   * åˆªé™¤é ç”Ÿç”¢ç›®æ¨™
   * @param targetId ç›®æ¨™ ID
   */
  static async deleteTarget(targetId: string): Promise<ApiResponse<void>> {
    try {
      const response = await api.delete(`/targets/${targetId}`);
      return response.data;
    } catch (error: any) {
      console.error('åˆªé™¤é ç”Ÿç”¢ç›®æ¨™å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'åˆªé™¤é ç”Ÿç”¢ç›®æ¨™å¤±æ•—',
      };
    }
  }

  /**
   * å–å¾—æŒ‡å®šç›®æ¨™çš„å·¥å–®æ’ç¨‹
   * @param targetId ç›®æ¨™ ID
   */
  static async getTargetSchedules(targetId: string): Promise<ApiResponse<TicketSchedule[]>> {
    try {
      const response = await api.get(`/schedules/target/${targetId}`);
      return response.data;
    } catch (error: any) {
      console.error('å–å¾—å·¥å–®æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å–å¾—å·¥å–®æ’ç¨‹å¤±æ•—',
      };
    }
  }

  /**
   * å–å¾—æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰æ’ç¨‹
   * @param date æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
   */
  static async getSchedulesByDate(date: string): Promise<ApiResponse<TicketScheduleWithRelations[]>> {
    try {
      const response = await api.get(`/schedules?date=${date}&limit=1000`);
      if (response.data.success && response.data.data?.schedules) {
        return {
          success: true,
          message: response.data.message,
          data: response.data.data.schedules,
        };
      }
      return {
        success: false,
        message: response.data.message || 'å–å¾—ä»Šæ—¥æ’ç¨‹å¤±æ•—',
      };
    } catch (error: any) {
      console.error('å–å¾—ä»Šæ—¥æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å–å¾—ä»Šæ—¥æ’ç¨‹å¤±æ•—',
      };
    }
  }

  /**
   * å»ºç«‹å·¥å–®æ’ç¨‹
   * @param data æ’ç¨‹è³‡æ–™
   */
  static async createSchedule(data: CreateScheduleRequest): Promise<ApiResponse<TicketScheduleWithRelations>> {
    try {
      const response = await api.post('/schedules', data);
      return response.data;
    } catch (error: any) {
      console.error('å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'å»ºç«‹å·¥å–®æ’ç¨‹å¤±æ•—',
      };
    }
  }

  /**
   * æ›´æ–°å·¥å–®æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   * @param data æ›´æ–°è³‡æ–™
   */
  static async updateSchedule(
    scheduleId: string, 
    data: UpdateScheduleRequest
  ): Promise<ApiResponse<TicketSchedule>> {
    try {
      const response = await api.put(`/schedules/${scheduleId}`, data);
      return response.data;
    } catch (error: any) {
      console.error('æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'æ›´æ–°å·¥å–®æ’ç¨‹å¤±æ•—',
      };
    }
  }

  /**
   * åˆªé™¤å·¥å–®æ’ç¨‹
   * @param scheduleId æ’ç¨‹ ID
   */
  static async deleteSchedule(scheduleId: string): Promise<ApiResponse<void>> {
    try {
      const response = await api.delete(`/schedules/${scheduleId}`);
      return response.data;
    } catch (error: any) {
      console.error('åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'åˆªé™¤å·¥å–®æ’ç¨‹å¤±æ•—',
      };
    }
  }
}

```

æ›´æ–°å…¶ä»– API æœå‹™æ–‡ä»¶ï¼š


```typescript
/**
 * ç…§ç‰‡ç›¸é—œ API æœå‹™
 * è™•ç†ç…§ç‰‡ä¸Šå‚³ã€æŸ¥çœ‹ã€åˆªé™¤ç­‰åŠŸèƒ½
 */

import axios from 'axios';

// å‹•æ…‹ç²å– API URLï¼ˆæ”¯æ´å¤–éƒ¨è¨ªå•ï¼‰
const getApiBaseUrl = (): string => {
  // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸
  if (process.env.REACT_APP_API_URL) {
    return process.env.REACT_APP_API_URL;
  }

  // å¦‚æœç•¶å‰è¨ªå•åœ°å€ä¸æ˜¯ localhostï¼Œè‡ªå‹•æ§‹å»º API URL
  const currentHost = typeof window !== 'undefined' ? window.location.hostname : 'localhost';
  
  if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
    // æœ¬æ©Ÿè¨ªå•ï¼Œä½¿ç”¨ localhost
    return 'http://localhost:5000/api';
  } else {
    // å¤–éƒ¨è¨ªå•ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰ï¼Œæ§‹å»ºå°æ‡‰çš„ API URL
    return `http://${currentHost}:5000/api`;
  }
};

// API åŸºç¤é…ç½®
const api = axios.create({
  baseURL: getApiBaseUrl(),
  timeout: 30000, // 30 ç§’è¶…æ™‚ï¼ˆç…§ç‰‡ä¸Šå‚³å¯èƒ½éœ€è¦æ›´é•·æ™‚é–“ï¼‰
  headers: {
    'Content-Type': 'application/json; charset=utf-8',
  },
});

// ç…§ç‰‡ä»‹é¢
export interface Photo {
  id: string;
  filename: string;
  originalName: string;
  fileSize: number;
  mimeType: string;
  description?: string;
  uploadedAt: string;
  url: string;
}

// API å›æ‡‰ä»‹é¢
export interface ApiResponse<T> {
  success: boolean;
  message: string;
  data?: T;
  error?: string;
}

// ç…§ç‰‡åˆ—è¡¨å›æ‡‰ä»‹é¢
export interface PhotoListResponse {
  photos: Photo[];
}

/**
 * ç…§ç‰‡æœå‹™é¡
 */
export class PhotoService {
  /**
   * ä¸Šå‚³ç…§ç‰‡
   * @param ticketId å·¥å–®ID
   * @param file ç…§ç‰‡æ–‡ä»¶
   * @param description ç…§ç‰‡æè¿°
   */
  static async uploadPhoto(
    ticketId: string,
    file: File,
    description?: string
  ): Promise<ApiResponse<Photo>> {
    try {
      const formData = new FormData();
      formData.append('photo', file);
      formData.append('ticketId', ticketId);
      if (description) {
        formData.append('description', description);
      }

      const response = await api.post('/photos/upload', formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      });

      return response.data;
    } catch (error: any) {
      console.error('ä¸Šå‚³ç…§ç‰‡å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'ä¸Šå‚³ç…§ç‰‡å¤±æ•—',
      };
    }
  }

  /**
   * ç²å–æŒ‡å®šå·¥å–®çš„æ‰€æœ‰ç…§ç‰‡
   * @param ticketId å·¥å–®ID
   */
  static async getTicketPhotos(ticketId: string): Promise<ApiResponse<Photo[]>> {
    try {
      const response = await api.get(`/photos/ticket/${ticketId}`);
      return response.data;
    } catch (error: any) {
      console.error('ç²å–ç…§ç‰‡åˆ—è¡¨å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'ç²å–ç…§ç‰‡åˆ—è¡¨å¤±æ•—',
      };
    }
  }

  /**
   * åˆªé™¤ç…§ç‰‡
   * @param photoId ç…§ç‰‡ID
   */
  static async deletePhoto(photoId: string): Promise<ApiResponse<void>> {
    try {
      const response = await api.delete(`/photos/${photoId}`);
      return response.data;
    } catch (error: any) {
      console.error('åˆªé™¤ç…§ç‰‡å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'åˆªé™¤ç…§ç‰‡å¤±æ•—',
      };
    }
  }

  /**
   * ç²å–ç…§ç‰‡æŸ¥çœ‹URL
   * @param photoId ç…§ç‰‡ID
   */
  static getPhotoViewUrl(photoId: string): string {
    return `${process.env.REACT_APP_API_URL || 'http://localhost:5000/api'}/photos/${photoId}/view`;
  }
}

```

æ›´æ–°å‰©é¤˜çš„ API æœå‹™æ–‡ä»¶ï¼Œä¸¦å»ºç«‹ä¸€å€‹å¿«é€Ÿåˆ†äº«æŒ‡å—ï¼š


```typescript
import axios from 'axios';
import { ApiResponse } from '../types/ticket';

// å‹•æ…‹ç²å– API URLï¼ˆæ”¯æ´å¤–éƒ¨è¨ªå•ï¼‰
const getApiBaseUrl = (): string => {
  // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸
  if (process.env.REACT_APP_API_URL) {
    return process.env.REACT_APP_API_URL;
  }

  // å¦‚æœç•¶å‰è¨ªå•åœ°å€ä¸æ˜¯ localhostï¼Œè‡ªå‹•æ§‹å»º API URL
  const currentHost = typeof window !== 'undefined' ? window.location.hostname : 'localhost';
  
  if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
    // æœ¬æ©Ÿè¨ªå•ï¼Œä½¿ç”¨ localhost
    return 'http://localhost:5000/api';
  } else {
    // å¤–éƒ¨è¨ªå•ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰ï¼Œæ§‹å»ºå°æ‡‰çš„ API URL
    return `http://${currentHost}:5000/api`;
  }
};

const API_BASE_URL = getApiBaseUrl();

// ç‰ˆæœ¬è³‡è¨Šä»‹é¢
export interface VersionInfo {
  version: string;
  buildNumber: string;
  releaseDate: string;
  changelog: ChangelogEntry[];
  features: string[];
}

export interface ChangelogEntry {
  version: string;
  date: string;
  changes: string[];
}

export interface VersionCheckResult {
  hasUpdate: boolean;
  currentVersion: string;
  clientVersion: string;
  latestChangelog: ChangelogEntry;
  updateAvailable: boolean;
}

/**
 * ç‰ˆæœ¬æœå‹™é¡
 * æä¾›ç‰ˆæœ¬è³‡è¨Šã€æ›´æ–°æ—¥èªŒå’Œæ›´æ–°æª¢æŸ¥åŠŸèƒ½
 */
class VersionService {
  /**
   * ç²å–ç•¶å‰ç‰ˆæœ¬è³‡è¨Š
   * @returns Promise<ApiResponse<VersionInfo>>
   */
  async getVersionInfo(): Promise<ApiResponse<VersionInfo>> {
    try {
      const response = await axios.get(`${API_BASE_URL}/version`);
      return response.data;
    } catch (error: any) {
      console.error('ç²å–ç‰ˆæœ¬è³‡è¨ŠéŒ¯èª¤:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'ç²å–ç‰ˆæœ¬è³‡è¨Šå¤±æ•—',
        data: undefined
      };
    }
  }

  /**
   * ç²å–æ›´æ–°æ—¥èªŒ
   * @returns Promise<ApiResponse<{changelog: ChangelogEntry[], currentVersion: string, buildNumber: string}>>
   */
  async getChangelog(): Promise<ApiResponse<{changelog: ChangelogEntry[], currentVersion: string, buildNumber: string}>> {
    try {
      const response = await axios.get(`${API_BASE_URL}/version/changelog`);
      return response.data;
    } catch (error: any) {
      console.error('ç²å–æ›´æ–°æ—¥èªŒéŒ¯èª¤:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'ç²å–æ›´æ–°æ—¥èªŒå¤±æ•—',
        data: undefined
      };
    }
  }

  /**
   * æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°
   * @param clientVersion å®¢æˆ¶ç«¯ç‰ˆæœ¬
   * @returns Promise<ApiResponse<VersionCheckResult>>
   */
  async checkForUpdates(clientVersion: string): Promise<ApiResponse<VersionCheckResult>> {
    try {
      const response = await axios.get(`${API_BASE_URL}/version/check`, {
        params: { version: clientVersion }
      });
      return response.data;
    } catch (error: any) {
      console.error('æª¢æŸ¥æ›´æ–°éŒ¯èª¤:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'æª¢æŸ¥æ›´æ–°å¤±æ•—',
        data: undefined
      };
    }
  }

  /**
   * ç²å–æœ¬åœ°ç‰ˆæœ¬è³‡è¨Šï¼ˆå¾package.jsonï¼‰
   * @returns VersionInfo
   */
  getLocalVersionInfo(): VersionInfo {
    return {
      version: '1.2.0',
      buildNumber: '20241027-001',
      releaseDate: '2024-10-27',
      changelog: [
        {
          version: '1.2.0',
          date: '2024-10-27',
          changes: [
            'âœ¨ æ–°å¢å¤–éƒ¨è¨­å‚™è¨ªå•åŠŸèƒ½',
            'ğŸ”§ ä¿®æ­£Windowsç’°å¢ƒè®Šæ•¸å•é¡Œ',
            'ğŸ“± æ”¯æ´æ‰‹æ©Ÿ/å¹³æ¿è¨ªå•',
            'ğŸ¨ å„ªåŒ–æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ',
            'ğŸ–¼ï¸ å®Œå–„ç…§ç‰‡ç®¡ç†åŠŸèƒ½'
          ]
        }
      ],
      features: [
        'å·¥å–®ç®¡ç†ç³»çµ±',
        'é ç”Ÿç”¢ç›®æ¨™ç®¡ç†', 
        'å·¥å–®æ’ç¨‹åŠŸèƒ½',
        'ç…§ç‰‡ä¸Šå‚³ç®¡ç†',
        'å¤–éƒ¨è¨­å‚™è¨ªå•',
        'æ™ºæ…§é†«ç™‚ä¸»é¡Œ'
      ]
    };
  }
}

export default new VersionService();

```

```typescript
/**
 * ç…§ç‰‡ç›¸é—œ API æœå‹™
 * è™•ç†ç…§ç‰‡ä¸Šå‚³ã€æŸ¥çœ‹ã€åˆªé™¤ç­‰åŠŸèƒ½
 */

import axios from 'axios';

// å‹•æ…‹ç²å– API URLï¼ˆæ”¯æ´å¤–éƒ¨è¨ªå•ï¼‰
const getApiBaseUrl = (): string => {
  // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸
  if (process.env.REACT_APP_API_URL) {
    return process.env.REACT_APP_API_URL;
  }

  // å¦‚æœç•¶å‰è¨ªå•åœ°å€ä¸æ˜¯ localhostï¼Œè‡ªå‹•æ§‹å»º API URL
  const currentHost = typeof window !== 'undefined' ? window.location.hostname : 'localhost';
  
  if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
    // æœ¬æ©Ÿè¨ªå•ï¼Œä½¿ç”¨ localhost
    return 'http://localhost:5000/api';
  } else {
    // å¤–éƒ¨è¨ªå•ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰ï¼Œæ§‹å»ºå°æ‡‰çš„ API URL
    return `http://${currentHost}:5000/api`;
  }
};

// API åŸºç¤é…ç½®
const api = axios.create({
  baseURL: getApiBaseUrl(),
  timeout: 30000, // 30 ç§’è¶…æ™‚ï¼ˆç…§ç‰‡ä¸Šå‚³å¯èƒ½éœ€è¦æ›´é•·æ™‚é–“ï¼‰
  headers: {
    'Content-Type': 'application/json; charset=utf-8',
  },
});

// ç…§ç‰‡ä»‹é¢
export interface Photo {
  id: string;
  filename: string;
  originalName: string;
  fileSize: number;
  mimeType: string;
  description?: string;
  uploadedAt: string;
  url: string;
}

// API å›æ‡‰ä»‹é¢
export interface ApiResponse<T> {
  success: boolean;
  message: string;
  data?: T;
  error?: string;
}

// ç…§ç‰‡åˆ—è¡¨å›æ‡‰ä»‹é¢
export interface PhotoListResponse {
  photos: Photo[];
}

/**
 * ç…§ç‰‡æœå‹™é¡
 */
export class PhotoService {
  /**
   * ä¸Šå‚³ç…§ç‰‡
   * @param ticketId å·¥å–®ID
   * @param file ç…§ç‰‡æ–‡ä»¶
   * @param description ç…§ç‰‡æè¿°
   */
  static async uploadPhoto(
    ticketId: string,
    file: File,
    description?: string
  ): Promise<ApiResponse<Photo>> {
    try {
      const formData = new FormData();
      formData.append('photo', file);
      formData.append('ticketId', ticketId);
      if (description) {
        formData.append('description', description);
      }

      const response = await api.post('/photos/upload', formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      });

      return response.data;
    } catch (error: any) {
      console.error('ä¸Šå‚³ç…§ç‰‡å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'ä¸Šå‚³ç…§ç‰‡å¤±æ•—',
      };
    }
  }

  /**
   * ç²å–æŒ‡å®šå·¥å–®çš„æ‰€æœ‰ç…§ç‰‡
   * @param ticketId å·¥å–®ID
   */
  static async getTicketPhotos(ticketId: string): Promise<ApiResponse<Photo[]>> {
    try {
      const response = await api.get(`/photos/ticket/${ticketId}`);
      return response.data;
    } catch (error: any) {
      console.error('ç²å–ç…§ç‰‡åˆ—è¡¨å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'ç²å–ç…§ç‰‡åˆ—è¡¨å¤±æ•—',
      };
    }
  }

  /**
   * åˆªé™¤ç…§ç‰‡
   * @param photoId ç…§ç‰‡ID
   */
  static async deletePhoto(photoId: string): Promise<ApiResponse<void>> {
    try {
      const response = await api.delete(`/photos/${photoId}`);
      return response.data;
    } catch (error: any) {
      console.error('åˆªé™¤ç…§ç‰‡å¤±æ•—:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'åˆªé™¤ç…§ç‰‡å¤±æ•—',
      };
    }
  }

  /**
   * ç²å–ç…§ç‰‡æŸ¥çœ‹URL
   * @param photoId ç…§ç‰‡ID
   */
  static getPhotoViewUrl(photoId: string): string {
    // ä½¿ç”¨å‹•æ…‹ API URL
    const apiBaseUrl = getApiBaseUrl();
    return `${apiBaseUrl}/photos/${photoId}/view`;
  }
}

```

å»ºç«‹å¿«é€Ÿåˆ†äº«æŒ‡å—ï¼š


```plaintext
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         å·¥å–®ç®¡ç†ç³»çµ± - å¿«é€Ÿåˆ†äº«çµ¦æœ‹å‹æŒ‡å—                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªå‹•å•Ÿå‹•è…³æœ¬ï¼ˆæœ€ç°¡å–®ï¼Œæ¨è–¦ï¼ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. é›™æ“Šé‹è¡Œï¼šstart-for-sharing.bat
2. ç­‰å¾…æœå‹™å•Ÿå‹•ï¼ˆç´„ 10-15 ç§’ï¼‰
3. è…³æœ¬æœƒé¡¯ç¤ºæ‚¨çš„ IP åœ°å€å’Œåˆ†äº«ç¶²å€
4. å°‡ç¶²å€åˆ†äº«çµ¦æœ‹å‹å³å¯ï¼

ä¾‹å¦‚é¡¯ç¤ºï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ“± åˆ†äº«çµ¦æœ‹å‹çš„è¨ªå•åœ°å€ï¼š                â”‚
  â”‚    å‰ç«¯ç¶²é : http://192.168.0.186:3000  â”‚
  â”‚    å¾Œç«¯API: http://192.168.0.186:5000  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ æ–¹æ³•äºŒï¼šæ‰‹å‹•å•Ÿå‹•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ­¥é©Ÿ 1ï¼šç²å–æ‚¨çš„ IP åœ°å€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  é›™æ“Šé‹è¡Œï¼šget-ip.bat
  æˆ–æ‰‹å‹•æŸ¥è©¢ï¼šipconfig | findstr /i "IPv4"
  
  ä¾‹å¦‚é¡¯ç¤ºï¼šIPv4 åœ°å€ . . . . . . : 192.168.0.186

æ­¥é©Ÿ 2ï¼šå•Ÿå‹•æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  A. å•Ÿå‹•å¾Œç«¯æœå‹™ï¼š
     æ‰“é–‹å‘½ä»¤æç¤ºå­—å…ƒï¼ŒåŸ·è¡Œï¼š
     cd server
     npm run dev
  
  B. å•Ÿå‹•å‰ç«¯æœå‹™ï¼ˆå…è¨±å¤–éƒ¨è¨ªå•ï¼‰ï¼š
     æ‰“é–‹æ–°çš„å‘½ä»¤æç¤ºå­—å…ƒï¼ŒåŸ·è¡Œï¼š
     cd client
     set HOST=0.0.0.0
     npm start

æ­¥é©Ÿ 3ï¼šåˆ†äº«ç¶²å€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  å°‡ä»¥ä¸‹ç¶²å€åˆ†äº«çµ¦æœ‹å‹ï¼š
  http://æ‚¨çš„IPåœ°å€:3000
  
  ä¾‹å¦‚ï¼šhttp://192.168.0.186:3000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… è¨ªå•æ¢ä»¶
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  å¿…é ˆæ»¿è¶³ï¼š
  âœ“ æ‚¨çš„é›»è…¦å’Œæœ‹å‹çš„è¨­å‚™åœ¨åŒä¸€ WiFi ç¶²è·¯
  âœ“ å‰ç«¯å’Œå¾Œç«¯æœå‹™éƒ½åœ¨é‹è¡Œ
  âœ“ Windows é˜²ç«ç‰†å…è¨± Node.js è¨ªå•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”§ å¦‚æœæœ‹å‹ç„¡æ³•è¨ªå•ï¼ˆé˜²ç«ç‰†è¨­å®šï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ–¹æ³• 1ï¼šé€šéæ§åˆ¶å°è¨­å®š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. æ§åˆ¶å° â†’ ç³»çµ±èˆ‡å®‰å…¨æ€§ â†’ Windows Defender é˜²ç«ç‰†
  2. é»æ“Šã€Œå…è¨±æ‡‰ç”¨ç¨‹å¼é€šéé˜²ç«ç‰†ã€
  3. æ‰¾åˆ°ã€ŒNode.jsã€æˆ–ã€ŒNode.exeã€
  4. å‹¾é¸ã€Œç§äººç¶²è·¯ã€é¸é …

æ–¹æ³• 2ï¼šPowerShellï¼ˆç®¡ç†å“¡æ¬Šé™ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  New-NetFirewallRule -DisplayName "Node.js Server" `
    -Direction Inbound -Protocol TCP -LocalPort 3000,5000 `
    -Action Allow -Profile Private

æ–¹æ³• 3ï¼šæš«æ™‚é—œé–‰é˜²ç«ç‰†æ¸¬è©¦ï¼ˆåƒ…æ¸¬è©¦ç”¨ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  âš ï¸ åƒ…ç”¨æ–¼æ¸¬è©¦ï¼Œä¸å»ºè­°é•·æœŸä½¿ç”¨

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ æç¤º
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â€¢ IP åœ°å€å¯èƒ½æœƒè®Šï¼šé‡æ–°é€£æ¥ WiFi å¾Œè¨˜å¾—é‡æ–°æª¢æŸ¥
  â€¢ å»ºè­°å…ˆåœ¨è‡ªå·±æ‰‹æ©Ÿä¸Šæ¸¬è©¦ï¼ˆåŒä¸€ WiFiï¼‰
  â€¢ å¯ä»¥åˆ†äº« API æ–‡æª”ï¼šserver/API_COMPLETE.md
  â€¢ è©³ç´°èªªæ˜è«‹æŸ¥çœ‹ï¼šåˆ†äº«çµ¦æœ‹å‹ä½¿ç”¨æŒ‡å—.md

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ æ¸¬è©¦é€£ç·š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  åœ¨æœ‹å‹çš„è¨­å‚™ç€è¦½å™¨ä¸­ï¼š
  1. æ‰“é–‹ http://æ‚¨çš„IP:3000
  2. å¦‚æœçœ‹åˆ°å·¥å–®ç®¡ç†ç³»çµ±é é¢ï¼Œè¡¨ç¤ºæˆåŠŸï¼
  3. å¦‚æœç„¡æ³•é€£æ¥ï¼Œæª¢æŸ¥ï¼š
     - æ˜¯å¦åœ¨åŒä¸€ WiFi
     - é˜²ç«ç‰†æ˜¯å¦é˜»æ“‹
     - æœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç¥æ‚¨åˆ†äº«é †åˆ©ï¼ğŸ‰

```

å·²è¨­å®šå®Œæˆï¼Œå¯ç›´æ¥åˆ†äº«çµ¦æœ‹å‹ã€‚ä»¥ä¸‹æ˜¯åšæ³•ï¼š

## å·²å®Œæˆçš„è¨­å®š

1. **å»ºç«‹è‡ªå‹•å•Ÿå‹•è…³æœ¬**ï¼š`start-for-sharing.bat`
   - è‡ªå‹•åµæ¸¬ IP åœ°å€
   - è‡ªå‹•è¨­å®šç’°å¢ƒè®Šæ•¸
   - é¡¯ç¤ºåˆ†äº«ç¶²å€

2. **æ›´æ–°å‰ç«¯ API æœå‹™**ï¼šè‡ªå‹•åµæ¸¬ä¸¦ä½¿ç”¨æ­£ç¢ºçš„ API URL
   - æœ¬æ©Ÿè¨ªå•æ™‚ä½¿ç”¨ `localhost`
   - å¤–éƒ¨è¨ªå•æ™‚è‡ªå‹•ä½¿ç”¨ IP åœ°å€

3. **å»ºç«‹ä½¿ç”¨æŒ‡å—**ï¼š
   - `å¿«é€Ÿåˆ†äº«æŒ‡å—.txt` - ç°¡æ˜“å¿«é€ŸæŒ‡å—
   - `åˆ†äº«çµ¦æœ‹å‹ä½¿ç”¨æŒ‡å—.md` - è©³ç´°èªªæ˜æ–‡æª”

## å¦‚ä½•åˆ†äº«çµ¦æœ‹å‹

### æœ€ç°¡å–®æ–¹æ³•ï¼ˆæ¨è–¦ï¼‰

1. é›™æ“Šé‹è¡Œï¼š`start-for-sharing.bat`
2. ç­‰å¾…æœå‹™å•Ÿå‹•å®Œæˆ
3. è…³æœ¬æœƒé¡¯ç¤ºæ‚¨çš„ IP åœ°å€å’Œåˆ†äº«ç¶²å€ï¼Œä¾‹å¦‚ï¼š
   ```
   ğŸ“± åˆ†äº«çµ¦æœ‹å‹çš„è¨ªå•åœ°å€ï¼š
      å‰ç«¯ç¶²é : http://192.168.0.186:3000
   ```
4. å°‡æ­¤ç¶²å€åˆ†äº«çµ¦æœ‹å‹å³å¯

### è¨ªå•æ¢ä»¶

- æœ‹å‹çš„è¨­å‚™èˆ‡æ‚¨çš„é›»è…¦éœ€åœ¨åŒä¸€ WiFi ç¶²è·¯
- æœå‹™æ­£åœ¨é‹è¡Œä¸­
- Windows é˜²ç«ç‰†å…è¨±è¨ªå•ï¼ˆé¦–æ¬¡å¯èƒ½éœ€è¦è¨­å®šï¼‰

### æ¸¬è©¦æ­¥é©Ÿ

1. å…ˆåœ¨æ‚¨çš„æ‰‹æ©Ÿä¸Šæ¸¬è©¦ï¼ˆé€£åŒä¸€å€‹ WiFiï¼‰ï¼š
   - æ‰“é–‹ç€è¦½å™¨
   - è¼¸å…¥ï¼š`http://æ‚¨çš„IP:3000`
   - è‹¥èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå³å¯åˆ†äº«çµ¦æœ‹å‹

2. è‹¥ç„¡æ³•è¨ªå•ï¼Œæª¢æŸ¥é˜²ç«ç‰†ï¼š
   - æ§åˆ¶å° â†’ ç³»çµ±èˆ‡å®‰å…¨æ€§ â†’ Windows Defender é˜²ç«ç‰†
   - å…è¨± Node.js é€šéé˜²ç«ç‰†ï¼ˆç§äººç¶²è·¯ï¼‰

## æ‚¨çš„ç•¶å‰ IP åœ°å€

æ ¹æ“šå‰›æ‰çš„æª¢æ¸¬ï¼Œæ‚¨çš„ IP åœ°å€æ˜¯ï¼š`192.168.0.186`

æœ‹å‹å¯ä»¥é€šéä»¥ä¸‹ç¶²å€è¨ªå•ï¼š
- å‰ç«¯ç¶²é ï¼š`http://192.168.0.186:3000`
- å¾Œç«¯ APIï¼š`http://192.168.0.186:5000`

ç¾åœ¨å¯ä»¥é›™æ“Šé‹è¡Œ `start-for-sharing.bat` å•Ÿå‹•æœå‹™ï¼Œç„¶å¾Œåˆ†äº«ç¶²å€çµ¦æœ‹å‹æ¸¬è©¦ã€‚ç³»çµ±æœƒè‡ªå‹•è™•ç†å¤–éƒ¨è¨ªå•çš„ API é€£æ¥å•é¡Œã€‚

```plaintext
   ğŸ“± åˆ†äº«çµ¦æœ‹å‹çš„è¨ªå•åœ°å€ï¼š
      å‰ç«¯ç¶²é : http://192.168.0.186:3000
```

---

**User**

è«‹æª¢æŸ¥è³‡æ–™åº«è£¡çš„è³‡æ–™

---

**Cursor**


æª¢æŸ¥è³‡æ–™åº«è³‡æ–™ã€‚å…ˆäº†è§£è³‡æ–™åº«çµæ§‹å’Œä½ç½®ã€‚


å»ºç«‹æŸ¥è©¢è…³æœ¬ï¼Œæª¢æŸ¥è³‡æ–™åº«å…§å®¹ï¼š


```javascript
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function checkDatabase() {
  try {
    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘          è³‡æ–™åº«å…§å®¹æª¢æŸ¥                                       â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    // 1. æª¢æŸ¥å·¥å–® (Tickets)
    console.log('ğŸ“‹ å·¥å–®è³‡æ–™ (Tickets)');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    const tickets = await prisma.ticket.findMany({
      include: {
        schedules: true,
        photos: true,
      },
      orderBy: { createdAt: 'desc' }
    });
    console.log(`ç¸½æ•¸: ${tickets.length} ç­†\n`);
    
    if (tickets.length > 0) {
      tickets.forEach((ticket, index) => {
        console.log(`${index + 1}. å·¥å–® ID: ${ticket.id}`);
        console.log(`   è¨­å‚™ ID: ${ticket.deviceId}`);
        console.log(`   ç‹€æ…‹: ${ticket.status}`);
        console.log(`   å½±åƒ ID: ${ticket.imageId || '(ç„¡)'}`);
        console.log(`   æ’ç¨‹æ•¸: ${ticket.schedules.length}`);
        console.log(`   ç…§ç‰‡æ•¸: ${ticket.photos.length}`);
        console.log(`   å»ºç«‹æ™‚é–“: ${ticket.createdAt.toLocaleString('zh-TW')}`);
        console.log(`   æ›´æ–°æ™‚é–“: ${ticket.updatedAt.toLocaleString('zh-TW')}`);
        console.log('');
      });
    } else {
      console.log('  (ç„¡è³‡æ–™)\n');
    }

    // 2. æª¢æŸ¥ç”Ÿç”¢ç›®æ¨™ (ProductionTargets)
    console.log('ğŸ¯ ç”Ÿç”¢ç›®æ¨™è³‡æ–™ (ProductionTargets)');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    const targets = await prisma.productionTarget.findMany({
      include: {
        schedules: {
          include: {
            ticket: true,
          }
        },
      },
      orderBy: { createdAt: 'desc' }
    });
    console.log(`ç¸½æ•¸: ${targets.length} ç­†\n`);
    
    if (targets.length > 0) {
      targets.forEach((target, index) => {
        console.log(`${index + 1}. ç›®æ¨™ ID: ${target.id}`);
        console.log(`   åç¨±: ${target.name}`);
        console.log(`   æè¿°: ${target.description || '(ç„¡)'}`);
        console.log(`   é è¨ˆå®Œæˆæ—¥æœŸ: ${target.expectedCompletionDate}`);
        console.log(`   ç‹€æ…‹: ${target.status}`);
        console.log(`   æ’ç¨‹æ•¸: ${target.schedules.length}`);
        console.log(`   å»ºç«‹æ™‚é–“: ${target.createdAt.toLocaleString('zh-TW')}`);
        console.log(`   æ›´æ–°æ™‚é–“: ${target.updatedAt.toLocaleString('zh-TW')}`);
        console.log('');
      });
    } else {
      console.log('  (ç„¡è³‡æ–™)\n');
    }

    // 3. æª¢æŸ¥å·¥å–®æ’ç¨‹ (TicketSchedules)
    console.log('ğŸ“… å·¥å–®æ’ç¨‹è³‡æ–™ (TicketSchedules)');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    const schedules = await prisma.ticketSchedule.findMany({
      include: {
        ticket: true,
        target: true,
      },
      orderBy: [
        { scheduledDate: 'asc' },
        { scheduledTime: 'asc' },
      ]
    });
    console.log(`ç¸½æ•¸: ${schedules.length} ç­†\n`);
    
    if (schedules.length > 0) {
      schedules.forEach((schedule, index) => {
        console.log(`${index + 1}. æ’ç¨‹ ID: ${schedule.id}`);
        console.log(`   å·¥å–® ID: ${schedule.ticketId}`);
        console.log(`   ç›®æ¨™åç¨±: ${schedule.target.name}`);
        console.log(`   æ’ç¨‹æ—¥æœŸ: ${schedule.scheduledDate}`);
        console.log(`   æ’ç¨‹æ™‚é–“: ${schedule.scheduledTime || '(ç„¡)'}`);
        console.log(`   å„ªå…ˆç´š: ${schedule.priority}`);
        console.log(`   ç‹€æ…‹: ${schedule.status}`);
        console.log(`   å»ºç«‹æ™‚é–“: ${schedule.createdAt.toLocaleString('zh-TW')}`);
        console.log('');
      });
    } else {
      console.log('  (ç„¡è³‡æ–™)\n');
    }

    // 4. æª¢æŸ¥ç…§ç‰‡ (Photos)
    console.log('ğŸ“· ç…§ç‰‡è³‡æ–™ (Photos)');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    const photos = await prisma.photo.findMany({
      include: {
        ticket: true,
      },
      orderBy: { uploadedAt: 'desc' }
    });
    console.log(`ç¸½æ•¸: ${photos.length} ç­†\n`);
    
    if (photos.length > 0) {
      photos.forEach((photo, index) => {
        const fileSizeKB = (photo.fileSize / 1024).toFixed(2);
        console.log(`${index + 1}. ç…§ç‰‡ ID: ${photo.id}`);
        console.log(`   å·¥å–® ID: ${photo.ticketId}`);
        console.log(`   åŸå§‹æª”å: ${photo.originalName}`);
        console.log(`   æª”æ¡ˆå¤§å°: ${fileSizeKB} KB`);
        console.log(`   MIME é¡å‹: ${photo.mimeType}`);
        console.log(`   æè¿°: ${photo.description || '(ç„¡)'}`);
        console.log(`   ä¸Šå‚³æ™‚é–“: ${photo.uploadedAt.toLocaleString('zh-TW')}`);
        console.log('');
      });
    } else {
      console.log('  (ç„¡è³‡æ–™)\n');
    }

    // 5. çµ±è¨ˆæ‘˜è¦
    console.log('ğŸ“Š è³‡æ–™çµ±è¨ˆæ‘˜è¦');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    const ticketCount = await prisma.ticket.count();
    const targetCount = await prisma.productionTarget.count();
    const scheduleCount = await prisma.ticketSchedule.count();
    const photoCount = await prisma.photo.count();

    console.log(`å·¥å–®ç¸½æ•¸: ${ticketCount}`);
    console.log(`ç”Ÿç”¢ç›®æ¨™ç¸½æ•¸: ${targetCount}`);
    console.log(`æ’ç¨‹ç¸½æ•¸: ${scheduleCount}`);
    console.log(`ç…§ç‰‡ç¸½æ•¸: ${photoCount}`);
    console.log('');

    // ç‹€æ…‹çµ±è¨ˆ
    const ticketStatusStats = await prisma.ticket.groupBy({
      by: ['status'],
      _count: true,
    });
    console.log('å·¥å–®ç‹€æ…‹åˆ†å¸ƒ:');
    ticketStatusStats.forEach(stat => {
      console.log(`  ${stat.status}: ${stat._count} ç­†`);
    });
    console.log('');

    const targetStatusStats = await prisma.productionTarget.groupBy({
      by: ['status'],
      _count: true,
    });
    console.log('ç›®æ¨™ç‹€æ…‹åˆ†å¸ƒ:');
    targetStatusStats.forEach(stat => {
      console.log(`  ${stat.status}: ${stat._count} ç­†`);
    });
    console.log('');

    const scheduleStatusStats = await prisma.ticketSchedule.groupBy({
      by: ['status'],
      _count: true,
    });
    console.log('æ’ç¨‹ç‹€æ…‹åˆ†å¸ƒ:');
    scheduleStatusStats.forEach(stat => {
      console.log(`  ${stat.status}: ${stat._count} ç­†`);
    });
    console.log('');

    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘          è³‡æ–™æª¢æŸ¥å®Œæˆ                                         â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  } catch (error) {
    console.error('âŒ æª¢æŸ¥è³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
  } finally {
    await prisma.$disconnect();
  }
}

checkDatabase();

```

è³‡æ–™åº«æª¢æŸ¥å®Œæˆã€‚ä»¥ä¸‹æ˜¯ç›®å‰è³‡æ–™åº«çš„å…§å®¹æ‘˜è¦ï¼š

## è³‡æ–™åº«å…§å®¹æ‘˜è¦

### ğŸ“‹ å·¥å–®è³‡æ–™ (Tickets)
- ç¸½æ•¸ï¼š9 ç­†
- ç‹€æ…‹ï¼šå…¨éƒ¨ç‚º OPEN
- æ¶µè“‹è¨­å‚™ï¼šAOIã€Collect & Discardã€Subã€Freezeã€Thawã€Sub & Freezeã€Chang Mediumã€TEST-001

### ğŸ¯ ç”Ÿç”¢ç›®æ¨™è³‡æ–™ (ProductionTargets)
- ç¸½æ•¸ï¼š5 ç­†
- ç›®æ¨™åç¨±ï¼š
  - DS6-8ï¼ˆé è¨ˆå®Œæˆï¼š2026-03-27ï¼‰
  - DS5ï¼ˆé è¨ˆå®Œæˆï¼š2026-02-28ï¼‰
  - DS3-6ï¼ˆé è¨ˆå®Œæˆï¼š2025-10-30ï¼‰
  - DS2-5ï¼ˆé è¨ˆå®Œæˆï¼š2025-10-28ï¼‰
  - DS1-2ï¼ˆé è¨ˆå®Œæˆï¼š2026-01-31ï¼‰
- ç‹€æ…‹ï¼šå…¨éƒ¨ç‚º IN_PROGRESS

### ğŸ“… å·¥å–®æ’ç¨‹è³‡æ–™ (TicketSchedules)
- ç¸½æ•¸ï¼š11 ç­†
- ç‹€æ…‹åˆ†å¸ƒï¼š
  - COMPLETEDï¼š4 ç­†
  - IN_PROGRESSï¼š1 ç­†
  - OPENï¼š6 ç­†
- æ’ç¨‹æ—¥æœŸç¯„åœï¼š2025-10-28 è‡³ 2025-12-01
- å„ªå…ˆç´šåˆ†å¸ƒï¼šHIGHã€MEDIUMã€LOW

### ğŸ“· ç…§ç‰‡è³‡æ–™ (Photos)
- ç¸½æ•¸ï¼š3 ç­†
- æª”æ¡ˆå¤§å°ï¼šç´„ 70 KB è‡³ 395 KB
- å…¨éƒ¨ç‚º JPEG æ ¼å¼

### é—œéµç™¼ç¾

1. æœ‰ 2 ç­†æ’ç¨‹è¨­å®šåœ¨ 2025-11-02ï¼ˆä»Šæ—¥æ’ç¨‹åŠŸèƒ½å¯ç”¨ï¼‰
2. éƒ¨åˆ†å·¥å–®å·²ä¸Šå‚³ç…§ç‰‡ï¼ˆ3 ç­†ï¼‰
3. è³‡æ–™é—œè¯æ­£å¸¸ï¼Œå·¥å–®èˆ‡ç›®æ¨™çš„æ’ç¨‹é—œä¿‚å»ºç«‹æ­£ç¢º
4. æ‰€æœ‰ç”Ÿç”¢ç›®æ¨™ç›®å‰ç‹€æ…‹ç‚º IN_PROGRESS

éœ€è¦æ›´è©³ç´°çš„æŸå€‹å€å¡Šè³‡è¨Šï¼Œæˆ–è¦åŸ·è¡Œç‰¹å®šçš„æŸ¥è©¢æˆ–æ“ä½œå—ï¼Ÿ

---

**User**

11/2æ–°å¢[ä»Šæ—¥æ’ç¨‹]åŠŸèƒ½ï¼Œè«‹æ›´æ–°ç¶²é ç‰ˆæœ¬è³‡è¨Š

---

**Cursor**


æŸ¥çœ‹ç‰ˆæœ¬è³‡è¨Šç›¸é—œæª”æ¡ˆï¼Œç¢ºèªç›®å‰çš„ç‰ˆæœ¬çµæ§‹ï¼š


æ›´æ–°ç‰ˆæœ¬è³‡è¨Šï¼Œåæ˜  11/2 æ–°å¢çš„ã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ã€‚è¨ˆç•«å¦‚ä¸‹ï¼š


---

**User**

Implement the plan as specified. To-do's from the plan have already been created, do not create them again.

---

**Cursor**


æ›´æ–°ç‰ˆæœ¬è³‡è¨Šï¼Œåæ˜  11/2 æ–°å¢çš„ã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ã€‚


```json
{
  "version": "1.3.0",
  "buildNumber": "20251102-001",
  "releaseDate": "2025-11-02",
  "changelog": [
    {
      "version": "1.3.0",
      "date": "2025-11-02",
      "changes": [
        "ğŸ“… æ–°å¢ä»Šæ—¥æ’ç¨‹åŠŸèƒ½",
        "ğŸ”„ å„ªåŒ–æ’ç¨‹æŸ¥è©¢èˆ‡é¡¯ç¤º",
        "ğŸ¯ æ”¯æ´æŒ‰æ—¥æœŸç¯©é¸æ’ç¨‹"
      ]
    },
    {
      "version": "1.2.0",
      "date": "2024-10-27",
      "changes": [
        "âœ¨ æ–°å¢å¤–éƒ¨è¨­å‚™è¨ªå•åŠŸèƒ½",
        "ğŸ”§ ä¿®æ­£Windowsç’°å¢ƒè®Šæ•¸å•é¡Œ",
        "ğŸ“± æ”¯æ´æ‰‹æ©Ÿ/å¹³æ¿è¨ªå•",
        "ğŸ¨ å„ªåŒ–æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ",
        "ğŸ–¼ï¸ å®Œå–„ç…§ç‰‡ç®¡ç†åŠŸèƒ½"
      ]
    },
    {
      "version": "1.1.0",
      "date": "2024-10-25",
      "changes": [
        "ğŸ¨ æ›´æ–°ç‚ºæ™ºæ…§é†«ç™‚è—ç™½é¢¨æ ¼",
        "ğŸ“¸ æ–°å¢å·¥å–®ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½",
        "ğŸ”— ç¨ç«‹ç…§ç‰‡ç®¡ç†é é¢",
        "ğŸ“‹ å®Œå–„å·¥å–®é¡å‹é¡¯ç¤º"
      ]
    },
    {
      "version": "1.0.0",
      "date": "2024-10-20",
      "changes": [
        "ğŸš€ åˆå§‹ç‰ˆæœ¬ç™¼å¸ƒ",
        "ğŸ“ åŸºæœ¬å·¥å–®ç®¡ç†åŠŸèƒ½",
        "ğŸ¯ é ç”Ÿç”¢ç›®æ¨™ç®¡ç†",
        "ğŸ“… å·¥å–®æ’ç¨‹åŠŸèƒ½"
      ]
    }
  ],
  "features": [
    "å·¥å–®ç®¡ç†ç³»çµ±",
    "é ç”Ÿç”¢ç›®æ¨™ç®¡ç†", 
    "å·¥å–®æ’ç¨‹åŠŸèƒ½",
    "ç…§ç‰‡ä¸Šå‚³ç®¡ç†",
    "å¤–éƒ¨è¨­å‚™è¨ªå•",
    "æ™ºæ…§é†«ç™‚ä¸»é¡Œ"
  ]
}

```

```json
{
  "version": "1.3.0",
  "buildNumber": "20251102-001",
  "releaseDate": "2025-11-02",
  "changelog": [
    {
      "version": "1.3.0",
      "date": "2025-11-02",
      "changes": [
        "ğŸ“… æ–°å¢ä»Šæ—¥æ’ç¨‹åŠŸèƒ½",
        "ğŸ”„ å„ªåŒ–æ’ç¨‹æŸ¥è©¢èˆ‡é¡¯ç¤º",
        "ğŸ¯ æ”¯æ´æŒ‰æ—¥æœŸç¯©é¸æ’ç¨‹"
      ]
    },
    {
      "version": "1.2.0",
      "date": "2024-10-27",
      "changes": [
        "âœ¨ æ–°å¢å¤–éƒ¨è¨­å‚™è¨ªå•åŠŸèƒ½",
        "ğŸ”§ ä¿®æ­£Windowsç’°å¢ƒè®Šæ•¸å•é¡Œ",
        "ğŸ“± æ”¯æ´æ‰‹æ©Ÿ/å¹³æ¿è¨ªå•",
        "ğŸ¨ å„ªåŒ–æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ",
        "ğŸ–¼ï¸ å®Œå–„ç…§ç‰‡ç®¡ç†åŠŸèƒ½"
      ]
    },
    {
      "version": "1.1.0",
      "date": "2024-10-25",
      "changes": [
        "ğŸ¨ æ›´æ–°ç‚ºæ™ºæ…§é†«ç™‚è—ç™½é¢¨æ ¼",
        "ğŸ“¸ æ–°å¢å·¥å–®ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½",
        "ğŸ”— ç¨ç«‹ç…§ç‰‡ç®¡ç†é é¢",
        "ğŸ“‹ å®Œå–„å·¥å–®é¡å‹é¡¯ç¤º"
      ]
    },
    {
      "version": "1.0.0",
      "date": "2024-10-20",
      "changes": [
        "ğŸš€ åˆå§‹ç‰ˆæœ¬ç™¼å¸ƒ",
        "ğŸ“ åŸºæœ¬å·¥å–®ç®¡ç†åŠŸèƒ½",
        "ğŸ¯ é ç”Ÿç”¢ç›®æ¨™ç®¡ç†",
        "ğŸ“… å·¥å–®æ’ç¨‹åŠŸèƒ½"
      ]
    }
  ],
  "features": [
    "å·¥å–®ç®¡ç†ç³»çµ±",
    "é ç”Ÿç”¢ç›®æ¨™ç®¡ç†", 
    "å·¥å–®æ’ç¨‹åŠŸèƒ½",
    "ä»Šæ—¥æ’ç¨‹åŠŸèƒ½",
    "ç…§ç‰‡ä¸Šå‚³ç®¡ç†",
    "å¤–éƒ¨è¨­å‚™è¨ªå•",
    "æ™ºæ…§é†«ç™‚ä¸»é¡Œ"
  ]
}

```

```json
{
  "version": "1.3.0",
  "buildNumber": "20251102-001",
  "releaseDate": "2025-11-02",
  "changelog": [
    {
      "version": "1.3.0",
      "date": "2025-11-02",
      "changes": [
        "ğŸ“… æ–°å¢ä»Šæ—¥æ’ç¨‹åŠŸèƒ½",
        "ğŸ”„ å„ªåŒ–æ’ç¨‹æŸ¥è©¢èˆ‡é¡¯ç¤º",
        "ğŸ¯ æ”¯æ´æŒ‰æ—¥æœŸç¯©é¸æ’ç¨‹"
      ]
    },
    {
      "version": "1.2.0",
      "date": "2024-10-27",
      "changes": [
        "âœ¨ æ–°å¢å¤–éƒ¨è¨­å‚™è¨ªå•åŠŸèƒ½",
        "ğŸ”§ ä¿®æ­£Windowsç’°å¢ƒè®Šæ•¸å•é¡Œ",
        "ğŸ“± æ”¯æ´æ‰‹æ©Ÿ/å¹³æ¿è¨ªå•",
        "ğŸ¨ å„ªåŒ–æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ",
        "ğŸ–¼ï¸ å®Œå–„ç…§ç‰‡ç®¡ç†åŠŸèƒ½"
      ]
    },
    {
      "version": "1.1.0",
      "date": "2024-10-25",
      "changes": [
        "ğŸ¨ æ›´æ–°ç‚ºæ™ºæ…§é†«ç™‚è—ç™½é¢¨æ ¼",
        "ğŸ“¸ æ–°å¢å·¥å–®ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½",
        "ğŸ”— ç¨ç«‹ç…§ç‰‡ç®¡ç†é é¢",
        "ğŸ“‹ å®Œå–„å·¥å–®é¡å‹é¡¯ç¤º"
      ]
    },
    {
      "version": "1.0.0",
      "date": "2024-10-20",
      "changes": [
        "ğŸš€ åˆå§‹ç‰ˆæœ¬ç™¼å¸ƒ",
        "ğŸ“ åŸºæœ¬å·¥å–®ç®¡ç†åŠŸèƒ½",
        "ğŸ¯ é ç”Ÿç”¢ç›®æ¨™ç®¡ç†",
        "ğŸ“… å·¥å–®æ’ç¨‹åŠŸèƒ½"
      ]
    }
  ],
  "features": [
    "å·¥å–®ç®¡ç†ç³»çµ±",
    "é ç”Ÿç”¢ç›®æ¨™ç®¡ç†", 
    "å·¥å–®æ’ç¨‹åŠŸèƒ½",
    "ç…§ç‰‡ä¸Šå‚³ç®¡ç†",
    "å¤–éƒ¨è¨­å‚™è¨ªå•",
    "æ™ºæ…§é†«ç™‚ä¸»é¡Œ"
  ]
}

```

```json
{
  "version": "1.3.0",
  "buildNumber": "20251102-001",
  "releaseDate": "2025-11-02",
  "changelog": [
    {
      "version": "1.3.0",
      "date": "2025-11-02",
      "changes": [
        "ğŸ“… æ–°å¢ä»Šæ—¥æ’ç¨‹åŠŸèƒ½",
        "ğŸ”„ å„ªåŒ–æ’ç¨‹æŸ¥è©¢èˆ‡é¡¯ç¤º",
        "ğŸ¯ æ”¯æ´æŒ‰æ—¥æœŸç¯©é¸æ’ç¨‹"
      ]
    },
    {
      "version": "1.2.0",
      "date": "2024-10-27",
      "changes": [
        "âœ¨ æ–°å¢å¤–éƒ¨è¨­å‚™è¨ªå•åŠŸèƒ½",
        "ğŸ”§ ä¿®æ­£Windowsç’°å¢ƒè®Šæ•¸å•é¡Œ",
        "ğŸ“± æ”¯æ´æ‰‹æ©Ÿ/å¹³æ¿è¨ªå•",
        "ğŸ¨ å„ªåŒ–æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ",
        "ğŸ–¼ï¸ å®Œå–„ç…§ç‰‡ç®¡ç†åŠŸèƒ½"
      ]
    },
    {
      "version": "1.1.0",
      "date": "2024-10-25",
      "changes": [
        "ğŸ¨ æ›´æ–°ç‚ºæ™ºæ…§é†«ç™‚è—ç™½é¢¨æ ¼",
        "ğŸ“¸ æ–°å¢å·¥å–®ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½",
        "ğŸ”— ç¨ç«‹ç…§ç‰‡ç®¡ç†é é¢",
        "ğŸ“‹ å®Œå–„å·¥å–®é¡å‹é¡¯ç¤º"
      ]
    },
    {
      "version": "1.0.0",
      "date": "2024-10-20",
      "changes": [
        "ğŸš€ åˆå§‹ç‰ˆæœ¬ç™¼å¸ƒ",
        "ğŸ“ åŸºæœ¬å·¥å–®ç®¡ç†åŠŸèƒ½",
        "ğŸ¯ é ç”Ÿç”¢ç›®æ¨™ç®¡ç†",
        "ğŸ“… å·¥å–®æ’ç¨‹åŠŸèƒ½"
      ]
    }
  ],
  "features": [
    "å·¥å–®ç®¡ç†ç³»çµ±",
    "é ç”Ÿç”¢ç›®æ¨™ç®¡ç†", 
    "å·¥å–®æ’ç¨‹åŠŸèƒ½",
    "ä»Šæ—¥æ’ç¨‹åŠŸèƒ½",
    "ç…§ç‰‡ä¸Šå‚³ç®¡ç†",
    "å¤–éƒ¨è¨­å‚™è¨ªå•",
    "æ™ºæ…§é†«ç™‚ä¸»é¡Œ"
  ]
}

```

```typescript
import axios from 'axios';
import { ApiResponse } from '../types/ticket';

// å‹•æ…‹ç²å– API URLï¼ˆæ”¯æ´å¤–éƒ¨è¨ªå•ï¼‰
const getApiBaseUrl = (): string => {
  // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸
  if (process.env.REACT_APP_API_URL) {
    return process.env.REACT_APP_API_URL;
  }

  // å¦‚æœç•¶å‰è¨ªå•åœ°å€ä¸æ˜¯ localhostï¼Œè‡ªå‹•æ§‹å»º API URL
  const currentHost = typeof window !== 'undefined' ? window.location.hostname : 'localhost';
  
  if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
    // æœ¬æ©Ÿè¨ªå•ï¼Œä½¿ç”¨ localhost
    return 'http://localhost:5000/api';
  } else {
    // å¤–éƒ¨è¨ªå•ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰ï¼Œæ§‹å»ºå°æ‡‰çš„ API URL
    return `http://${currentHost}:5000/api`;
  }
};

const API_BASE_URL = getApiBaseUrl();

// ç‰ˆæœ¬è³‡è¨Šä»‹é¢
export interface VersionInfo {
  version: string;
  buildNumber: string;
  releaseDate: string;
  changelog: ChangelogEntry[];
  features: string[];
}

export interface ChangelogEntry {
  version: string;
  date: string;
  changes: string[];
}

export interface VersionCheckResult {
  hasUpdate: boolean;
  currentVersion: string;
  clientVersion: string;
  latestChangelog: ChangelogEntry;
  updateAvailable: boolean;
}

/**
 * ç‰ˆæœ¬æœå‹™é¡
 * æä¾›ç‰ˆæœ¬è³‡è¨Šã€æ›´æ–°æ—¥èªŒå’Œæ›´æ–°æª¢æŸ¥åŠŸèƒ½
 */
class VersionService {
  /**
   * ç²å–ç•¶å‰ç‰ˆæœ¬è³‡è¨Š
   * @returns Promise<ApiResponse<VersionInfo>>
   */
  async getVersionInfo(): Promise<ApiResponse<VersionInfo>> {
    try {
      const response = await axios.get(`${API_BASE_URL}/version`);
      return response.data;
    } catch (error: any) {
      console.error('ç²å–ç‰ˆæœ¬è³‡è¨ŠéŒ¯èª¤:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'ç²å–ç‰ˆæœ¬è³‡è¨Šå¤±æ•—',
        data: undefined
      };
    }
  }

  /**
   * ç²å–æ›´æ–°æ—¥èªŒ
   * @returns Promise<ApiResponse<{changelog: ChangelogEntry[], currentVersion: string, buildNumber: string}>>
   */
  async getChangelog(): Promise<ApiResponse<{changelog: ChangelogEntry[], currentVersion: string, buildNumber: string}>> {
    try {
      const response = await axios.get(`${API_BASE_URL}/version/changelog`);
      return response.data;
    } catch (error: any) {
      console.error('ç²å–æ›´æ–°æ—¥èªŒéŒ¯èª¤:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'ç²å–æ›´æ–°æ—¥èªŒå¤±æ•—',
        data: undefined
      };
    }
  }

  /**
   * æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°
   * @param clientVersion å®¢æˆ¶ç«¯ç‰ˆæœ¬
   * @returns Promise<ApiResponse<VersionCheckResult>>
   */
  async checkForUpdates(clientVersion: string): Promise<ApiResponse<VersionCheckResult>> {
    try {
      const response = await axios.get(`${API_BASE_URL}/version/check`, {
        params: { version: clientVersion }
      });
      return response.data;
    } catch (error: any) {
      console.error('æª¢æŸ¥æ›´æ–°éŒ¯èª¤:', error);
      return {
        success: false,
        message: error.response?.data?.message || 'æª¢æŸ¥æ›´æ–°å¤±æ•—',
        data: undefined
      };
    }
  }

  /**
   * ç²å–æœ¬åœ°ç‰ˆæœ¬è³‡è¨Šï¼ˆå¾package.jsonï¼‰
   * @returns VersionInfo
   */
  getLocalVersionInfo(): VersionInfo {
    return {
      version: '1.3.0',
      buildNumber: '20251102-001',
      releaseDate: '2025-11-02',
      changelog: [
        {
          version: '1.3.0',
          date: '2025-11-02',
          changes: [
            'ğŸ“… æ–°å¢ä»Šæ—¥æ’ç¨‹åŠŸèƒ½',
            'ğŸ”„ å„ªåŒ–æ’ç¨‹æŸ¥è©¢èˆ‡é¡¯ç¤º',
            'ğŸ¯ æ”¯æ´æŒ‰æ—¥æœŸç¯©é¸æ’ç¨‹'
          ]
        },
        {
          version: '1.2.0',
          date: '2024-10-27',
          changes: [
            'âœ¨ æ–°å¢å¤–éƒ¨è¨­å‚™è¨ªå•åŠŸèƒ½',
            'ğŸ”§ ä¿®æ­£Windowsç’°å¢ƒè®Šæ•¸å•é¡Œ',
            'ğŸ“± æ”¯æ´æ‰‹æ©Ÿ/å¹³æ¿è¨ªå•',
            'ğŸ¨ å„ªåŒ–æ™ºæ…§é†«ç™‚è—ç™½ä¸»é¡Œ',
            'ğŸ–¼ï¸ å®Œå–„ç…§ç‰‡ç®¡ç†åŠŸèƒ½'
          ]
        }
      ],
      features: [
        'å·¥å–®ç®¡ç†ç³»çµ±',
        'é ç”Ÿç”¢ç›®æ¨™ç®¡ç†', 
        'å·¥å–®æ’ç¨‹åŠŸèƒ½',
        'ä»Šæ—¥æ’ç¨‹åŠŸèƒ½',
        'ç…§ç‰‡ä¸Šå‚³ç®¡ç†',
        'å¤–éƒ¨è¨­å‚™è¨ªå•',
        'æ™ºæ…§é†«ç™‚ä¸»é¡Œ'
      ]
    };
  }
}

export default new VersionService();

```

å·²æ›´æ–°ç‰ˆæœ¬è³‡è¨Šï¼Œåæ˜  11/2 æ–°å¢çš„ã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ã€‚

## å·²å®Œæˆçš„æ›´æ–°

1. **version.json** (æ ¹ç›®éŒ„)
   - ç‰ˆæœ¬è™Ÿï¼š1.2.0 â†’ 1.3.0
   - å»ºç½®ç·¨è™Ÿï¼š20241027-001 â†’ 20251102-001
   - ç™¼å¸ƒæ—¥æœŸï¼š2024-10-27 â†’ 2025-11-02
   - æ–°å¢ç‰ˆæœ¬ 1.3.0 çš„æ›´æ–°æ—¥èªŒ
   - åœ¨åŠŸèƒ½åˆ—è¡¨ä¸­æ–°å¢ã€Œä»Šæ—¥æ’ç¨‹åŠŸèƒ½ã€

2. **server/version.json**
   - ç›¸åŒçš„æ›´æ–°å…§å®¹

3. **client/src/services/versionApi.ts**
   - æ›´æ–° `getLocalVersionInfo()` æ–¹æ³•ä¸­çš„ç‰ˆæœ¬è³‡è¨Š
   - åŒ…å«ç‰ˆæœ¬è™Ÿã€å»ºç½®ç·¨è™Ÿã€ç™¼å¸ƒæ—¥æœŸã€æ›´æ–°æ—¥èªŒå’ŒåŠŸèƒ½åˆ—è¡¨

## ç‰ˆæœ¬ 1.3.0 æ›´æ–°å…§å®¹

- æ–°å¢ä»Šæ—¥æ’ç¨‹åŠŸèƒ½
- å„ªåŒ–æ’ç¨‹æŸ¥è©¢èˆ‡é¡¯ç¤º
- æ”¯æ´æŒ‰æ—¥æœŸç¯©é¸æ’ç¨‹

ç‰ˆæœ¬è³‡è¨Šå·²åœ¨ä¸‰å€‹æª”æ¡ˆä¸­åŒæ­¥æ›´æ–°ã€‚ç•¶ä½¿ç”¨è€…é»æ“Šã€Œç‰ˆæœ¬è³‡è¨Šã€æŒ‰éˆ•æ™‚ï¼Œæœƒçœ‹åˆ°æ–°çš„ç‰ˆæœ¬ 1.3.0 å’Œç›¸é—œæ›´æ–°å…§å®¹ã€‚

---

**User**

Implement the plan as specified. To-do's from the plan have already been created, do not create them again.

---

**Cursor**


å·²å®Œæˆæ‰€æœ‰æ›´æ–°ã€‚æ›´æ–°å¾…è¾¦æ¸…å–®ï¼Œæ¨™è¨˜ç‚ºå·²å®Œæˆï¼š


æ‰€æœ‰ä»»å‹™å·²å®Œæˆã€‚

## å®Œæˆç‹€æ…‹ç¸½çµ

æ‰€æœ‰ç‰ˆæœ¬è³‡è¨Šæ›´æ–°å·²å®Œæˆï¼š

1. **version.json** (æ ¹ç›®éŒ„) â€” å·²æ›´æ–°
   - ç‰ˆæœ¬è™Ÿï¼š1.3.0
   - å»ºç½®ç·¨è™Ÿï¼š20251102-001
   - ç™¼å¸ƒæ—¥æœŸï¼š2025-11-02
   - æ–°å¢æ›´æ–°æ—¥èªŒå’ŒåŠŸèƒ½åˆ—è¡¨

2. **server/version.json** â€” å·²æ›´æ–°
   - èˆ‡æ ¹ç›®éŒ„ç‰ˆæœ¬åŒæ­¥

3. **client/src/services/versionApi.ts** â€” å·²æ›´æ–°
   - `getLocalVersionInfo()` æ–¹æ³•å·²æ›´æ–°ç‚ºæœ€æ–°ç‰ˆæœ¬è³‡è¨Š

ç•¶ä½¿ç”¨è€…é–‹å•Ÿã€Œç‰ˆæœ¬è³‡è¨Šã€å°è©±æ¡†æ™‚ï¼Œæœƒçœ‹åˆ°ï¼š
- ç‰ˆæœ¬ï¼š1.3.0
- å»ºç½®ç·¨è™Ÿï¼š20251102-001
- ç™¼å¸ƒæ—¥æœŸï¼š2025-11-02
- æ›´æ–°æ—¥èªŒåŒ…å«ã€Œä»Šæ—¥æ’ç¨‹åŠŸèƒ½ã€çš„èªªæ˜
- åŠŸèƒ½åˆ—è¡¨åŒ…å«ã€Œä»Šæ—¥æ’ç¨‹åŠŸèƒ½ã€

æ‰€æœ‰æª”æ¡ˆå·²åŒæ­¥ï¼Œç‰ˆæœ¬è³‡è¨Šå·²åæ˜  11/2 æ–°å¢çš„ã€Œä»Šæ—¥æ’ç¨‹ã€åŠŸèƒ½ã€‚

